<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on karl</title><link>https://karlquinsland.com/posts/</link><description>Recent content in Posts on karl</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Sun, 05 Sep 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://karlquinsland.com/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Adding an APC UPS to Home Assistant energy dashboard</title><link>https://karlquinsland.com/2021/09/adding-an-apc-ups-to-home-assistant-energy-dashboard/</link><pubDate>Sun, 05 Sep 2021 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2021/09/adding-an-apc-ups-to-home-assistant-energy-dashboard/</guid><description>&lt;p>&lt;strong>EDIT:&lt;/strong> (2021-09-19): After some &lt;a href="https://old.reddit.com/r/homeassistant/comments/pi3pv2/how_to_use_an_apc_ups_as_an_energy_dashboard/hbqudh5/">back and forth&lt;/a> with &lt;a href="https://old.reddit.com/user/Laxarus">/u/Laxarus&lt;/a>, there is now a simpler method! The &lt;code>snmp&lt;/code> platform still does not support setting &lt;code>device_class&lt;/code>, but wrapping the sensor in another template sensor is not required; just do so in your &lt;a href="https://www.home-assistant.io/docs/configuration/customizing-devices/">&lt;code>customize.yaml&lt;/code>&lt;/a>. I have called this out &lt;a href="#edit-2021-09-19">below&lt;/a>.&lt;/p>
&lt;hr>
&lt;p>This is another quick &amp;ldquo;here&amp;rsquo;s how I did it, hope this help&amp;rdquo; post.&lt;/p>
&lt;p>In preparation for the inevitable grid brownouts that summer 2021 would bring, I installed a rather beefy UPS for my home network / lab. After some browsing, I discovered a local eWaste liquidator with a really good deal on some second-hand APC UPSs.&lt;/p>
&lt;p>A few hundred dollars and about 150 lbs later, the UPS was installed in the server rack. Despite being a newer generation, the software on the UPS has a &lt;em>&lt;strong>TON&lt;/strong>&lt;/em> of similarities to the &lt;a href="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/">older style of PDU that I installed in my lab &lt;/a> a while back. This made it relatively straightforward to use the same
pattern to start getting UPS metrics into Grafana as well.&lt;/p>
&lt;p>After getting the basic monitoring up and running, I started to draft this post to serve as an &amp;lsquo;update&amp;rsquo; to the APC9700 post. Life got in the way and the post sat in the drafts branch where it was completely forgotten about&amp;hellip;. until &lt;a href="https://www.home-assistant.io/blog/2021/08/04/release-20218/">Home Assistant released their new Energy dashboard&lt;/a>. Now that HA could show the energy consumption of individual devices right next to the cumulative consumption and production data, the post was worth finishing and expanding on.&lt;/p>
&lt;p>The configuration that I was &lt;em>going&lt;/em> to publish is &lt;a href="#current-and-voltage-independently">below&lt;/a> but after finding &lt;a href="https://old.reddit.com/r/homeassistant/comments/pi3pv2/how_to_use_an_apc_ups_as_an_energy_dashboard/hbpqzr6/">this&lt;/a> comment by &lt;a href="https://old.reddit.com/user/Laxarus">Laxarus&lt;/a> on &lt;a href="https://old.reddit.com/user/Navydevildoc">Navydevildoc&lt;/a>&amp;rsquo;s &lt;a href="https://old.reddit.com/r/homeassistant/comments/pi3pv2/how_to_use_an_apc_ups_as_an_energy_dashboard/">reddit post&lt;/a>, I&amp;rsquo;ve got a revised and simpler configuration to share!&lt;/p>
&lt;h2 id="long-term-statistics-in-home-assistant">Long Term Statistics in Home Assistant&lt;/h2>
&lt;p>Before diving into the configuration, a little bit of context. In preparation for the energy sub system, the Home Assistant developers have been working on a &amp;lsquo;&lt;a href="https://developers.home-assistant.io/docs/core/entity/sensor/#long-term-statistics">long term statistics&lt;/a>&amp;rsquo; (LTS) framework. The LTS framework is meant to give HA some improved speed and capabilities when dealing with a lot of data! The energy subsystem is the first &amp;lsquo;consumer&amp;rsquo; of the LTS framework.&lt;/p>
&lt;p>Home Assistant will look for two &amp;lsquo;properties&amp;rsquo; on a given sensor to determine if that sensor will work with the LTS framework.
For a sensor/entity to &amp;lsquo;work&amp;rsquo; with the long term stats system it must:&lt;/p>
&lt;ul>
&lt;li>have a property called &lt;code>device_class&lt;/code> with a value of &lt;code>energy&lt;/code>, &lt;code>gas&lt;/code>, or &lt;code>monetary&lt;/code>&lt;/li>
&lt;li>have a property called &lt;code>state_class&lt;/code> with a value of either &lt;code>measurement&lt;/code> or &lt;code>total_increasing&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>In testing, I was &lt;em>not&lt;/em> able to get a sensor with &lt;code>state_class: measurement&lt;/code> and &lt;code>device_class: energy&lt;/code> to &amp;lsquo;work&amp;rsquo; with the energy sub system. Fortunately, this does not apply with the concise configuration &lt;a href="#a-single-oid-for-power-consumption">below&lt;/a>!&lt;/p>
&lt;p>As the LTS framework is still new, many platforms - including the SNMP platform - do not support the required properties:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">Invalid config for [sensor.snmp]: [state_class] is an invalid option for [sensor.snmp]. Check: sensor.snmp-&amp;gt;state_class.
Invalid config for [sensor.snmp]: [device_class] is an invalid option for [sensor.snmp]. Check: sensor.snmp-&amp;gt;device_class.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>template&lt;/code> platform &lt;em>has&lt;/em> been updated to work with the &lt;code>device_class&lt;/code> or &lt;code>state_class&lt;/code> properties though.
So that&amp;rsquo;s the technique to use here; a &lt;code>template&lt;/code> sensor with the correct &lt;code>{device,state}_class&lt;/code> properties set will wrap the snmp sensor.&lt;/p>
&lt;p>Hopefully a future release of HA will include &lt;code>{device,state}_class&lt;/code> support for the &lt;code>snmp&lt;/code> platform; the &lt;code>template&lt;/code> sensors in the configuration snips below won&amp;rsquo;t be needed!&lt;/p>
&lt;h4 id="edit-2021-09-19">EDIT (2021-09-19):&lt;/h4>
&lt;p>You don&amp;rsquo;t need to wrap the snmp sensor in a template sensor. As of home assistant 2021.09, the &lt;code>snmp&lt;/code> platform does not allow you to set &lt;code>device_class: energy&lt;/code>&amp;hellip; however, you &lt;em>can&lt;/em> set the &lt;code>device_class&lt;/code> attribute on the snmp sensor through &lt;code>customize.yaml&lt;/code>:&lt;/p>
&lt;p>Make sure your configuration file loads the customization file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ cat configuration.yaml | grep customize
customize: !include customize.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>If your snmp sensor was called &lt;code>sensor.usp_energy&lt;/code>, then you would add an object called &lt;code>sensor.ups_energy&lt;/code> like so:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ cat customize.yaml | grep -a2 ups
sensor.ups_energy:
state_class: total_increasing
device_class: energy
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="configure-home-assistant">Configure Home Assistant&lt;/h2>
&lt;p>I have broken my &lt;code>configuration.yaml&lt;/code> up to make things easier to manage. Almost all entity/device/template/sensor..etc configuration is done through files placed in the &lt;code>devices/**/*&lt;/code> directory:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">❯ cat configuration.yaml | grep -E &lt;span style="font-style:italic">&amp;#39;devices/sensor|template/&amp;#39;&lt;/span>
sensor: !include_dir_merge_list devices/sensor/
template: !include_dir_merge_list devices/template/
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="a-single-oid-for-power-consumption">A single OID for power consumption&lt;/h3>
&lt;p>Thanks again to &lt;a href="https://old.reddit.com/user/Laxarus">Laxarus&lt;/a> for the &lt;a href="https://old.reddit.com/r/homeassistant/comments/pi3pv2/how_to_use_an_apc_ups_as_an_energy_dashboard/hbpqzr6/">tip&lt;/a> about the &lt;code>upsHighPrecOutputEnergyUsage&lt;/code> OID!&lt;/p>
&lt;p>First, create the &amp;lsquo;raw&amp;rsquo; sensor using the &lt;code>snmp&lt;/code> platform:&lt;/p>
&lt;p>&lt;code>devices/sensor/snmp.yaml&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">- &lt;span style="font-weight:bold">platform&lt;/span>: snmp
&lt;span style="font-weight:bold">name&lt;/span>: &lt;span style="font-style:italic">&amp;#34;UPS Energy (raw)&amp;#34;&lt;/span>
&lt;span style="font-weight:bold">host&lt;/span>: 192.168.1.1
&lt;span style="font-style:italic"># The current in tenths of amperes drawn by the load on the UPS.&lt;/span>
&lt;span style="font-style:italic"># Contained in Module(s): PowerNet-MIB&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">baseoid&lt;/span>: .1.3.6.1.4.1.318.1.1.1.4.3.6.0
&lt;span style="font-style:italic"># Determines whether the sensor should start and keep working even if the SNMP host is unreachable or not responding.&lt;/span>
&lt;span style="font-style:italic"># This allows the sensor to be initialized properly even if, for example, your printer is not on when you start Home Assistant.&lt;/span>
&lt;span style="font-weight:bold">accept_errors&lt;/span>: &lt;span style="font-weight:bold">true&lt;/span>
&lt;span style="font-style:italic"># UPS reports in tens of kWh so we&amp;#39;ll need to divide by 10 to get kWh; HA only accepts kWh or Wh for sensors&lt;/span>
&lt;span style="font-style:italic"># that will &amp;#39;work&amp;#39; on the energy dashboard&lt;/span>
&lt;span style="font-weight:bold">unit_of_measurement&lt;/span>: kWh
&lt;span style="font-weight:bold">value_template&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{{ ((value | int) / 10) | float}}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then, wrap the &lt;code>snmp&lt;/code> sensor with the necessary properties:&lt;/p>
&lt;p>&lt;code>devices/template/ups_energy.yaml&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">- &lt;span style="font-weight:bold">sensor&lt;/span>:
- &lt;span style="font-weight:bold">name&lt;/span>: &lt;span style="font-style:italic">&amp;#34;UPS Energy&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># Unique ID is required for mgmt through the web UI&lt;/span>
&lt;span style="font-weight:bold">unique_id&lt;/span>: tmpl-ups-energy
&lt;span style="font-weight:bold">icon&lt;/span>: mdi:lightning-bolt
&lt;span style="font-style:italic"># Required for Energy dashboard&lt;/span>
&lt;span style="font-weight:bold">state_class&lt;/span>: total_increasing
&lt;span style="font-weight:bold">device_class&lt;/span>: energy
&lt;span style="font-weight:bold">unit_of_measurement&lt;/span>: kWh
&lt;span style="font-weight:bold">state&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{{ (states(&amp;#39;sensor.ups_energy_raw&amp;#39;) | float) }}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Restart Home Assistant and you should now be able to add &lt;code>sensor.ups_energy&lt;/code> to the list of individual devices on your Energy Dashboard :D.&lt;/p>
&lt;h3 id="current-and-voltage-independently">Current and Voltage independently&lt;/h3>
&lt;p>After sorting through the &lt;em>massive&lt;/em> MIB file that APC publishes; I only found ways to measure the voltage and current via SNMP. I assumed that APC meant for you to calculate the power use on your own from the voltage and current.&lt;/p>
&lt;p>As it turns out, APC has a &lt;code>upsHighPrecOutputEnergyUsage&lt;/code> field which reports: &lt;code>The output energy usage of the UPS in hundredths of kWh.&lt;/code> If your APC device publishes a value on the OID &lt;code>.1.3.6.1.4.1.318.1.1.1.4.3.6.0&lt;/code> then you can skip the configuration below; use the more concise configuration &lt;a href="#a-single-oid-for-power-consumption">above&lt;/a>. If your devices &lt;em>&lt;strong>does not&lt;/strong>&lt;/em> publish the cumulative energy consumption, it can still be calculated manually.&lt;/p>
&lt;p>The manual approach below is a lot like the concise approach above; uses two &lt;code>snmp&lt;/code> sensors to collect the voltage and current from the UPS and then wrap everything in a LTS-compatible &lt;code>template&lt;/code> sensor to get the data to show up on the energy dashboard.&lt;/p>
&lt;p>&lt;code>devices/sensor/snmp.yaml&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-style:italic"># Unfortunately, there is no direct &amp;#39;watt&amp;#39; field. We need to calculate this on our own&lt;/span>
&lt;span style="font-style:italic"># P = IV so if we can get the current and voltage, we can figure out the power&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
- &lt;span style="font-weight:bold">platform&lt;/span>: snmp
&lt;span style="font-weight:bold">name&lt;/span>: &lt;span style="font-style:italic">&amp;#34;UPS Output Current&amp;#34;&lt;/span>
&lt;span style="font-weight:bold">host&lt;/span>: 192.168.1.1
&lt;span style="font-style:italic"># The current in tenths of amperes drawn by the load on the UPS.&lt;/span>
&lt;span style="font-style:italic"># Contained in Module(s): PowerNet-MIB&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">baseoid&lt;/span>: .1.3.6.1.4.1.318.1.1.1.4.3.4.0
&lt;span style="font-style:italic"># Determines whether the sensor should start and keep working even if the SNMP host is unreachable or not responding.&lt;/span>
&lt;span style="font-style:italic"># This allows the sensor to be initialized properly even if, for example, your printer is not on when you start Home Assistant.&lt;/span>
&lt;span style="font-weight:bold">accept_errors&lt;/span>: &lt;span style="font-weight:bold">true&lt;/span>
&lt;span style="font-style:italic"># For reasons that I don&amp;#39;t understand... HA does not like it when i specify &amp;#39;device_class&amp;#39; :/&lt;/span>
&lt;span style="font-style:italic">#device_class: current&lt;/span>
&lt;span style="font-weight:bold">unit_of_measurement&lt;/span>: &lt;span style="font-style:italic">&amp;#34;A&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># Because the number is in 10ths of amps, we need to shift the decimal by 1 place&lt;/span>
&lt;span style="font-style:italic"># 43 becomes 4.3&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">value_template&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{{((value | int) / 10) | float}}&amp;#34;&lt;/span>
- &lt;span style="font-weight:bold">platform&lt;/span>: snmp
&lt;span style="font-weight:bold">name&lt;/span>: &lt;span style="font-style:italic">&amp;#34;UPS Output Voltage&amp;#34;&lt;/span>
&lt;span style="font-weight:bold">host&lt;/span>: 192.168.1.1
&lt;span style="font-style:italic">#The output voltage of the UPS system in tenths of VAC.&lt;/span>
&lt;span style="font-style:italic"># Contained in Module(s): PowerNet-MIB&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">baseoid&lt;/span>: .1.3.6.1.4.1.318.1.1.1.4.3.1.0
&lt;span style="font-style:italic"># Determines whether the sensor should start and keep working even if the SNMP host is unreachable or not responding.&lt;/span>
&lt;span style="font-style:italic"># This allows the sensor to be initialized properly even if, for example, your printer is not on when you start Home Assistant.&lt;/span>
&lt;span style="font-weight:bold">accept_errors&lt;/span>: &lt;span style="font-weight:bold">true&lt;/span>
&lt;span style="font-weight:bold">unit_of_measurement&lt;/span>: &lt;span style="font-style:italic">&amp;#34;V&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># Because the number is in 10ths of volts, we need to shift the decimal by 1 place&lt;/span>
&lt;span style="font-style:italic"># 1211 becomes 121.1&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">value_template&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{{((value | int) / 10) | float}}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>devices/template/ups_energy.yaml&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-style:italic"># The docs around the long term stats support for a sensor are not super clear and seem to be a bit contradictory.&lt;/span>
&lt;span style="font-style:italic"># Both the power and current sensors are &amp;#39;point in time&amp;#39; sensors and DO NOT represent an &amp;#39;always increasing&amp;#39; value.&lt;/span>
&lt;span style="font-style:italic"># The docs seem to imply that HA will do the integration for you if the sensor has `state_class` set to `measurement` or&lt;/span>
&lt;span style="font-style:italic"># `total_increasing`. But elsewhere in the docs, you have this:&lt;/span>
&lt;span style="font-style:italic"># Home Assistant tracks the min, max and mean value during the statistics period.&lt;/span>
&lt;span style="font-style:italic"># The state_class property must be set to measurement, and the device_class must not be either of `energy`, `gas`, or `monetary`.&lt;/span>
&lt;span style="font-style:italic">#&lt;/span>
&lt;span style="font-style:italic"># In testing, I was only able to get sensors that had `total_increasing` and `energy` set to show up / work with the energy dashboard. It looks like a `measurement` sensor _could_ be used... but only if the `last_reset` property can be set to 0... and currently this can&amp;#39;t be done via YAML.&lt;/span>
&lt;span style="font-style:italic">#&lt;/span>
&lt;span style="font-style:italic"># So we lie about the sensor and tell HA that it&amp;#39;s a `total_increasing` sensor and we just hope that the value never drops more than 10% which appears to be the signal to HA that the meter has been reset :/&lt;/span>
&lt;span style="font-style:italic">#&lt;/span>
&lt;span style="font-style:italic"># https://developers.home-assistant.io/docs/core/entity/sensor/#long-term-statistics&lt;/span>
&lt;span style="font-style:italic"># https://www.home-assistant.io/integrations/sensor/&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
- &lt;span style="font-weight:bold">sensor&lt;/span>:
- &lt;span style="font-weight:bold">name&lt;/span>: &lt;span style="font-style:italic">&amp;#34;UPS Power&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># Unique ID is required for mgmt through the web UI&lt;/span>
&lt;span style="font-weight:bold">unique_id&lt;/span>: tmpl-UPS-power-use
&lt;span style="font-weight:bold">icon&lt;/span>: mdi:lightning-bolt
&lt;span style="font-style:italic"># This sensor records the instantaneous power load on the UPS... it is a measurement at that point in time&lt;/span>
&lt;span style="font-weight:bold">state_class&lt;/span>: measurement
&lt;span style="font-weight:bold">device_class&lt;/span>: power
&lt;span style="font-weight:bold">unit_of_measurement&lt;/span>: W
&lt;span style="font-weight:bold">state&lt;/span>: &amp;gt;&lt;span style="font-style:italic">
&lt;/span>&lt;span style="font-style:italic"> {% set current = states(&amp;#39;sensor.UPS_output_current&amp;#39;) | float %}
&lt;/span>&lt;span style="font-style:italic"> {% set voltage = states(&amp;#39;sensor.UPS_output_voltage&amp;#39;) | float %}
&lt;/span>&lt;span style="font-style:italic"> {{ (current * voltage) | round (2) }}&lt;/span>
- &lt;span style="font-weight:bold">sensor&lt;/span>:
- &lt;span style="font-weight:bold">name&lt;/span>: &lt;span style="font-style:italic">&amp;#34;UPS Energy&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># Unique ID is required for mgmt through the web UI&lt;/span>
&lt;span style="font-weight:bold">unique_id&lt;/span>: tmpl-UPS-energy
&lt;span style="font-weight:bold">icon&lt;/span>: mdi:lightning-bolt
&lt;span style="font-style:italic"># Lie to HA about the type of sensor so we get values in the dashboard.&lt;/span>
&lt;span style="font-weight:bold">state_class&lt;/span>: total_increasing
&lt;span style="font-weight:bold">device_class&lt;/span>: energy
&lt;span style="font-style:italic"># Since we are pretending to integrate over time, we are in Wh now.&lt;/span>
&lt;span style="font-style:italic"># Good thing, too... because the energy dashboard WILL NOT use any sensor that does not report in kWh or Wh&lt;/span>
&lt;span style="font-weight:bold">unit_of_measurement&lt;/span>: Wh
&lt;span style="font-weight:bold">state&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{{ (states(&amp;#39;sensor.UPS_power&amp;#39;) | float) }}&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># or, for kWh&lt;/span>
&lt;span style="font-style:italic">#state: &amp;#34;{{ (states(&amp;#39;sensor.UPS_power&amp;#39;) | float)/1000 }}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Fixing Home Assistant discovery with Tasmota on the Treatlife DS03</title><link>https://karlquinsland.com/2021/05/fixing-home-assistant-discovery-with-tasmota-on-the-treatlife-ds03/</link><pubDate>Wed, 12 May 2021 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2021/05/fixing-home-assistant-discovery-with-tasmota-on-the-treatlife-ds03/</guid><description>&lt;p>&lt;strong>UPDATE:&lt;/strong> (2021-09-19): Multiple have gotten in touch with me seeking some support with this post. At present, there is a &lt;a href="https://github.com/arendst/Tasmota/issues/12684#event-5035253885">bug&lt;/a> with the Tasmota 9.5.0 release which breaks the automation outlined below. If you are having trouble getting the steps below to work &lt;strong>&lt;em>either use Tasmota 9.4 or the latest development release of tasmota 9.5 if you&amp;rsquo;re going to continue on with this post!&lt;/em>&lt;/strong>&lt;/p>
&lt;hr>
&lt;p>The Treatlife DS03 is one of only a few Tasmota compatible ceiling fan controllers available in the US. It&amp;rsquo;s internal architecture splits the task of dimming the lights and switching the fan speed electronics from communicating over the network.&lt;/p>
&lt;p>A very resource constrained ESP8266 module handles the network comms while a dedicated microcontroller running it&amp;rsquo;s own software manages the user-facing buttons/indicator-lights as well as dimming the light and adjusting the fan speed. The two components communicate over a simple UART.&lt;/p>
&lt;p>This is a totally reasonable way to build such a device, but for reasons that I don&amp;rsquo;t fully understand, Tasmota does not publish a completely functional &lt;a href="https://www.home-assistant.io/docs/mqtt/discovery/">auto-configuration&lt;/a> payload for Home Assistant.&lt;/p>
&lt;p>Home Assistant automatically discovers the full light/dimmer capabilities of the DS03, but for some reason does not see that the DS03 is capable of running a fan at 4 different speeds; Home Assistant only allows for turning the fan on/off.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/05/fixing-home-assistant-discovery-with-tasmota-on-the-treatlife-ds03/images/ha_default.jpg" alt="Screenshot showing DS03 device entity with the default binary switch control for the ceiling fan." />
&lt;figcaption>
&lt;p>
The default auto-configuration leads Home Assistant to believe the fan can only be switched on/off.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>The &lt;a href="https://templates.blakadder.com/treatlife_DS03.html">existing&lt;/a> guides on &lt;a href="https://www.digiblur.com/2020/07/the-tasmota-fan-controller-ive-been.html">how to flash the device&lt;/a> with Tasmota and integrate it with Home Assistant all work around this limitation by &lt;em>&lt;em>manually&lt;/em>&lt;/em> configuring Home Assistant to see the device as a multi-speed fan 🤦.&lt;/p>
&lt;p>I&amp;rsquo;m not a huge fan of doing things manually, especially when there&amp;rsquo;s a well documented and robust protocol designed to make manual configuration unnecessary! Why ignore the almost completely working auto-configuration in favor of manual configuration? Why not just fix the auto-config payload so Home Assistant exposes the full functionality of the device?&lt;/p>
&lt;p>Both of the above guides were written long before &lt;a href="https://www.home-assistant.io/blog/2021/03/03/release-20213/#fan-speeds-100">Home Assistant gained support&lt;/a> for fans with more than 3 speeds so even if I were to configure Home Assistant with a copy their example YAML, I&amp;rsquo;d &lt;em>still&lt;/em> be missing the ability to control the 4th speed!&lt;/p>
&lt;h2 id="how">How&lt;/h2>
&lt;p>In short, Tasmota supports some basic scripting, called &lt;a href="https://tasmota.github.io/docs/Rules/">rules&lt;/a>. They work exactly as you&amp;rsquo;re thinking: On &lt;code>$someEvent&lt;/code> do &lt;a href="https://tasmota.github.io/docs/Commands/">&lt;code>$someAction&lt;/code>&lt;/a>. One of the actions allows the Tasmota device to publish a message to a MQTT topic. I&amp;rsquo;m going to have the DS03 broadcast a &lt;em>proper&lt;/em> auto-configuration message to Home Assistant.&lt;/p>
&lt;p>The technique is basically the same one outlined in &lt;a href="https://blakadder.com/pir-in-tasmota-integration/">this&lt;/a> article, but I&amp;rsquo;m posting this to document a few of the subtle differences in my approach.&lt;/p>
&lt;p>I&amp;rsquo;ll assume that you&amp;rsquo;ve successfully flashed your DS03 with Tasmota and have already configured the module and issued the necessary &lt;code>ledtable&lt;/code> commands. You will also need the native &lt;a href="https://www.home-assistant.io/integrations/tasmota/">Tasmota&lt;/a> integration installed.&lt;/p>
&lt;p>If you&amp;rsquo;re following either the blakadder or digiblur guides linked above, stop at the step where you&amp;rsquo;re meant to configure &lt;code>rule1&lt;/code>.&lt;/p>
&lt;p>Issue a slightly modified rule:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">Rule1 on TuyaReceived#Data=55AA03070005030400010016 do publish2 stat/%topic%/speed 25 endon
on TuyaReceived#Data=55AA03070005030400010117 do publish2 stat/%topic%/speed 50 endon
on TuyaReceived#Data=55AA03070005030400010218 do publish2 stat/%topic%/speed 75 endon
on TuyaReceived#Data=55AA03070005030400010319 do publish2 stat/%topic%/speed 100 endon
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This tells Tasmota to publish an integer speed (25,50,75,100) when it receives a specific packet from the dedicated MCU over th UART.&lt;/p>
&lt;p>Then, issue a second rule to actually publish the configuration data:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">rule2 on SetOption19#Data=OFF do publish2 homeassistant/fan/%macaddr%/config {&amp;#34;uniq_id&amp;#34;:&amp;#34;AABBCC&amp;#34;,&amp;#34;~&amp;#34;:&amp;#34;%topic%/POWER1&amp;#34;,&amp;#34;cmd_t&amp;#34;:&amp;#34;cmnd/~&amp;#34;,&amp;#34;pl_off&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;pl_on&amp;#34;:&amp;#34;ON&amp;#34;,&amp;#34;stat_t&amp;#34;:&amp;#34;stat/~&amp;#34;,&amp;#34;avty_t&amp;#34;:&amp;#34;tele/%topic%/LWT&amp;#34;,&amp;#34;pl_avail&amp;#34;:&amp;#34;Online&amp;#34;,&amp;#34;pl_not_avail&amp;#34;:&amp;#34;Offline&amp;#34;,&amp;#34;pct_cmd_t&amp;#34;:&amp;#34;cmnd/%topic%/tuyasend4&amp;#34;,&amp;#34;pct_cmd_tpl&amp;#34;:&amp;#34;{%set v=value|int%}{%if v&amp;lt;=25%}3,0{%elif v&amp;lt;=50%}3,1{%elif v&amp;lt;=75%}3,2{%elif v&amp;lt;=100%}3,3{%endif%}&amp;#34;,&amp;#34;pct_stat_t&amp;#34;:&amp;#34;stat/%topic%/speed&amp;#34;,&amp;#34;dev&amp;#34;:{&amp;#34;cns&amp;#34;:[[&amp;#34;mac&amp;#34;,&amp;#34;%macaddr%&amp;#34;]]}} endon
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Note:&lt;/strong> You&amp;rsquo;ll probably want to modify the above payload so the occurrences of the placeholder string &lt;code>AABBCC&lt;/code> are replaced with the last 6 characters of your own device&amp;rsquo;s MAC address!&lt;/p>
&lt;p>For readability, here&amp;rsquo;s the unminified JSON:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">{
&lt;span style="font-weight:bold">&amp;#34;uniq_id&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;AABBCC&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;~&amp;#34;&lt;/span>:&lt;span style="font-style:italic">&amp;#34;%topic%/POWER1&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;cmd_t&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;cmnd/~&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;pl_off&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;OFF&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;pl_on&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;ON&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;stat_t&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;stat/~&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;avty_t&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tele/%topic%/LWT&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;pl_avail&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Online&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;pl_not_avail&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Offline&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;pct_cmd_t&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;cmnd/%topic%/tuyasend4&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;pct_cmd_tpl&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{%set v=value|int%}{%if v&amp;lt;=25%}3,0{%elif v&amp;lt;=50%}3,1{%elif v&amp;lt;=75%}3,2{%elif v&amp;lt;=100%}3,3{%endif%}&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;pct_stat_t&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;stat/%topic%/speed&amp;#34;&lt;/span>,
&lt;span style="font-weight:bold">&amp;#34;dev&amp;#34;&lt;/span>: {
&lt;span style="font-weight:bold">&amp;#34;cns&amp;#34;&lt;/span>: [
[
&lt;span style="font-style:italic">&amp;#34;mac&amp;#34;&lt;/span>,
&lt;span style="font-style:italic">&amp;#34;%macaddr%&amp;#34;&lt;/span>
]
]
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Note:&lt;/strong> The &lt;code>dev&lt;/code> portion of the payload is the &lt;a href="https://www.home-assistant.io/integrations/fan.mqtt/#device">magic that convinces Home Assistant to combine the multiple entities under once device&lt;/a>. Without that portion of the document, you will still have a properly configured DS03, but it will exist as an &amp;lsquo;orphaned&amp;rsquo; entity that belongs to no device!&lt;/p>
&lt;p>All that&amp;rsquo;s left is to enable &lt;code>rule2&lt;/code> and then trigger it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">rule2 1
so19 0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Altogether, It&amp;rsquo;ll look something like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">18:23:54.140 CMD: Rule1 on TuyaReceived#Data=55AA03070005030400010016 do publish2 stat/%topic%/speed 25 endon on TuyaReceived#Data=55AA03070005030400010117 do publish2 stat/%topic%/speed 50 endon on TuyaReceived#Data=55AA03070005030400010218 do publish2 stat/%topic%/speed 75 endon on TuyaReceived#Data=55AA03070005030400010319 do publish2 stat/%topic%/speed 100 endon
18:23:54.149 RUL: Stored uncompressed, would compress from 344 to 98 (-72%)
18:23:54.155 MQT: stat/living_room_ceiling_fan/RESULT = {&amp;#34;Rule1&amp;#34;:{&amp;#34;State&amp;#34;:&amp;#34;ON&amp;#34;,&amp;#34;Once&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;StopOnError&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;Length&amp;#34;:344,&amp;#34;Free&amp;#34;:167,&amp;#34;Rules&amp;#34;:&amp;#34;on TuyaReceived#Data=55AA03070005030400010016 do publish2 stat/%topic%/speed 25 endon on TuyaReceived#Data=55AA03070005030400010117 do publish2 stat/%topic%/speed 50 endon on TuyaReceived#Data=55AA03070005030400010218 do publish2 stat/%topic%/speed 75 endon on TuyaReceived#Data=55AA03070005030400010319 do publish2 stat/%topic%/speed 100 endon&amp;#34;}}
18:24:05.061 CMD: rule2 on SetOption19#Data=OFF do publish2 homeassistant/fan/%macaddr%/config {&amp;#34;uniq_id&amp;#34;:&amp;#34;AABBCC&amp;#34;,&amp;#34;~&amp;#34;:&amp;#34;%topic%/POWER1&amp;#34;,&amp;#34;cmd_t&amp;#34;:&amp;#34;cmnd/~&amp;#34;,&amp;#34;pl_off&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;pl_on&amp;#34;:&amp;#34;ON&amp;#34;,&amp;#34;stat_t&amp;#34;:&amp;#34;stat/~&amp;#34;,&amp;#34;avty_t&amp;#34;:&amp;#34;tele/%topic%/LWT&amp;#34;,&amp;#34;pl_avail&amp;#34;:&amp;#34;Online&amp;#34;,&amp;#34;pl_not_avail&amp;#34;:&amp;#34;Offline&amp;#34;,&amp;#34;pct_cmd_t&amp;#34;:&amp;#34;cmnd/%topic%/tuyasend4&amp;#34;,&amp;#34;pct_cmd_tpl&amp;#34;:&amp;#34;{%set v=value|int%}{%if v&amp;lt;=25%}3,0{%elif v&amp;lt;=50%}3,1{%elif v&amp;lt;=75%}3,2{%elif v&amp;lt;=100%}3,3{%endif%}&amp;#34;,&amp;#34;pct_stat_t&amp;#34;:&amp;#34;stat/%topic%/speed&amp;#34;,&amp;#34;dev&amp;#34;:{&amp;#34;cns&amp;#34;:[[&amp;#34;mac&amp;#34;,&amp;#34;%macaddr%&amp;#34;]]}} endon
18:24:05.093 RUL: Stored uncompressed, would compress from 473 to 351 (-26%)
18:24:05.100 MQT: stat/living_room_ceiling_fan/RESULT = {&amp;#34;Rule2&amp;#34;:{&amp;#34;State&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;Once&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;StopOnError&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;Length&amp;#34;:473,&amp;#34;Free&amp;#34;:38,&amp;#34;Rules&amp;#34;:&amp;#34;on SetOption19#Data=OFF do publish2 homeassistant/fan/%macaddr%/config {\&amp;#34;uniq_id\&amp;#34;:\&amp;#34;AABBCC\&amp;#34;,\&amp;#34;~\&amp;#34;:\&amp;#34;%topic%/POWER1\&amp;#34;,\&amp;#34;cmd_t\&amp;#34;:\&amp;#34;cmnd/~\&amp;#34;,\&amp;#34;pl_off\&amp;#34;:\&amp;#34;OFF\&amp;#34;,\&amp;#34;pl_on\&amp;#34;:\&amp;#34;ON\&amp;#34;,\&amp;#34;stat_t\&amp;#34;:\&amp;#34;stat/~\&amp;#34;,\&amp;#34;avty_t\&amp;#34;:\&amp;#34;tele/%topic%/LWT\&amp;#34;,\&amp;#34;pl_avail\&amp;#34;:\&amp;#34;Online\&amp;#34;,\&amp;#34;pl_not_avail\&amp;#34;:\&amp;#34;Offline\&amp;#34;,\&amp;#34;pct_cmd_t\&amp;#34;:\&amp;#34;cmnd/%topic%/tuyasend4\&amp;#34;,\&amp;#34;pct_cmd_tpl\&amp;#34;:\&amp;#34;{%set v=value|int%}{%if v&amp;lt;=25%}3,0{%elif v&amp;lt;=50%}3,1{%elif v&amp;lt;=75%}3,2{%elif v&amp;lt;=100%}3,3{%endif%}\&amp;#34;,\&amp;#34;pct_stat_t\&amp;#34;:\&amp;#34;stat/%topic%/speed\&amp;#34;,\&amp;#34;dev\&amp;#34;:{\&amp;#34;cns\&amp;#34;:[[\&amp;#34;mac\&amp;#34;,\&amp;#34;%macaddr%\&amp;#34;]]}} endon&amp;#34;}}
18:24:07.494 CMD: rule2 1
18:24:07.503 MQT: stat/living_room_ceiling_fan/RESULT = {&amp;#34;Rule2&amp;#34;:{&amp;#34;State&amp;#34;:&amp;#34;ON&amp;#34;,&amp;#34;Once&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;StopOnError&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;Length&amp;#34;:473,&amp;#34;Free&amp;#34;:38,&amp;#34;Rules&amp;#34;:&amp;#34;on SetOption19#Data=OFF do publish2 homeassistant/fan/%macaddr%/config {\&amp;#34;uniq_id\&amp;#34;:\&amp;#34;AABBCC\&amp;#34;,\&amp;#34;~\&amp;#34;:\&amp;#34;%topic%/POWER1\&amp;#34;,\&amp;#34;cmd_t\&amp;#34;:\&amp;#34;cmnd/~\&amp;#34;,\&amp;#34;pl_off\&amp;#34;:\&amp;#34;OFF\&amp;#34;,\&amp;#34;pl_on\&amp;#34;:\&amp;#34;ON\&amp;#34;,\&amp;#34;stat_t\&amp;#34;:\&amp;#34;stat/~\&amp;#34;,\&amp;#34;avty_t\&amp;#34;:\&amp;#34;tele/%topic%/LWT\&amp;#34;,\&amp;#34;pl_avail\&amp;#34;:\&amp;#34;Online\&amp;#34;,\&amp;#34;pl_not_avail\&amp;#34;:\&amp;#34;Offline\&amp;#34;,\&amp;#34;pct_cmd_t\&amp;#34;:\&amp;#34;cmnd/%topic%/tuyasend4\&amp;#34;,\&amp;#34;pct_cmd_tpl\&amp;#34;:\&amp;#34;{%set v=value|int%}{%if v&amp;lt;=25%}3,0{%elif v&amp;lt;=50%}3,1{%elif v&amp;lt;=75%}3,2{%elif v&amp;lt;=100%}3,3{%endif%}\&amp;#34;,\&amp;#34;pct_stat_t\&amp;#34;:\&amp;#34;stat/%topic%/speed\&amp;#34;,\&amp;#34;dev\&amp;#34;:{\&amp;#34;cns\&amp;#34;:[[\&amp;#34;mac\&amp;#34;,\&amp;#34;%macaddr%\&amp;#34;]]}} endon&amp;#34;}}
18:24:10.362 CMD: so19 0
18:24:10.369 MQT: stat/living_room_ceiling_fan/RESULT = {&amp;#34;SetOption19&amp;#34;:&amp;#34;OFF&amp;#34;}
18:24:10.414 RUL: SETOPTION19#DATA=OFF performs &amp;#34;publish2 homeassistant/fan/DDEEFFAABBCC/config {&amp;#34;uniq_id&amp;#34;:&amp;#34;AABBCC&amp;#34;,&amp;#34;~&amp;#34;:&amp;#34;living_room_ceiling_...
18:24:10.421 MQT: home Assistant/fan/DDEEFFAABBCC/config = {&amp;#34;uniq_id&amp;#34;:&amp;#34;AABBCC&amp;#34;,&amp;#34;~&amp;#34;:&amp;#34;living_room_ceiling_fan/POWER1&amp;#34;,&amp;#34;cmd_t&amp;#34;:&amp;#34;cmnd/~&amp;#34;,&amp;#34;pl_off&amp;#34;:&amp;#34;OFF&amp;#34;,&amp;#34;pl_on&amp;#34;:&amp;#34;ON&amp;#34;,&amp;#34;stat_t&amp;#34;:&amp;#34;stat/~&amp;#34;,&amp;#34;avty_t&amp;#34;:&amp;#34;tele/living_room_ceiling_fan/LWT&amp;#34;,&amp;#34;pl_avail&amp;#34;:&amp;#34;Online&amp;#34;,&amp;#34;pl_not_avail&amp;#34;:&amp;#34;Offline&amp;#34;,&amp;#34;pct_cmd_t&amp;#34;:&amp;#34;cmnd/living_room_ceiling_fan/tuyasend4&amp;#34;,&amp;#34;pct_cmd_tpl&amp;#34;:&amp;#34;{%set v=value|int%}{%if v&amp;lt;=25%}3,0{%elif v&amp;lt;=50%}3,1{%elif v&amp;lt;=75%}3,2{%elif v&amp;lt;=100%}3,3{%endif%}&amp;#34;,&amp;#34;pct_stat_t&amp;#34;:&amp;#34;stat/living_room_ceiling_fan/speed&amp;#34;,&amp;#34;dev&amp;#34;:{&amp;#34;cns&amp;#34;:[[&amp;#34;mac&amp;#34;,&amp;#34;DDEEFFAABBCC&amp;#34;]]}} (retained)
18:24:10.509 LOG: Home Assistant MQTT Discovery disabled.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>If everything worked correctly, Home Assistant should now show a single device in the &lt;a href="https://developers.home-assistant.io/docs/device_registry_index/">device registry&lt;/a> with a dimmable light entity and a variable-speed fan entity!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/05/fixing-home-assistant-discovery-with-tasmota-on-the-treatlife-ds03/images/ha_mqtt_fan.jpg" alt="Screenshot showing DS03 device entity in Home Assistant with the multi-speed MQTT fan." />
&lt;figcaption>
&lt;p>
The DS03 device entity after the variable speed configuration document is received by Home Assistant.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>&lt;strong>Note:&lt;/strong> Depending on weather or not Home Assistant has previously &amp;lsquo;seen&amp;rsquo; your DS03 via the native native &lt;a href="https://www.home-assistant.io/integrations/tasmota/">Tasmota&lt;/a> integration, you may see &lt;em>three&lt;/em> entities on the device page; the light/dimmer, the switch/fan and the variable speed fan. Just disable the &amp;lsquo;basic&amp;rsquo; fan switch entity that Tasmota publishes as discussed below.&lt;/p>
&lt;h4 id="updating-a-ds03-thats-already-integrated-with-home-assistant">Updating a DS03 that&amp;rsquo;s already integrated with Home Assistant&lt;/h4>
&lt;p>If you&amp;rsquo;ve already got a DS03 that&amp;rsquo;s integrated with Home Assistant, you can still get the device to properly auto-configure. Just remove the YAML configuration for both the light and fan entities.&lt;/p>
&lt;p>You will likely need to restart HA to make sure all traces of the manual configurations are removed from the &lt;a href="https://developers.home-assistant.io/docs/entity_registry_index/">entity registry&lt;/a>.&lt;/p>
&lt;p>Once Home Assistant has forgotten all about the manual entities and the native &lt;a href="https://www.home-assistant.io/integrations/tasmota/">Tasmota&lt;/a> integration in installed, all of the MQTT-connected Tasmota devices &lt;em>should&lt;/em> get picked up and configured in Home Assistant. At this point, you should have the single device with two entities; dimmable light and binary-switch fan as shown in the first picture on this post.&lt;/p>
&lt;p>If your DS03 was already configured with Home Assistant via the Tasmota integration, just disable the simple switch entity that Tasmota configures Home Assistant with:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/05/fixing-home-assistant-discovery-with-tasmota-on-the-treatlife-ds03/images/ha_disable_default_entity.jpg" alt="Screenshot showing Home Assistant UX for disabling the default binary switch entity" />
&lt;figcaption>
&lt;p>
Toggle &amp;#39;Enable entity&amp;#39; off to hide the basic binary switch that Tasmota configured Home Assistant with.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>After disabling the switch/fan entity, trigger &lt;code>rule2&lt;/code> again and refresh the device entity page in Home Assistant to confirm that the device now has a &lt;code>MQTT Fan&lt;/code> entity if it wasn&amp;rsquo;t there already.&lt;/p>
&lt;p>Enjoy :)&lt;/p>
&lt;h4 id="why-use-setoption19off-as-the-trigger">Why use &lt;code>SetOption19:OFF&lt;/code> as the trigger?&lt;/h4>
&lt;p>I run my MQTT broker on Kubernetes and do not have any persistance configured for that pod. This means that regardless of what retention settings a message was published with, every message on every topic is wiped out whenever the MQTT broker pod is rescheduled. As a result almost every device that Home Assistant monitors or controls via MQTT drifts into an &lt;code>Unavailable&lt;/code> state whenever I do any maintenance on my K8s cluster.&lt;/p>
&lt;p>I&amp;rsquo;m not the &lt;a href="https://community.home-assistant.io/t/tasmota-going-offline-at-random-times/116299">only one&lt;/a> with &lt;a href="https://community.home-assistant.io/t/sonoff-tasmota-started-regularly-showing-unavailable-on-home-assistant/90157/83">this issue&lt;/a>, even if the cause is different.&lt;/p>
&lt;p>To get around this, I have a small automation that pokes the Tasmota devices every hour and when Home Assistant starts up. Since the Home Assistant pod takes longer than the MQTT pod to initialize, having HA poke the devices on startup minimizes the time a given entity is &lt;code>Unavailable&lt;/code> in HA.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-weight:bold">alias&lt;/span>: Tasmotas Announce
&lt;span style="font-weight:bold">description&lt;/span>: &lt;span style="font-style:italic">&amp;#39;Prevents devices from going Unavailable&amp;#39;&lt;/span>
&lt;span style="font-weight:bold">trigger&lt;/span>:
- &lt;span style="font-weight:bold">platform&lt;/span>: home Assistant
&lt;span style="font-weight:bold">event&lt;/span>: start
- &lt;span style="font-weight:bold">platform&lt;/span>: time_pattern
&lt;span style="font-weight:bold">hours&lt;/span>: /1
&lt;span style="font-weight:bold">condition&lt;/span>: []
&lt;span style="font-weight:bold">action&lt;/span>:
&lt;span style="font-style:italic"># For reasons that I don&amp;#39;t understand, different tasmota devices seem to &lt;/span>
&lt;span style="font-style:italic"># subscribe to a different group topic. cmnd/tas vs tas/cmnd&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
- &lt;span style="font-weight:bold">service&lt;/span>: mqtt.publish
&lt;span style="font-weight:bold">data&lt;/span>:
&lt;span style="font-weight:bold">topic&lt;/span>: cmnd/tasmotas/SetOption19
&lt;span style="font-weight:bold">payload&lt;/span>: &lt;span style="font-style:italic">&amp;#39;0&amp;#39;&lt;/span>
- &lt;span style="font-weight:bold">service&lt;/span>: mqtt.publish
&lt;span style="font-weight:bold">data&lt;/span>:
&lt;span style="font-weight:bold">topic&lt;/span>: tasmotas/cmnd/SetOption19
&lt;span style="font-weight:bold">payload&lt;/span>: &lt;span style="font-style:italic">&amp;#39;0&amp;#39;&lt;/span>
&lt;span style="font-weight:bold">mode&lt;/span>: single
&lt;/code>&lt;/pre>&lt;/div>&lt;p>You could probably work around this whole thing by changing the trigger for &lt;code>rule2&lt;/code> to something like &lt;code>on Mqtt#Connected publish2&lt;/code>. Or storing the configuration payload as a &lt;a href="https://tasmota.github.io/docs/Rules/#rule-variables">variable&lt;/a> so you could write multiple triggers for the same &lt;code>publish2 %mem1%&lt;/code> action 🤔.&lt;/p>
&lt;h3 id="side-note-rules-crash">Side note: Rules Crash!&lt;/h3>
&lt;p>While developing the configuration payload, I was able to reliably crash the ESP8266 module causing Tasmota to reboot. The crash / reboot symptoms are pretty similar to those outlined &lt;a href="https://tasmota.github.io/docs/Troubleshooting/#running-out-of-ram">here&lt;/a> so I assume that even though the rules &amp;ldquo;fit&amp;rdquo;, something about how the rule was parsed or the actions the rule drove caused the ESP to run out of RAM.&lt;/p>
&lt;p>When I say &amp;ldquo;fit&amp;rdquo; I mean that I&amp;rsquo;d see lines like this in the console after configuring a test payload for &lt;code>rule2&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">MQT: stat/living_room_ceiling_fan/RESULT = {&amp;#34;Rule2&amp;#34;:{&amp;#34;State&amp;#34;:&amp;#34;ON&amp;#34;,...&amp;#34;Free&amp;#34;:9,&amp;#34;Rules&amp;#34;:&amp;#34;on ... endon&amp;#34;}}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I could technically make the rule &lt;code>9&lt;/code> characters longer and it&amp;rsquo;d still fit&amp;hellip; right?&lt;/p>
&lt;p>Not quite. Looking at the result from issuing the &lt;code>Rule1&lt;/code> command, it was clear that while &lt;code>rule2&lt;/code> would have an absolute maximum length of 511 characters (&lt;code>&amp;quot;Length&amp;quot;:344,&amp;quot;Free&amp;quot;:167&lt;/code>; 344+167=511) there was also a less well defined soft limit on rule length.&lt;/p>
&lt;p>For some versions of my &lt;code>rule2&lt;/code> payload, I was able to solve the crashing just by switching to the &amp;lsquo;lite&amp;rsquo; version of Tasmota. While the &amp;lsquo;lite&amp;rsquo; version of Tasmota does work with Tuya MCU (&lt;code>USE_TUYA_MCU&lt;/code>), it &lt;a href="https://github.com/arendst/Tasmota/blob/v9.4.0/BUILDS.md">does &lt;em>not&lt;/em> support&lt;/a> Home Assistant configuration (&lt;code>USE_HOME_ASSISTANT&lt;/code>)!&lt;/p>
&lt;p>After flashing back to the &amp;lsquo;regular&amp;rsquo; Tasmota build, I set out trying to compress the &lt;code>rule2&lt;/code> payload as much as possible so that it would still work &lt;em>and&lt;/em> not reliably crash the ESP8266 on the DS03.&lt;/p>
&lt;p>After testing several things, I managed to get a working &lt;code>rule2&lt;/code> that didn&amp;rsquo;t reliably crash when triggered.&lt;/p></description></item><item><title>PoE powered Stack Light</title><link>https://karlquinsland.com/2021/02/poe-powered-stack-light/</link><pubDate>Sun, 28 Feb 2021 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2021/02/poe-powered-stack-light/</guid><description>&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/02_all_on.jpg" alt="Picture showing assembled light attached to enclosure from the front. All 5 lights are lit." />
&lt;figcaption>
&lt;p>
The lights are much brighter than they appear in this picture; had to intentionally darken the image to prevent camera from blowing out the colors.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Stack_light">Stack/signal lights&lt;/a> are &lt;em>everywhere&lt;/em> in industrial applications for good reason: they&amp;rsquo;re a compact and relatively information-dense indicator system. They always seemed like the kind of indicator that only people with expensive machines needed. Until I found that they can be had for just under $6/light from Ali Express, that is.&lt;/p>
&lt;p>I don&amp;rsquo;t have any giant industrial machines to attach one to, but I do have a non-trivial number of containers/servers/networked-devices running and they all emit various notifications, usually through email. Who wouldn&amp;rsquo;t mind a novel way to move those notifications beyond email/push notifications into the physical world 🤔?&lt;/p>
&lt;ul>
&lt;li>🟢 =&amp;gt; Everything is nominal&lt;/li>
&lt;li>🟠 =&amp;gt; Check your email; a &lt;code>WARN&lt;/code> level event has occurred&lt;/li>
&lt;li>🔴 =&amp;gt; A &lt;code>WARN&lt;/code> or &lt;code>ERROR&lt;/code> level condition has occurred; something (ISP down?) is preventing delivery of notifications so check the logs/dashboards directly&lt;/li>
&lt;li>🔵 =&amp;gt; A new &lt;code>INFO&lt;/code> level message available in Home Assistant&lt;/li>
&lt;li>⚪ =&amp;gt; Not sure; either a &amp;ldquo;A HIGH priority task is past due&amp;rdquo; or a &amp;lsquo;modifier&amp;rsquo; for above status&lt;/li>
&lt;/ul>
&lt;p>While waiting for the light to arrive from China, I started to design something to drive it.
It was immediately obvious that an ESP32 module would be &lt;strong>ideal&lt;/strong> to run the show, and just for the fun of it, I decided to make the entire thing (optionally) controlled and powered over Ethernet.&lt;/p>
&lt;h2 id="home-assistant">Home Assistant&lt;/h2>
&lt;p>It wouldn&amp;rsquo;t be an ESP32 powered project w/o the the &lt;em>fantastic&lt;/em> &lt;a href="https://esphome.io/">ESPHome&lt;/a> framework! With ESPHome comes trivial Home Assistant integration; each individual light / channel on the stack light is automatically configured via MQTT a a light:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/home-assistant.png" alt="Screenshot showing the stack light automatically configured in Home Assistant." />
&lt;figcaption>
&lt;p>
Stack light is controlled via MQTT making it easy to control from Home Assistant or any other program that can speak MQTT.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>A slightly modified version of the ESPHome config that I use to build the firmware for the light is attached at the end of this post.&lt;/p>
&lt;p>Unfortunately, the one Home Assistant integration that I had in mind is currently not feasible!
I wanted to light the blue light when there is any new/unread Home Assistant &lt;a href="https://www.home-assistant.io/integrations/persistent_notification/">persistent notifications&lt;/a>;
a real life &amp;ldquo;unread&amp;rdquo; badge of sorts.&lt;/p>
&lt;p>There is no way to get the list / count of active notifications unless you&amp;rsquo;re a &lt;a href="https://github.com/home-assistant/core/blob/41b45c7f78f9937520b38126cedf228da7507d7d/homeassistant/components/persistent_notification/__init__.py#L203">websocket client&lt;/a>, however.&lt;/p>
&lt;p>Using the &lt;a href="https://github.com/home-assistant/core/blob/41b45c7f78f9937520b38126cedf228da7507d7d/homeassistant/components/persistent_notification/__init__.py#L30">&lt;code>persistent_notifications_updated&lt;/code>&lt;/a> event as a trigger won&amp;rsquo;t work because the event payload lacks useful data; I can&amp;rsquo;t figure out the number of notifications or their state&amp;hellip; just that either notification has been created or dismissed.
If I wanted the blue light on any time a notification was either created or destroyed, I could use this trigger. But the light is no longer a useful indicator; it would be on the first time a notification was created or destroyed and then it would never be off.&lt;/p>
&lt;p>Manually trying to &lt;a href="https://community.home-assistant.io/t/dismiss-of-a-persistent-notification-as-trigger-for-automations/135621/5">keep track of the number of notification created/dismissed actions&lt;/a> just feels like a hacky workaround that could easily get out of sync, too.&lt;/p>
&lt;p>Oh well 😔.&lt;/p>
&lt;h2 id="bom">BOM&lt;/h2>
&lt;p>I&amp;rsquo;ll cover the individual 3D printed and electronic components below. Beyond them, you&amp;rsquo;ll need some additional hardware:&lt;/p>
&lt;ul>
&lt;li>4x &lt;a href="https://www.mcmaster.com/catalog/91290A113">m3x8mm&lt;/a> screws&lt;/li>
&lt;li>4x &lt;a href="https://www.mcmaster.com/catalog/91274A115">m4x8mm&lt;/a> screws&lt;/li>
&lt;li>4x &lt;a href="https://www.mcmaster.com/catalog/91274A117">m4x10mm&lt;/a> screws&lt;/li>
&lt;li>6x &lt;a href="https://www.kjmagnetics.com/proddetail.asp?prod=BC41">Neodymium magnets&lt;/a> sized 20mm x 6mm x 2mm. These are optional and are leftover magnets from this &lt;a href="https://www.google.com/search?client=firefox-b-1-d&amp;amp;q=prusa+mk3+enclosure+2">build&lt;/a>&lt;/li>
&lt;li>10mm diameter &lt;a href="https://www.amazon.com/s?k=10mm+cabinet+door+pad">anti-slip pads&lt;/a>. Thees are optional but will keep the base from sliding around.&lt;/li>
&lt;/ul>
&lt;p>I&amp;rsquo;ve linked to the screws that I used, but any similar ones should work. Strong glue could also work, but is not recommended.&lt;/p>
&lt;p>The m3 screws are for attaching the PCB to the printed part (in yellow, below)
The shorter m4 screws are for attaching the base (yellow) to the lid (dark blue) and the longer screws are for attaching the stack light to the lid.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/01_prep.jpg" alt="Picture showing some of the components and tools used in assembly." />
&lt;figcaption>
&lt;p>
About to start melting threads into the 3D printed parts.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h4 id="stack-light">Stack light&lt;/h4>
&lt;p>Looking quickly through Ali Express, it seems that the lights come in a few different styles, but all appear to be modular in construction.
Regardless of lamp style, they all appear to come in 2-5 lamp variants and some have configuration switches that allow for customizing the behavior per lamp.&lt;/p>
&lt;p>The ESPHome code and PCB are designed to accommodate up to 6 colors but will work with less.&lt;/p>
&lt;p>No matter which style and colors you select, make sure you get one with a &lt;strong>positive &lt;a href="https://en.wikipedia.org/wiki/Anode">anode&lt;/a>&lt;/strong> rated for &lt;strong>12V DC&lt;/strong>.&lt;/p>
&lt;p>The exact lamp that I used is &lt;a href="https://www.aliexpress.com/item/1005001391165850.html">here&lt;/a>.&lt;/p>
&lt;h4 id="esp32-module">ESP32 Module&lt;/h4>
&lt;p>I chose to use the &lt;a href="https://www.aliexpress.com/item/1005001739834076.html">WirelessTag WT32-eth01&lt;/a> module for the onboard Ethernet circuitry at a relatively cheap price: about $10/module. Bonus: it&amp;rsquo;s got a breadboard friendly footprint &lt;em>and&lt;/em> castellated pads!&lt;/p>
&lt;p>You do not need to use Ethernet for control &lt;em>or&lt;/em> power; the ESPHome configuration below can be easily modified to use the WiFi.&lt;/p>
&lt;p>In any case, you will need a dedicated UART programmer for the module as there is no built-in USB port on the WT32-eth01.&lt;/p>
&lt;h4 id="pcb">PCB&lt;/h4>
&lt;p>Nothing much to see here; just a simple board to consolidate connections for what would otherwise be a mess of wires.&lt;/p>
&lt;p>Since I was already using Ethernet for the data, may as well use it for the power, too.
Designing my own PoE circuitry was not in scope for this project, so I went with another off-the-shelf &lt;a href="https://www.aliexpress.com/item/32620368747.html">module&lt;/a>. I ordered the &lt;code>12V2A-Full 24W&lt;/code> version, but the others are likely to also have an identical internal PCB layout which should fit in the 3D printed parts. Make sure to get one that supplies the 12V that the stack light will need!&lt;/p>
&lt;p>The PCB does not care &lt;em>where&lt;/em> the 12V DC supply comes from.
It wouldn&amp;rsquo;t be difficult to modify the enclosure to accommodate a &lt;a href="https://www.aliexpress.com/item/1005001668143510.html">USB-C Power Delivery module&lt;/a> or even just a standard barrel jack / LED power supply.&lt;/p>
&lt;p>Like the PoE module, I use an off the shelf DC to DC converter &lt;a href="https://www.aliexpress.com/item/32833398811.html">module&lt;/a> to step the 12V down from the PoE dongle to 5V which the ESP32 module requires. That link is to a whole-sale lot of 10 converters. You can order the same module in quantities of one from similar listings. I buy them in bulk because it&amp;rsquo;s more expensive to design and solder my own on each board that I build&amp;hellip;&lt;/p>
&lt;p>My testing isn&amp;rsquo;t super through, but I see the total power draw (measured from the PoE supplying equipment) reaching about 4.5W when all lights are on and about 2W at at idle.&lt;/p>
&lt;p>The ESP32 just drives some &lt;a href="https://lcsc.com/product-detail/MOSFET_Diodes-Incorporated-DMN1019USN-7_C145103.html">N-Channel MOSFETS&lt;/a> to switch the individual lights on/off.
They&amp;rsquo;re the only surface mount (SOT-23-4) component; everything else can be done with through hole components. The board is designed for up to 6 colors/lights, but populate only as many MOSFETS as you need.&lt;/p>
&lt;p>All of the screw terminals are optional; I had several spares left over from a different project, but soldering wires directly to the PCB would work as well.&lt;/p>
&lt;p>The 6 pin screw terminal is LCSC part &lt;a href="https://lcsc.com/product-detail/Screw-terminal_JILN-JL301-50007U02_C409139.html">&lt;code>C409139&lt;/code>&lt;/a>&lt;/p>
&lt;p>The 2 pin screw terminal is LCSC part &lt;a href="https://lcsc.com/product-detail/Screw-terminal_Ningbo-Kangnex-Elec-WJ129V-5-0-2P_C8463.html">&lt;code>C8463&lt;/code>&lt;/a>&lt;/p>
&lt;p>The source and gerber files from EasyEDA are below. Upload them to your favorite PCB prototyping service or try your hand at making your own.&lt;/p>
&lt;h4 id="printed-parts">Printed parts&lt;/h4>
&lt;p>There are two parts: a &lt;code>lid&lt;/code> and a &lt;code>plate&lt;/code>. The electronics are attached to the plate and the stack light is attached to the lid. In the photos associated with this post, the &lt;code>lid&lt;/code> is dark blue and the &lt;code>plate&lt;/code> is yellow.&lt;/p>
&lt;p>The plate has features for several attachment methods:&lt;/p>
&lt;ul>
&lt;li>magnets; meant for horizontal surfaces&lt;/li>
&lt;li>3M command strip; probably wont be enough to do wall/ceilings, but should work in lieu of magnets on horizontal surfaces&lt;/li>
&lt;li>4 circular indents (&lt;code>10mm&lt;/code> diameter) included for anti-slip pads&lt;/li>
&lt;li>drywall screw/slot mounting for walls/ceilings&lt;/li>
&lt;/ul>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/base_mounting_options.png" alt="Picture annotated to call out specific design features in the base for a variety of mounting options." />
&lt;figcaption>
&lt;p>
I wasn&amp;#39;t sure where I&amp;#39;d want to install this, so there are a few options for attaching the base to surfaces.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Pause the print job at the correct layer if you intend to embed magnets:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/slicer.png" alt="Screenshot showing 3D printed parts arranged on slicing software with annotation pointing out when to insert optional magnets." />
&lt;figcaption>
&lt;p>
Insert your magnets before the layer covering thee 6 cavities is printed.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Both the &lt;code>lid&lt;/code> and &lt;code>base&lt;/code> are easy to print; material and color are up to you, as is layer height and quality settings. The &lt;code>stl&lt;/code> and &lt;code>step&lt;/code> files for both are at the end of this post.
Should you want to make your own enclosure from scratch, I have also included the &lt;code>step&lt;/code> files for the PoE dongle and PCB below.&lt;/p>
&lt;h2 id="assemble">Assemble&lt;/h2>
&lt;p>Assembly is relatively straightforward; its mostly integrating a few components into a simple 3d printed enclosure.&lt;/p>
&lt;h3 id="pcb-1">PCB&lt;/h3>
&lt;p>Solder the electronic components to the PCB. If omitting screw terminals for the stack light wires, do not solder them to the PCB yet!&lt;/p>
&lt;p>I created the castellated pad footprint for the ESP32 module by hand and, in the version of the PCB pictured, didn&amp;rsquo;t get the pads as close as they should be so there are some ugly solder blobs to compensate. The pads are correctly placed on the most recent PCB revision.&lt;/p>
&lt;p>I have included two programming headers on the PCB to flash your firmware; one at &lt;code>2.54mm&lt;/code> pitch and the other at &lt;code>1.0mm&lt;/code> pitch, the latter of which is intended for use with &lt;a href="https://www.aliexpress.com/item/4001122992446.html">this&lt;/a> programmer.&lt;/p>
&lt;p>There is a solder bridge labeled &lt;code>EXT 3v3&lt;/code>; short this out if you intend to use the programmer to power the ESP32 module. Leave it alone if you plan to use external DC to power the device during programming.&lt;/p>
&lt;p>I suggest programming the module &lt;em>now&lt;/em> to verify that you&amp;rsquo;ve built the PCB correctly and that your stack light works as expected.
Once you&amp;rsquo;ve confirmed the electronics and software all work together, proceed to final assembly.&lt;/p>
&lt;h2 id="everything-else">Everything else&lt;/h2>
&lt;p>The various holes designed to receive screw threads are intentionally undersized. If you&amp;rsquo;re not using self-tapping screws, you&amp;rsquo;ll find it MUCH EASER to insert a &lt;em>hot&lt;/em> screw for the first time.&lt;/p>
&lt;p>With the screw on the end of the driver, hold the tip of the screw/threads under a flame for 5-10 seconds and then quickly rotate the screw into the plastic using a bit of extra &amp;lsquo;pushing&amp;rsquo; force.
Once the screw is fully inserted, allow it to fully cool (~5min) so the softened plastic has a chance to solidify around the screw threads.&lt;/p>
&lt;p>The screws that hold the base plate to the body of the enclosure are meant to sit flush. Ensure that you screw them in fully before the plastic cools!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/00_flush_screws.jpg" alt="Picture showing assembly detail; the base plate is secured to the enclosure with screws." />
&lt;figcaption>
&lt;p>
If the screws protrude even a fraction of a millimeter, the light can wobble and the magnetic attachment is weakened.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>While waiting for the screws to cool, cut the Ethernet and power leads from the PoE dongle down to size. Desolder the leads from the dongle, trim to be as short as possible and re-solder.&lt;/p>
&lt;p>The less &amp;lsquo;slack&amp;rsquo; cable in the enclosure, the easier it will be to finish assembly!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/03_wire.jpg" alt="Picture showing all components secured to the base and wired together." />
&lt;figcaption>
&lt;p>
I cut a few inches off the Ethernet cable and power leads so everything fits in the enclosure better.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>After the screws have cooled, ensure that the PCB sits flush against the mounts.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/02_pcb_attached.jpg" alt="Picture showing assembly detail; the PCB should be attached to the base plate with screws and should be flush against the mounting posts." />
&lt;figcaption>
&lt;p>
PCB should be flush against the mounting posts.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>With all wires connected, lift the PoE dongle off of the base plate slightly and align the RJ45 jack with the square hole in the enclosure.&lt;/p>
&lt;p>Make sure the side of the base plate opposite the side with the RJ45 jack is securely mounts into the body of the enclosure!&lt;/p>
&lt;p>Gently press the remaining side of the base plate into the enclosure. As the base plate gets closer to flush with the body, the RJ45 jack should slowly come into alignment with the wall.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/04_close.jpg" alt="Picture showing assembly detail; the base plate acts like a lever to carefully line the PoE jack up with the enclosure body." />
&lt;figcaption>
&lt;p>
Use the plate as a lever to carefully push, then hold, the PoE dongle in place.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>When the base blate is completely installed into the body, the RJ45 jack should be flush with the external wall of the enclosure.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/00_plugged_in.jpg" alt="Picture showing assembled light attached to enclosure, focus is on the RJ45 port in the rear." />
&lt;figcaption>
&lt;p>
RJ45 jack should be flush to the outer wall of the enclosure.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Attach the base plate to the enclosure body with the 4 screws, attach silicon feet or a 3M command strip and then you&amp;rsquo;re done!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/01_all_off.jpg" alt="Picture showing assembled light attached to enclosure from the front. No individual light is powered up, they all have the same translucent white color." />
&lt;figcaption>
&lt;p>
Translucent white lenses for much less ambiguity than the stack lights with colored lenses.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="files">Files&lt;/h2>
&lt;p>All files below are licensed under the &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)&lt;/a> license unless otherwise explicitly noted.&lt;/p>
&lt;p>&lt;strong>None of the files below may be used for commercial purposes&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/01_all_off.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/01_all_off_hu84f091d21918fb28ffc476c083a4465b_2479126_300x0_resize_q75_box.jpg" width="300" height="533">
&lt;/a>
&lt;figcaption>
&lt;small>Translucent white lenses for much less ambiguity than the stack lights with colored lenses.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/base_mounting_options.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/base_mounting_options_hu0255bedc4865d595b96a27a21ce41057_6482507_300x0_resize_box_3.png" width="300" height="219">
&lt;/a>
&lt;figcaption>
&lt;small>I wasn&amp;#39;t sure where I&amp;#39;d want to install this, so there are a few options for attaching the base to surfaces.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/04_close.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/04_close_hubc1f23a45a7d66648fd74e7a8ca6d1fb_1183389_300x0_resize_q75_box.jpg" width="300" height="207">
&lt;/a>
&lt;figcaption>
&lt;small>Use the plate as a lever to carefully push, then hold, the PoE dongle in place.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/02_all_on.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/02_all_on_hu4a267d1b9fd60bea51ae86d52a8277a3_2512058_300x0_resize_q75_box.jpg" width="300" height="533">
&lt;/a>
&lt;figcaption>
&lt;small>The lights are much brighter than they appear in this picture; had to intentionally darken the image to prevent camera from blowing out the colors.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/easy_eda_gerber.zip">
&lt;i class="far fa-file-">&lt;/i>
files/easy_eda_gerber.zip:
&lt;br>
&lt;small>sha1: d7686b0ad88a1686a5a11cb009632b53ca474c75&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/easy_eda_source.zip">
&lt;i class="far fa-file-">&lt;/i>
files/easy_eda_source.zip:
&lt;br>
&lt;small>sha1: e05a00cdca9af94dd0e8d1d8f3aa998b75c14a08&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/enclosure-lid-m1v2.stl">
&lt;i class="far fa-file-code">&lt;/i>
files/enclosure-lid-m1v2.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1: 3870a674d9cf08bf26e3607e42ee766e9816ac6c&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/enclosure-plate-m1v2.stl">
&lt;i class="far fa-file-code">&lt;/i>
files/enclosure-plate-m1v2.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1: 8f90b54be2a798cf87bc6ca4fc118b82669e0668&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/esphome_confg.yaml">
&lt;i class="far fa-file-code">&lt;/i>
files/esphome_confg.yaml:
&lt;small style="font-family:'Lucida Console', monospace">yaml&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1: aa0076b7bee08f09568536463c8794f15a2f59b2&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/pcb.step">
&lt;i class="far fa-file-code">&lt;/i>
files/pcb.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1: e212f3cd3d90a639e6518b7d11bc5cc20df09b67&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/poe-dongle.step">
&lt;i class="far fa-file-code">&lt;/i>
files/poe-dongle.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1: a698c249d89f2ab2c981427df49620cb09ce5f66&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/files/stack-light-base.step">
&lt;i class="far fa-file-code">&lt;/i>
files/stack-light-base.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1: 3c3d0d6162a985b4f09d0f9a58fdacb3f08beb78&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/00_flush_screws.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/00_flush_screws_hu18db716c238b723311721626527a5273_846653_300x0_resize_q75_box.jpg" width="300" height="174">
&lt;/a>
&lt;figcaption>
&lt;small>If the screws protrude even a fraction of a millimeter, the light can wobble and the magnetic attachment is weakened.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/home-assistant.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/home-assistant_hue2400f52af2e5683bcea0d6b26c960ad_49477_300x0_resize_box_3.png" width="300" height="620">
&lt;/a>
&lt;figcaption>
&lt;small>Stack light is controlled via MQTT making it easy to control from Home Assistant or any other program that can speak MQTT.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/02_pcb_attached.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/02_pcb_attached_hu5b86cc1ae1d4eb0e7da297e27c7c6e45_630086_300x0_resize_q75_box.jpg" width="300" height="196">
&lt;/a>
&lt;figcaption>
&lt;small>PCB should be flush against the mounting posts.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/00_plugged_in.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/complete/00_plugged_in_hue44ce946944af7eac0fca70ddaff3b51_503633_300x0_resize_q75_box.jpg" width="300" height="237">
&lt;/a>
&lt;figcaption>
&lt;small>RJ45 jack should be flush to the outer wall of the enclosure.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/01_prep.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/01_prep_hufd56786e8b571605c37596e2d15f02f0_1406212_300x0_resize_q75_box.jpg" width="300" height="284">
&lt;/a>
&lt;figcaption>
&lt;small>About to start melting threads into the 3D printed parts.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/slicer.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/slicer_hu2585a2c3a0d5ec88fd8e2ca55641b8fa_1301722_300x0_resize_box_3.png" width="300" height="233">
&lt;/a>
&lt;figcaption>
&lt;small>Insert your magnets before the layer covering thee 6 cavities is printed.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/03_wire.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/02/poe-powered-stack-light/images/assemble/03_wire_hu33054df258a5fc4cb91d7d64e8a6a076_1857284_300x0_resize_q75_box.jpg" width="300" height="186">
&lt;/a>
&lt;figcaption>
&lt;small>I cut a few inches off the Ethernet cable and power leads so everything fits in the enclosure better.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>Unbrick a rievtech PLC after failed firmware upgrade</title><link>https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/</link><pubDate>Wed, 13 Jan 2021 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/</guid><description>&lt;p>This is &amp;ldquo;reference&amp;rdquo; post for anybody else that happens to have this same very specific problem.&lt;/p>
&lt;p>I was looking for a way to incorporate some of the &lt;em>many&lt;/em> cheap / industrial grade sensors from AliExpress with Home Assistant.
Long story short: almost everything electronic in the industrial space uses &lt;a href="https://modbus.org/">Modbus&lt;/a> to communicate, typically with a &lt;a href="https://en.wikipedia.org/wiki/Programmable_logic_controller">PLC&lt;/a>. While Home Assistant &lt;a href="https://www.home-assistant.io/integrations/modbus/">does have support&lt;/a> for the Modbus protocol, but wanted to use a PLC that could manage the sensors directly and expose the values over the network in a more standard format; MQTT.&lt;/p>
&lt;p>Turns out, quite a few PLCs come with network interfaces and can speak MQTT now!&lt;/p>
&lt;p>So I picked up a &lt;a href="https://www.rievtech.com/PR-18DC-DAI-R-N-pd72286477.html">&lt;code>PR-18DC-DAI-R-N&lt;/code>&lt;/a> PLC from the &amp;lsquo;budget friendly&amp;rsquo; supplier rievtech. The PLC was put into service in 2018 and never updated; the firmware version it was running was almost certainly below &lt;code>150&lt;/code> but I didn&amp;rsquo;t record the specific version.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/plc-00.jpg" alt="Stock photo from manufacturer&amp;#39;s website showing a device from the same product line as my bricked unit" />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;p>Hoping to squash a small bug, I chose to upgrade the firmware to version &lt;code>152&lt;/code> which was released at the end of 2020 and somehow managed to brick the device 🤦.&lt;/p>
&lt;p>I am &lt;em>speculating&lt;/em> but it looks like something significant changed around firmware version &lt;code>150&lt;/code>. If you try to update a device from a version prior to &lt;code>150&lt;/code> - like I did - something in memory is not properly migrated to the format required by versions after &lt;code>150&lt;/code> and this causes the update process to fail before completion:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/update-01.png" alt="Screenshot showing &amp;#39;Communicate is FAILED!&amp;#39; message with only .83% left to go on the firmware update." />
&lt;figcaption>
&lt;p>
SO close!
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>That failure message came from the &lt;a href="https://www.rievtech.com/phoenix/admin/download?fileId=jGUKpAvYWcQE&amp;amp;dp=GvUApKfKKUAU">Update_Net_V152_20201205.zip&lt;/a> file which is meant for the ethernet equipped PLCs in the &lt;code>PR&lt;/code> line. The failure apparently soft bricks the PLC.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/plc-01.jpg" alt="Picture showing the bricked PLC powered up." />
&lt;figcaption>
&lt;p>
Blank white screen. Non responsive buttons, Occasional blinking Ethernet lights. Fun! 🙃
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>The PLC seemed &amp;lsquo;alive&amp;rsquo; as I could still see &lt;code>arp&lt;/code> packets coming from it&amp;rsquo;s ethernet port on boot and the web server seemed to accept my connection but never return any data. Even after restarting the PLC, the firmware updater was able to open a new connection and flash the firmware&amp;hellip; always failing at the same spot: 99.17%.&lt;/p>
&lt;p>Clearly &lt;em>something&lt;/em> is alive and well inside the PLC&amp;hellip; If I can connect to whatever &lt;em>is&lt;/em> running and convince that process to update the flash then I have a good shot to do &amp;lsquo;solderless&amp;rsquo; recovery. Absolute worst case, I buy another one and clone the flash memory from the working one onto the bricked one.&lt;/p>
&lt;h2 id="recovery-process">Recovery process&lt;/h2>
&lt;p>Turns out, their support team has a file ready to go for this exact problem! I guess I&amp;rsquo;m not the first person. Really wish they&amp;rsquo;d publish this file and/or procedure on their website. I could have recovered from my failure in minutes with a quick google search and saved myself a few hours of trouble shooting before drafting a support ticket&amp;hellip; not to mention the days of waiting for a reply. Oh well. That&amp;rsquo;s why &lt;em>I&amp;rsquo;m&lt;/em> documenting it.&lt;/p>
&lt;p>I was given a 2.6MB file named &lt;code>UpdateFail_PR-18DC-DAI-R-N_V150.zip&lt;/code>. After extracting, it looks a lot like their &lt;em>regular&lt;/em> firmware update archives, just much smaller. I suspect that the archive is much smaller because it&amp;rsquo;s only got flash images for a few affected models/devices. In any event, the archive comes with a &lt;code>doc&lt;/code> file that I couldn&amp;rsquo;t open and was able to eventually convert it to a &lt;code>pdf&lt;/code> which is also attached to this post.&lt;/p>
&lt;p>In short:&lt;/p>
&lt;ul>
&lt;li>Connect the PLC using their &lt;a href="https://www.rievtech.com/USB-Cable-pd67130.html">programming cable&lt;/a>&lt;/li>
&lt;li>Open the COM port and &amp;lsquo;prepare&amp;rsquo; the device. This takes only a few seconds&lt;/li>
&lt;li>Click the update button. In my case, I got a failure telling me to `Please power off the PLC first, and then power on again!&amp;quot;&lt;/li>
&lt;li>Power cycle the PLC, keeping the update program and COM port open&lt;/li>
&lt;li>Click &lt;code>Start&lt;/code>. The process of flashing version &lt;code>150&lt;/code> started and took several minutes to finish&lt;/li>
&lt;/ul>
&lt;p>This left me with a &lt;em>completely working&lt;/em> PLC 🥳! I was able to access the web interface and use the LCD screen. I was &lt;em>then&lt;/em> able to use the network update tool to the firmware version released recently; version &lt;code>152&lt;/code>.&lt;/p>
&lt;p>So there you go. If a failed network update leaves your &lt;code>PR&lt;/code> series PLC in a mostly-not-working state, there is hope!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/recovery-01.png" alt="Screenshot showing &amp;#39;Update is SUCCEED!&amp;#39; message after device recovery." />
&lt;figcaption>
&lt;p>
Able to flash Version 152 w/o issue!
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="files">Files&lt;/h2>
&lt;ul>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/files/How%20to%20update%20the%20hardware.doc.pdf">
&lt;i class="far fa-file-doc">&lt;/i>
files/How to update the hardware.doc.pdf:
&lt;small style="font-family:'Lucida Console', monospace">pdf&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1(How to update the hardware.doc.pdf): 0b451b11938b58c384465f5bf350b2f133848649&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/files/UpdateFail_PR-18DC-DAI-R-N_V150.zip">
&lt;i class="far fa-file-archive">&lt;/i>
files/UpdateFail_PR-18DC-DAI-R-N_V150.zip:
&lt;small style="font-family:'Lucida Console', monospace">zip&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>sha1(UpdateFail_PR-18DC-DAI-R-N_V150.zip): 60c306b521cdb15589b0e36dc73df484c2117539&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/plc-01.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/plc-01_huf50e4ff8022cdea5fd849e876fbc526e_1066128_300x0_resize_q75_box.jpg" width="300" height="262">
&lt;/a>
&lt;figcaption>
&lt;small>Blank white screen. Non responsive buttons, Occasional blinking Ethernet lights. Fun! 🙃&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/plc-00.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/plc-00_hu2021a2dddf6a319278f4640805172316_18216_300x0_resize_q75_box.jpg" width="300" height="300">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/recovery-01.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/recovery-01_hu656f8d998128e6c53b83359f6326ff82_16229_300x0_resize_box_3.png" width="300" height="314">
&lt;/a>
&lt;figcaption>
&lt;small>Able to flash Version 152 w/o issue!&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/update-01.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2021/01/unbrick-a-rievtech-plc-after-failed-firmware-upgrade/images/update-01_hu06e722afe350a8459b354a9a55c31522_47082_300x0_resize_box_3.png" width="300" height="315">
&lt;/a>
&lt;figcaption>
&lt;small>SO close!&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>Monitoring APC AP7900 switched PDU with Prometheus and Grafana</title><link>https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/</link><pubDate>Sun, 27 Dec 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/</guid><description>&lt;p>The APC AP7900 is a 1U single phase PDU with 8 switchable outlets and a network interface. It&amp;rsquo;s been EoL&amp;rsquo;d and can be had for less than 20% of it&amp;rsquo;s original price on &lt;a href="https://www.ebay.com/sch/i.html?_nkw=AP7900">eBay&lt;/a>. The network interface is so underpowered tha it can&amp;rsquo;t &lt;a href="http://origin-faq.pro-face.com/resources/sites/PROFACE/content/live/FAQS/300000/FA300635/en_US/APC%20AP7000%20Series%20End%20of%20Life%20Notice.pdf">support any modern cryptographic ciphers&lt;/a>.&lt;/p>
&lt;p>So with that, here&amp;rsquo;s a revised copy of my notes from the process of getting the device reset, updated and monitored.&lt;/p>
&lt;h2 id="the-hardware">The Hardware&lt;/h2>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/images/ap7900.png" alt="marketing photo of AP7900" />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;p>Unfortunately, there&amp;rsquo;s no &amp;ldquo;reset everything to defaults&amp;rdquo; button or button sequence on the PDU. The unit I purchased had been configured with a manual IP assignment so it wasn&amp;rsquo;t as straightforward as using an unfolded paperclip to press the reboot button at boot and wait for a successful DHCP negotiation. This process has been &lt;a href="https://dan.langille.org/2015/01/13/apc-pdu-ap7900-resetting-the-password/">covered before&lt;/a>, so I&amp;rsquo;ll omit it here. In short: connect to the local mgmt interface via the &lt;a href="https://pinoutguide.com/UPS/apc_smart_cable_pinout.shtml">serial port&lt;/a>, adjust the network configuration and other settings as needed.&lt;/p>
&lt;p>The firmware can be updated via FTP easily enough. The processor on the network interface is &lt;em>really&lt;/em> slow so allow for &lt;em>several minutes&lt;/em> between the bin file upload and the flashing to commence/end. I had to repeat this three times for each of the partitions / subsystem OSs.&lt;/p>
&lt;h2 id="the-metrics">The Metrics&lt;/h2>
&lt;p>Again, because the network interface has an ancient/slow CPU, any method that extracts metrics from the device must be light weight&amp;hellip; enter &lt;a href="https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol">SNMP&lt;/a>.&lt;/p>
&lt;p>SNMP is quite old and cumbersome but there&amp;rsquo;s an &lt;a href="https://github.com/prometheus/snmp_exporter">exporter for prometheus&lt;/a> which, after some tedious configuration, can interface the complexity that is is legacy SNMP with prometheus.&lt;/p>
&lt;h3 id="generating-a-config">Generating a config&lt;/h3>
&lt;p>In short, SNMP identifies each setting/entity that can be monitored or set with a unique numerical ID. Each number is separated with a &lt;code>.&lt;/code> and represents a specific edge/vertex on the graph of all settings that device supports.&lt;/p>
&lt;p>So, a setting known as &lt;code>rPDUIdentDeviceLinetoLineVoltage&lt;/code> may be &amp;lsquo;read&amp;rsquo; at the following address: &lt;code>1.3.6.1.4.1.318.1.1.12.1.15.0&lt;/code>. So if you have a few hundred parameters to monitor, you&amp;rsquo;ll have a few hundred nondescript numerical paths. Keeping track of them all is a royal pain in the ass, even with &lt;a href="https://en.wikipedia.org/wiki/Management_information_base">lookup tables&lt;/a>; known as &amp;ldquo;MIB files&amp;rdquo;.&lt;/p>
&lt;p>Unfortunately, there&amp;rsquo;s no way around it; a map between the numerical paths and the &amp;lsquo;human friendly&amp;rsquo; names must be built so the prometheus exporter knows what to expose and how to categorize it.&lt;/p>
&lt;p>The exporter comes with &lt;a href="https://github.com/prometheus/snmp_exporter/tree/master/generator">generator&lt;/a> to make this process a bit easier, but the process of obtaining MIB files isn&amp;rsquo;t quite so straightforward.
I hit a few snags and below is an updated &lt;code>Dockerfile&lt;/code> that gave me a &lt;em>working&lt;/em> generator tool:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-Dockerfile" data-lang="Dockerfile">&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">FROM&lt;/span>&lt;span style="font-style:italic"> golang:latest&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># The `mibs` target in the Makefile does not run to completion on OSX.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># Somewhere, a `sed` command is run against some vendor&amp;#39;s MIB file that&amp;#39;s for hardware that I don&amp;#39;t want to target.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># I don&amp;#39;t have the patience to resolve those issues and i&amp;#39;d prefer that the _entire_ MIB parse and generate &lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># process be 100% contained in the container image anyways.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">#&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># There are a _variety_ of errors that cropped up when running `generator parse_errors`:&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">#&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - level=warn ts=2020-12-27T21:40:42.988Z caller=main.go:120 msg=&amp;#34;NetSNMP reported parse error(s)&amp;#34; errors=16924&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - Cannot find module (SNMPv2-SMI): At line 275 in mibs/apc-powernet-mib&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - Did not find &amp;#39;enterprises&amp;#39; in module #-1 (mibs/apc-powernet-mib)&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - Did not find &amp;#39;DisplayString&amp;#39; in module #-1 (mibs/apc-powernet-mib)&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - Unlinked OID in PowerNet-MIB: apc ::= { enterprises 318 }&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - Undefined identifier: enterprises near line 281 of mibs/apc-powernet-mib&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - Cannot adopt OID in PowerNet-MIB: atsInputEntry ::= { atsInputTable 1 }&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - &amp;lt;and hundreds more `Cannot adopt OID in PowerNet-MIB:` messages&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># - Bad operator (INTEGER): At line 73 in /usr/share/snmp/mibs/ietf/SNMPv2-PDU&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">#&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">#&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># After some searching, it appears that MIBs can refer to other MIBs and some set of &amp;#39;base&amp;#39; files is not present.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># Due to licensing, the Debian docker image that the generator is based on does NOT ship w/ them or the &lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># `snmp-mibs-downloader` tool which is used to fetch the base MIB files. This is easy enough to fix...&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># First, update the repos we&amp;#39;ll pull packaged from&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">RUN&lt;/span> echo &lt;span style="font-style:italic">&amp;#34;deb http://deb.debian.org/debian/ buster main contrib non-free&amp;#34;&lt;/span> | tee -a /etc/apt/sources.list &amp;amp;&amp;amp; &lt;span style="font-weight:bold;font-style:italic">\
&lt;/span>&lt;span style="font-weight:bold;font-style:italic">&lt;/span> echo &lt;span style="font-style:italic">&amp;#34;deb http://deb.debian.org/debian/ buster-updates main contrib non-free&amp;#34;&lt;/span> | tee -a /etc/apt/sources.list &amp;amp;&amp;amp; &lt;span style="font-weight:bold;font-style:italic">\
&lt;/span>&lt;span style="font-weight:bold;font-style:italic">&lt;/span> echo &lt;span style="font-style:italic">&amp;#34;deb http://security.debian.org/debian-security buster/updates main contrib non-free&amp;#34;&lt;/span> | tee -a /etc/apt/sources.list&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># Then we run the &amp;#39;original&amp;#39; set of commands, adding in the `snmp-mibs-downloader` package.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># As part of the post-install hook, snmp-mibs-downloader will fetch the base MIBs that appear to be&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># missing.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">RUN&lt;/span> apt-get update &amp;amp;&amp;amp; &lt;span style="font-weight:bold;font-style:italic">\
&lt;/span>&lt;span style="font-weight:bold;font-style:italic">&lt;/span> apt-get install -y libsnmp-dev p7zip-full snmp-mibs-downloader &amp;amp;&amp;amp; &lt;span style="font-weight:bold;font-style:italic">\
&lt;/span>&lt;span style="font-weight:bold;font-style:italic">&lt;/span> go get github.com/prometheus/snmp_exporter/generator &amp;amp;&amp;amp; &lt;span style="font-weight:bold;font-style:italic">\
&lt;/span>&lt;span style="font-weight:bold;font-style:italic">&lt;/span> cd /go/src/github.com/prometheus/snmp_exporter/generator &amp;amp;&amp;amp; &lt;span style="font-weight:bold;font-style:italic">\
&lt;/span>&lt;span style="font-weight:bold;font-style:italic">&lt;/span> go get -v . &amp;amp;&amp;amp; &lt;span style="font-weight:bold;font-style:italic">\
&lt;/span>&lt;span style="font-weight:bold;font-style:italic">&lt;/span> go install&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># To fix _this_ error:&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># Bad operator (INTEGER): At line 73 in /usr/share/snmp/mibs/ietf/SNMPv2-PDU&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">#&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># we install a &amp;#39;patched&amp;#39; version.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># src: https://serverfault.com/questions/936119/snmp-mibs-on-ubuntu-error-in-mibs&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">RUN&lt;/span> wget http://pastebin.com/raw.php?i=p3QyuXzZ -O /usr/share/snmp/mibs/ietf/SNMPv2-PDU&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># This command is not needed for generation, but IS needed for manual checking / use of `snmptranslate` within the&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># container. Add to the above RUN statement if needed.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># sed -i &amp;#34;s/^\(mibs *:\).*/#\1/&amp;#34; /etc/snmp/snmp.conf&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">#&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># It simply comments out the `mibs:` line in `/etc/snmp/snmp.conf`&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># The &amp;#39;stock&amp;#39; generator expects the output of `make mibs` to be mounted into /opt/mibs.&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># Since we are no longer relying on the `make` target, we must tell the generator binary&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># to look in all of the &amp;#39;system default&amp;#39; locations *as well as* /opt/mibs&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">WORKDIR&lt;/span>&lt;span style="font-style:italic"> &amp;#34;/opt&amp;#34;&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">ENTRYPOINT&lt;/span> [&lt;span style="font-style:italic">&amp;#34;/go/bin/generator&amp;#34;&lt;/span>]&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># Rather than do something like this on the CLI every time the container is run&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># `-e MIBDIRS=&amp;#34;/usr/share/snmp/mibs:/usr/share/snmp/mibs/iana:/usr/share/snmp/mibs/ietf:/opt/mibs&amp;#34;`&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic"># we do it here...&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-style:italic">##&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">ENV&lt;/span> MIBDIRS /usr/share/snmp/mibs:/usr/share/snmp/mibs/iana:/usr/share/snmp/mibs/ietf:/opt/mibs&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;span style="">&lt;/span>&lt;span style="font-weight:bold">CMD&lt;/span> [&lt;span style="font-style:italic">&amp;#34;generate&amp;#34;&lt;/span>]&lt;span style="">
&lt;/span>&lt;span style="">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In short, ditch the &lt;code>make mibs&lt;/code> step from &lt;a href="https://github.com/prometheus/snmp_exporter/tree/master/generator#docker-users">here&lt;/a> and move it inside the &lt;code>docker build&lt;/code> step; fetch all the MIB files, patching those that need it. Tell the tool where to find them.&lt;/p>
&lt;p>For my needs, I only care about the total amount of power being distributed through the PDU so, of the hundreds of different parameters that can be monitored, I&amp;rsquo;m only interested in:&lt;/p>
&lt;ul>
&lt;li>Uptime&lt;/li>
&lt;li>Input Voltage&lt;/li>
&lt;li>Power in Watts and VoltAmps&lt;/li>
&lt;li>Percentage of used/remaining capacity&lt;/li>
&lt;/ul>
&lt;p>This makes for a simple generator config:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-style:italic"># See: https://github.com/prometheus/snmp_exporter/tree/master/generator&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">modules&lt;/span>:
&lt;span style="font-style:italic"># APC/Schneider UPS Network Management Cards&lt;/span>
&lt;span style="font-style:italic">#&lt;/span>
&lt;span style="font-style:italic"># Note: older management cards only support SNMP v1 (AP9606 and&lt;/span>
&lt;span style="font-style:italic"># AP9607, possibly others). Older versions of the firmware may only&lt;/span>
&lt;span style="font-style:italic"># support v1 as well. If you only have newer cards you can switch to&lt;/span>
&lt;span style="font-style:italic"># version v2c or v3.&lt;/span>
&lt;span style="font-style:italic">#&lt;/span>
&lt;span style="font-style:italic"># The management cards have relatively slow processors so don&amp;#39;t poll&lt;/span>
&lt;span style="font-style:italic"># very often and give a generous timeout to prevent spurious&lt;/span>
&lt;span style="font-style:italic"># errors. Alternatively you can eliminate the interface polling (OIDs&lt;/span>
&lt;span style="font-style:italic"># beginning with 1.3.6.1.2.1) to reduce the time taken for polling.&lt;/span>
&lt;span style="font-style:italic">#&lt;/span>
&lt;span style="font-style:italic"># MIB: https://download.schneider-electric.com/files?p_File_Name=powernet426.mib&lt;/span>
&lt;span style="font-style:italic"># Guide: http://www.apc.com/salestools/ASTE-6Z5QEY/ASTE-6Z5QEY_R0_EN.pdf&lt;/span>
&lt;span style="font-style:italic"># Download site: http://www.apc.com/us/en/tools/download/index.cfm&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">apcups&lt;/span>:
&lt;span style="font-style:italic"># Not 100% sure why, but APC firmware does not appear to properly authenticate with the&lt;/span>
&lt;span style="font-style:italic"># credentials that i&amp;#39;ve set through the web UI. I&amp;#39;ve disabled write/set via SNMP so &lt;/span>
&lt;span style="font-style:italic"># sticking w/ v2 (no auth) is fine.&lt;/span>
&lt;span style="font-weight:bold">version&lt;/span>: 2
&lt;span style="font-weight:bold">walk&lt;/span>:
&lt;span style="font-style:italic"># Don&amp;#39;t care about network stats on this guy...&lt;/span>
&lt;span style="font-style:italic"># - interfaces&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-style:italic"># Do care about uptime, tho&lt;/span>
- sysUpTime
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-style:italic"># For reasons that I don&amp;#39;t understand, specifying the OID results in errors like this:&lt;/span>
&lt;span style="font-style:italic"># level=error caller=main.go:130 msg=&amp;#34;Error generating config netsnmp&amp;#34; err=&amp;#34;cannot find oid &amp;#39;.1.3.6.1.4.1.318.1.1.12.1.15.0&amp;#39; to walk&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># But the path &amp;#39;.1.3.6.1.4.1.318.1.1.12.1.15.0&amp;#39; maps to rPDUIdentDeviceLinetoLineVoltage.0&lt;/span>
&lt;span style="font-style:italic"># So specify that by name and the error goes away :/&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
- rPDUIdentDeviceLinetoLineVoltage &lt;span style="font-style:italic"># .1.3.6.1.4.1.318.1.1.12.1.15.0&lt;/span>
- rPDUIdentDevicePowerWatts &lt;span style="font-style:italic"># .1.3.6.1.4.1.318.1.1.12.1.16.0&lt;/span>
- rPDUIdentDevicePowerVA &lt;span style="font-style:italic"># .1.3.6.1.4.1.318.1.1.12.1.18.0&lt;/span>
- rPDULoadStatusTable &lt;span style="font-style:italic"># .1.3.6.1.4.1.318.1.1.12.2.3.1&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-style:italic"># From `rPDULoadStatusTable`, I can get `rPDULoadStatusLoad` and `rPDULoadStatusLoadState`&lt;/span>
&lt;span style="font-style:italic"># which represent the percentage capacity as a percentage and a &amp;#34;low, nominal, warn, critical&amp;#34; flag.&lt;/span>
&lt;span style="font-style:italic">#&lt;/span>
&lt;span style="font-style:italic"># Don&amp;#39;t need to resort to the `lookup` mechanism as the PDU has only one bank and can just extract the values&lt;/span>
&lt;span style="font-style:italic"># by referring to them explicitly below. This would likely change w/ a 2U PDU&lt;/span>
&lt;span style="font-style:italic"># Allows for adjustment to how various SNMP endpoints are parsed (as info about a device vs a moving metric)&lt;/span>
&lt;span style="font-style:italic"># See: https://github.com/prometheus/snmp_exporter/tree/master/generator#enumasinfo-and-enumasstateset&lt;/span>
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-weight:bold">overrides&lt;/span>:
&lt;span style="font-style:italic"># Should be a percentage of load&lt;/span>
&lt;span style="font-weight:bold">rPDULoadStatusLoad&lt;/span>:
&lt;span style="font-weight:bold">type&lt;/span>: gauge
&lt;span style="font-style:italic"># In addition to a numerical load percentage, also handy to have the characterization _of_ that load, too&lt;/span>
&lt;span style="font-style:italic"># In this case, the load can be characterized one of 4 ways:&lt;/span>
&lt;span style="font-style:italic"># phaseLoadNormal (1),phaseLoadLow (2),phaseLoadNearOverload (3),phaseLoadOverload (4)&lt;/span>
&lt;span style="font-weight:bold">rPDULoadStatusLoadState&lt;/span>:
&lt;span style="font-weight:bold">type&lt;/span>: EnumAsStateSet
&lt;span style="font-style:italic">##&lt;/span>
&lt;span style="font-style:italic"># There are a few &amp;#39;constants&amp;#39; that come from the table i don&amp;#39;t need to track, so we drop them :)&lt;/span>
&lt;span style="font-weight:bold">rPDULoadStatusBankNumber&lt;/span>:
&lt;span style="font-weight:bold">ignore&lt;/span>: &lt;span style="font-weight:bold">true&lt;/span>
&lt;span style="font-weight:bold">type&lt;/span>: EnumAsInfo
&lt;span style="font-weight:bold">rPDULoadStatusIndex&lt;/span>:
&lt;span style="font-weight:bold">ignore&lt;/span>: &lt;span style="font-weight:bold">true&lt;/span>
&lt;span style="font-weight:bold">type&lt;/span>: EnumAsInfo
&lt;span style="font-weight:bold">rPDULoadStatusPhaseNumber&lt;/span>:
&lt;span style="font-weight:bold">ignore&lt;/span>: &lt;span style="font-weight:bold">true&lt;/span>
&lt;span style="font-weight:bold">type&lt;/span>: EnumAsInfo
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The resulting &lt;code>snmp.yml&lt;/code> is quite brief:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-style:italic"># WARNING: This file was auto-generated using snmp_exporter generator, manual changes will be lost.&lt;/span>
&lt;span style="font-weight:bold">apcups&lt;/span>:
&lt;span style="font-weight:bold">walk&lt;/span>:
- 1.3.6.1.4.1.318.1.1.12.2.3.1
&lt;span style="font-weight:bold">get&lt;/span>:
- 1.3.6.1.2.1.1.3.0
- 1.3.6.1.4.1.318.1.1.12.1.15.0
- 1.3.6.1.4.1.318.1.1.12.1.16.0
- 1.3.6.1.4.1.318.1.1.12.1.18.0
&lt;span style="font-weight:bold">metrics&lt;/span>:
- &lt;span style="font-weight:bold">name&lt;/span>: sysUpTime
&lt;span style="font-weight:bold">oid&lt;/span>: 1.3.6.1.2.1.1.3
&lt;span style="font-weight:bold">type&lt;/span>: gauge
&lt;span style="font-weight:bold">help&lt;/span>: The time (in hundredths of a second) since the network management portion of the system was last re-initialized. - 1.3.6.1.2.1.1.3
- &lt;span style="font-weight:bold">name&lt;/span>: rPDUIdentDeviceLinetoLineVoltage
&lt;span style="font-weight:bold">oid&lt;/span>: 1.3.6.1.4.1.318.1.1.12.1.15
&lt;span style="font-weight:bold">type&lt;/span>: gauge
&lt;span style="font-weight:bold">help&lt;/span>: Getting/Setting this OID will return/set the Line to Line Voltage - 1.3.6.1.4.1.318.1.1.12.1.15
- &lt;span style="font-weight:bold">name&lt;/span>: rPDUIdentDevicePowerWatts
&lt;span style="font-weight:bold">oid&lt;/span>: 1.3.6.1.4.1.318.1.1.12.1.16
&lt;span style="font-weight:bold">type&lt;/span>: gauge
&lt;span style="font-weight:bold">help&lt;/span>: Getting this OID will return the Power in Watts. - 1.3.6.1.4.1.318.1.1.12.1.16
- &lt;span style="font-weight:bold">name&lt;/span>: rPDUIdentDevicePowerVA
&lt;span style="font-weight:bold">oid&lt;/span>: 1.3.6.1.4.1.318.1.1.12.1.18
&lt;span style="font-weight:bold">type&lt;/span>: gauge
&lt;span style="font-weight:bold">help&lt;/span>: Getting this OID will return the Power in VA. - 1.3.6.1.4.1.318.1.1.12.1.18
- &lt;span style="font-weight:bold">name&lt;/span>: rPDULoadStatusLoad
&lt;span style="font-weight:bold">oid&lt;/span>: 1.3.6.1.4.1.318.1.1.12.2.3.1.1.2
&lt;span style="font-weight:bold">type&lt;/span>: gauge
&lt;span style="font-weight:bold">help&lt;/span>: Getting this OID will return the phase/bank load measured in tenths of Amps. - 1.3.6.1.4.1.318.1.1.12.2.3.1.1.2
&lt;span style="font-weight:bold">indexes&lt;/span>:
- &lt;span style="font-weight:bold">labelname&lt;/span>: rPDULoadStatusIndex
&lt;span style="font-weight:bold">type&lt;/span>: EnumAsInfo
- &lt;span style="font-weight:bold">name&lt;/span>: rPDULoadStatusLoadState
&lt;span style="font-weight:bold">oid&lt;/span>: 1.3.6.1.4.1.318.1.1.12.2.3.1.1.3
&lt;span style="font-weight:bold">type&lt;/span>: EnumAsStateSet
&lt;span style="font-weight:bold">help&lt;/span>: Getting this OID will return the phase/bank load state - 1.3.6.1.4.1.318.1.1.12.2.3.1.1.3
&lt;span style="font-weight:bold">indexes&lt;/span>:
- &lt;span style="font-weight:bold">labelname&lt;/span>: rPDULoadStatusIndex
&lt;span style="font-weight:bold">type&lt;/span>: EnumAsInfo
&lt;span style="font-weight:bold">enum_values&lt;/span>:
&lt;span style="font-weight:bold">1&lt;/span>: phaseLoadNormal
&lt;span style="font-weight:bold">2&lt;/span>: phaseLoadLow
&lt;span style="font-weight:bold">3&lt;/span>: phaseLoadNearOverload
&lt;span style="font-weight:bold">4&lt;/span>: phaseLoadOverload
&lt;span style="font-weight:bold">version&lt;/span>: 2
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="the-dashboard">The Dashboard&lt;/h2>
&lt;p>Once metrics are making their way into prometheus, it&amp;rsquo;s only a bit of work to get a dashboard up and running.&lt;/p>
&lt;p>For sanity checking I fired up a load; a crypto-miner. See if you can spot when&amp;hellip; :).&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/images/grafana.png" alt="screenshot showing simple grafana dashboard consuming some of the PDU metrics" />
&lt;figcaption>
&lt;p>
Simple dashboard in grafana
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>The &lt;code>json&lt;/code> file for the dashboard is about 750 lines long, so rather than embed it, I&amp;rsquo;ve &lt;a href="#files">attached&lt;/a> it as a file; the sha1 hash of &lt;code>dashboard.json&lt;/code> is &lt;code>400edb0c4064068f12e17c2f1f0d6862d3b8d449&lt;/code>.&lt;/p>
&lt;h3 id="estimating-costs">estimating costs&lt;/h3>
&lt;p>The dashboard just multiplies the average Wattage by the average cost of a kWh and then scales that to fit a 24h window.&lt;/p>
&lt;p>The rate I pay for electricity changes based on the hour in which the power is used; about 40% of the week, my power costs a few cents per kWh more. The cost shown in the image above is a rough approximation based on my average power rate of around 12.5 cents per kWh. This rate can be adjusted with the &lt;code>avgkWH_Cost&lt;/code> variable, if needed.&lt;/p>
&lt;h2 id="files">Files&lt;/h2>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/images/ap7900.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/images/ap7900_hua86ef71d7c97469c72abcc8606f92a1f_30363_300x0_resize_box_3.png" width="300" height="300">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/files/dashboard.json">
&lt;i class="far fa-file-file-code">&lt;/i>
files/dashboard.json:
&lt;br>
&lt;small>sha1(dashboard.json): 400edb0c4064068f12e17c2f1f0d6862d3b8d449&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/images/grafana.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/12/monitoring-apc-ap7900-switched-pdu-with-prometheus-and-grafana/images/grafana_hu12e2e56abae7547e2e0002fa4ac227b7_229334_300x0_resize_box_3.png" width="300" height="147">
&lt;/a>
&lt;figcaption>
&lt;small>Simple dashboard in grafana&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>Amcrest IP Cameras: security isn't a feature, it's a punchline</title><link>https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/</link><pubDate>Fri, 27 Nov 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/</guid><description>&lt;p>This is part rant, part &amp;ldquo;reference&amp;rdquo; for anybody else that&amp;rsquo;s struggling to get their Amcrest IP Camera to work with &lt;a href="https://www.home-assistant.io/integrations/onvif/">Home Assistant&lt;/a> via ONVIF. Skip to &lt;a href="#tldr">TL;DR&lt;/a> for a working Home Assistant config.&lt;/p>
&lt;p>Briefly, &lt;a href="https://www.onvif.org/profiles/">ONVIF&lt;/a> is an industry group that maintains a set of standards to allow for interoperability between IP Cameras and related devices from multiple vendors. One set of protocols so your cameras from &lt;code>$vendorA&lt;/code> will work with with the recording/analytics software from &lt;code>$vendorB&lt;/code> which can then pipe events into software from &lt;code>$vendorC&lt;/code>.
How ONVIF works and how it&amp;rsquo;s implemented are beyond the scope of this rant, but, like most standards that haven&amp;rsquo;t aged well, &lt;a href="https://en.wikipedia.org/wiki/SOAP">SOAP&lt;/a> is involved. 🤮.&lt;/p>
&lt;p>The IP Camera in question is the &lt;code>Amcrest IP4M-1051&lt;/code>, though it does appear that other devices from Amcrest are effected by some of the same issues I&amp;rsquo;ll detail below.
Additionally, Amcrest appears to be a budget brand offering cheaper versions of &lt;a href="https://en.wikipedia.org/wiki/Dahua_Technology">DaHua&lt;/a> hardware, so the firmware Amcrest uses likely originates from DaHua.&lt;/p>
&lt;p>The hardware is pretty good for the price. About $80 and you get a camera with a pretty wide field of view, 4K resolution, automatic IR leds/filter, PTZ servos, 10/100 Ethernet &lt;em>and&lt;/em> 2.4/5ghz WiFi. The software, however is scarry 😱.&lt;/p>
&lt;p>I&amp;rsquo;ve only spent a few hours with the camera so far, but here&amp;rsquo;s an incomplete list of the security-related issues i&amp;rsquo;ve noticed in that time:&lt;/p>
&lt;ul>
&lt;li>There&amp;rsquo;s no way to require the web interface be served over HTTPS. You can turn on HTTPS support, but you can&amp;rsquo;t turn of HTTP support!&lt;/li>
&lt;li>ONVIF runs over HTTP &amp;hellip; on port 80!&lt;/li>
&lt;li>Only the ADMIN user is supported for ONVIF&lt;/li>
&lt;li>Passwords are limited to 32 characters in length&amp;hellip; but the web UI won&amp;rsquo;t inform you about this.&lt;/li>
&lt;/ul>
&lt;h3 id="firmware">Firmware&lt;/h3>
&lt;p>Before anybody asks, yes, I did update the firmware to the latest version immediately after unboxing.
As of writing, the latest firmware available is version &lt;code>V2.620.00AC000.3.R.20191218&lt;/code> which can be downloaded &lt;a href="https://sup-files.s3.us-east-2.amazonaws.com/Firmware/IP4M-1051/Amcrest_IPC-AWXX-V2-Rhea_Eng_NP_AMCREST_V2.620.00AC000.3.R.20191218.bin">here&lt;/a>.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/fw-update-download.png" alt="Screenshot showing the Amcrest Firmware page" />
&lt;figcaption>
&lt;p>
FW for all Amcrest devices can be fetched from https://amcrest.com/firmwaredownloads.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>In the unlikely event that anybody sees this post and somehow gets Amcrest to correct their issues, the versions of software on the affected cameras are:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-txt" data-lang="txt">Software Version: V2.620.00AC000.3.R, Build Date: 2019-12-18
WEB Version: 3.2.1.619604
ONVIF Version: 16.12(V2.4.1.513183)
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="web-ui">Web UI&lt;/h2>
&lt;p>Nothing shocking about a networking equipped, consumer-grade bit of electronics with a web based management interface. The only reason I&amp;rsquo;m noting it here is because I can&amp;rsquo;t find a way to
force the web UI to be served over HTTPS 😢.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/network_port-conflict.png" alt="Screenshot showing the port assignment page on the camera management interface" />
&lt;figcaption>
&lt;p>
*sigh*
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>And the &lt;code>HTTPS&lt;/code> tab has no way to disable the web server on port 80 or at least do a simple redirect to the HTTPS URL 😞.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/network_https.png" alt="Screenshot showing the HTTPS / certificate configuration on the camera management interface" />
&lt;figcaption>
&lt;p>
I&amp;#39;ll leave you to determine if it&amp;#39;s a good idea for the web interface to generate a self-signed certificate or not.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>I suspect that the next issue might have something to do with the &amp;lsquo;always on&amp;rsquo; HTTP server&amp;hellip; 🤔&lt;/p>
&lt;h2 id="onvif-over-port-80">ONVIF over port 80&lt;/h2>
&lt;p>The inciting &amp;lsquo;incident&amp;rsquo; for this post was a &amp;lsquo;generic&amp;rsquo; error from Home Assistant while trying to connect the camera to HA.
While going through the config flow, I&amp;rsquo;d get a super useful &lt;code>an unknown error occurred&lt;/code> message 🙃.&lt;/p>
&lt;p>After a bit of digging through verbose HA logs, I started to suspect that the default port of &lt;code>5000&lt;/code> was not the correct port despite the port being &amp;lsquo;open&amp;rsquo; on the camera:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ nmap -p1-6553 cameraIPv4Here
Starting Nmap 7.91 ( https://nmap.org ) at 2020-11-27 16:14 PST
Nmap scan report &lt;span style="font-weight:bold">for&lt;/span> cameraIPv4Here
Host is up (0.010s latency).
Not shown: 6547 closed ports
PORT STATE SERVICE
53/tcp open domain
80/tcp open http
123/tcp filtered ntp
443/tcp open https
554/tcp open rtsp
5000/tcp open upnp
Nmap &lt;span style="font-weight:bold">done&lt;/span>: 1 IP address (1 host up) scanned in 2.21 seconds
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Sure enough, Home Assistant found a responsive ONVIF endpoint on port 80. Repeated testing showed that port 80 is the ONLY port with a responsive ONVIF endpoint 🤦.&lt;/p>
&lt;p>So yeah. ONVIF traffic, just like the web UI traffic, can be sniffed by anybody between the client and the camera. That&amp;rsquo;s not OK for a device that&amp;rsquo;s intended to be used for security.&lt;/p>
&lt;p>So this little setting is basically useless:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/manual_onvif_auth.png" alt="Screenshot showing the &amp;#39;authentication&amp;#39; setting for the ONVIF service on the camera management interface" />
&lt;figcaption>
&lt;p>
&amp;#39;Authentication&amp;#39; is misleading. It should be labeled something along the lines of &amp;#39;allow just ADMIN to use onvif or allow anybody to use onvif&amp;#39;
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>That screenshot is from the PDF file &lt;a href="https://drive.google.com/file/d/1X-f5xH4aSjhd4vXpIT9yPN_y9-LSgVWN/view">here&lt;/a> which has this revision info:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">Amcrest IP4M-1051B / IP4M-1051W
4MP ProHD Indoor Wi-Fi Camera
User Manual
Version 1.0.3
Revised April 4th, 2019
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="onvif-only-supports-authentication-with-the-admin-user">ONVIF only supports authentication with the Admin user&lt;/h2>
&lt;p>After discovering that ONVIF only &amp;lsquo;works&amp;rsquo; over port 80, I took a moment to get over my disappointment and then tried to set up a second user with minimal authority on the camera; read only and limited permission to move the camera around.&lt;/p>
&lt;p>Except I was never able to get HA to successfully connect to the camera when using the secondary user. Home Assistant still failed to connect to the camera over ONVIF even after elevating the secondary user to the privilege level of an admin:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/web_ui-admin_user.png" alt="Screenshot showing the admin user and its entitlements on the camera web UI" />
&lt;figcaption>
&lt;p>
Admin users have all 34 permissions enabled
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>My secondary user permissions:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/web_ui-ha_user.png" alt="Screenshot showing the secondary/home-assistant user and its entitlements on the camera web UI" />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;p>As Home Assistant really does not expose a ton of debugging information, I tried the secondary user credentials with the &lt;a href="https://play.google.com/store/apps/details?id=net.biyee.onvifer&amp;amp;hl=en_US&amp;amp;gl=US">&lt;code>Onvifer&lt;/code>&lt;/a> app. The debugging logs from that app confirmed that only the &lt;code>admin&lt;/code> credential set &amp;lsquo;worked&amp;rsquo; with ONVIF.&lt;/p>
&lt;p>After a bit more research, it turns out that I&amp;rsquo;m not the first person to discover this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/forum01.png" alt="Screenshot showing a post on the amcrest support forums where other people have noticed the lack of multi-user authentication for ONVIF authentication" />
&lt;figcaption>
&lt;p>
Source: https://amcrest.com/forum/ip-cameras-f18/firmware-security-bug-regarding-onvif--t13445-s10.html
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/forum02.png" alt="Screenshot showing a post on the amcrest support forums where other people have noticed the lack of multi-user authentication for ONVIF authentication" />
&lt;figcaption>
&lt;p>
Source: https://amcrest.com/forum/ip-cameras-f18/ip3m-941b-onvif-and-user-management-t12647.html
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Now i&amp;rsquo;m embarrassed that it took me so long to discover an issue that&amp;rsquo;s been documented since AT LEAST summer of 2019! 😳&lt;/p>
&lt;h3 id="password-length">Password length&lt;/h3>
&lt;p>Can we &lt;em>please&lt;/em> &lt;a href="https://security.stackexchange.com/questions/33470/what-technical-reasons-are-there-to-have-low-maximum-password-lengths">stop putting ceilings on password length&lt;/a>?&lt;/p>
&lt;p>Or, at least if you&amp;rsquo;re going to set an upper bound on password length, please make sure that:&lt;/p>
&lt;ul>
&lt;li>You&amp;rsquo;re consistent about enforcing the length&lt;/li>
&lt;li>You tell the user when their password is longer than allowed.&lt;/li>
&lt;/ul>
&lt;p>The very first time the default credentials are used to sign into the camera, you&amp;rsquo;re prompted to change the default password. Good! Only problem: the password generated by my password was, apparently, longer than the camera supports. The new admin password was &lt;em>&lt;strong>silently&lt;/strong> truncated&lt;/em> as I was logged in.&lt;/p>
&lt;p>I didn&amp;rsquo;t realize that the password stored in the manager wouldn&amp;rsquo;t let me in until after the camera applied it&amp;rsquo;s FW update and rebooted. After a factory reset, I figured out what happened.&lt;/p>
&lt;p>The &lt;code>maxlength&lt;/code> property of the login form differs from the password set form. In any case, there&amp;rsquo;s no warning that the input exceeds the length!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/pw_login.png" alt="Screenshot showing the HTML for the password field on the login page" />
&lt;figcaption>
&lt;p>
...
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/pw_reset.png" alt="Screenshot showing the HTML for the password field on the password reset page" />
&lt;figcaption>
&lt;p>
...
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>&lt;em>sigh&lt;/em>&lt;/p>
&lt;h2 id="tldr">TL;DR:&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>It&amp;rsquo;s almost 2021, but we still have IP Cameras shipping with 2011&amp;rsquo;s security issues. &lt;strong>Absolutely&lt;/strong> do not expose your IP Cameras directly to the internet or otherwise allow them to contact the internet. Keep cameras on their &lt;em>own&lt;/em> dedicated and isolated network and consider the admin credentials for the camera to be compromised. Seriously re-consider using WiFi for your cameras.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>If you&amp;rsquo;re trying to use the &lt;a href="https://www.home-assistant.io/integrations/onvif/">Home Assistant ONVIF integration&lt;/a> to control an &lt;code>Amcrest IP4M-1051&lt;/code>, you must use the &lt;code>admin&lt;/code> credentials and change the port from &lt;code>5000&lt;/code> to &lt;code>80&lt;/code>.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>The first bit of documentation you see when unboxing the camera is this little guy:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/11/amcrest-ip-cameras-security-isnt-a-feature-its-a-punchline/images/unboxing_security_warning.jpg" alt="Picture of an ironic leaflet urging the customer to use long, complex passwords and up to date firmware." />
&lt;figcaption>
&lt;p>
This is *literally* the first thing you see when unpacking the camera.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>which reads:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">IMPORTANT SECURITY NOTICE
Please make sure your device has the
latest firmware as listed on:
www.amcrest.com/firmware-subscribe
Never use the default password for
your device. Always ensure your
password contains a combination
of lowercase and uppercase
characters and numbers.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>A for effort, though, Amcrest! 👏🌟&lt;/p>
&lt;p>🙃&lt;/p></description></item><item><title>Two Tasmota rules</title><link>https://karlquinsland.com/2020/11/two-tasmota-rules/</link><pubDate>Fri, 20 Nov 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/11/two-tasmota-rules/</guid><description>&lt;p>&lt;a href="https://tasmota.github.io/">Tasmota&lt;/a> is an incredibly powerful alternative/open source firmware for the ever popular Espressif family of WiFi equipped microcontrollers.
This does not need to be another post espousing it&amp;rsquo;s many awesome qualities, so just trust me on this; Tasmota is AWESOME.&lt;/p>
&lt;p>Tasmota supports user configurable &lt;a href="https://tasmota.github.io/docs/Rules/">rules&lt;/a> which are simple commands wired into various device triggers.
In short; a device running Tasmota gains some autonomy to react to events without needing to report the event to, and wait for commands from, a remote server.&lt;/p>
&lt;p>I find the rules syntax to be a bit awkward and the list of practical examples feels like autodoc with a few practical examples sprinkled in.
I have &lt;em>never&lt;/em> been able to craft a Tasmota rule without also consulting the list of &lt;a href="https://tasmota.github.io/docs/Commands/">commands&lt;/a>
and doing a few searches through the github issues looking for issues/questions similar to mine.&lt;/p>
&lt;p>This post is a simple &amp;ldquo;here&amp;rsquo;s how i did it&amp;rdquo; that I wish I had found when I needed to solve the problem.
Hopefully this will save you some trouble!&lt;/p>
&lt;h3 id="mr-coffee">Mr. Coffee&lt;/h3>
&lt;p>A $15 &amp;lsquo;&lt;a href="https://tasmota.github.io/docs/devices/Sonoff-Pow/">smart relay&lt;/a>&amp;rsquo; is all that&amp;rsquo;s needed to turn a simple drip-over coffee maker into a remote-controllable coffee maker.
Immediately, you gain the ability to start brewing coffee in the morning from bed.
With a little extra integration work, start brewing coffee 10 minutes before your alarm is scheduled to go off. Simple quality of life improvement!&lt;/p>
&lt;p>Every coffee maker has at least one safety interlock to disable the heating element if it gets too hot, but some have additional interlocks. Specifically,
my coffee maker has two more interlocks in series with the heating element; if the carafe is removed or the water tank is empty, the circuit is broken and
the heater immediately stops producing heat. From the perspective of the smart relay, the power consumption is either 0 Watts or a bit over 1100 Watts.&lt;/p>
&lt;p>I was not comfortable using Home Assistant to monitor power consumption and then toggle the relay off after observing an interlock kick in.
If something happened to the WiFi connection or the MQTT server or Home Assistant, there&amp;rsquo;s no way to disconnect power from the coffee maker; the relay will stay &amp;lsquo;on&amp;rsquo;.
If the interlock failed, somehow, the heating element would immediately begin pumping out heat when it &lt;em>really&lt;/em> shouldn&amp;rsquo;t be!&lt;/p>
&lt;p>Writing a simple &amp;ldquo;if power consumption drops below 1100 Watts, turn relay off&amp;rdquo; rule would be enough, except there&amp;rsquo;s no way to distinguish between the thermal interlock tripping
and the carafe being removed for a quick pour. The simple rule is incompatible with the extra interlocks; it will prematurely send the brewing 100% of the time the carafe is removed.
If you want to pour a cup of coffee while it&amp;rsquo;s still brewing, this is rather inconvenient.&lt;/p>
&lt;p>Solution: give the user 30 seconds to return the carafe during brewing before turning the relay off.&lt;/p>
&lt;p>From the perspective of the outlet, ignore any lulls in power consumption as long as they&amp;rsquo;re shorter than 30 seconds. Otherwise, assume that an interlock &lt;em>has&lt;/em> tripped.&lt;/p>
&lt;p>This is implemented with two rules:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">Rule1
# When relay1 (heater) is turned on, activate rule2
ON Power1#state=1 DO Rule2 1 ENDON
# and deactivate rule2 when the heater is turned off
ON Power1#state=0 DO Rule2 0 ENDON
# When Timer1 expires, turn the heater off
ON Rules#Timer=1 DO Power1 off ENDON
# When the current used by the heating element rises above 1 Amp, disable Timer1
ON Energy#Current&amp;gt;1 DO RuleTimer1 0 ENDON
# ... and enable rule 2
ON Energy#Current&amp;gt;1 DO Rule2 1 ENDON
Rule2
# Wait for power use to drop to 0; start counting down
ON Energy#Current&amp;lt;.2 DO RuleTimer1 30 ENDON
# and disable rule2 so the timer is not constantly reset
ON Energy#Current&amp;lt;.2 DO Rule2 0 ENDON
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I chose &lt;code>.2&lt;/code> Amps as the trigger, but the logic works the exact same way with Power / Wattage.&lt;/p>
&lt;h2 id="electric-kettle">Electric Kettle&lt;/h2>
&lt;p>I wanted to detect when my electric kettle was done boiling the water so I could play a sound and flash the lights in whichever room I happened to be in at the time.
This is trivial to do with a &amp;lsquo;&lt;a href="https://tasmota.github.io/docs/devices/Sonoff-S31/">smart outlet&lt;/a>&amp;rsquo; and a &lt;a href="https://www.home-assistant.io/integrations/binary_sensor.template/">template sensor&lt;/a> in Home Assistant:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">- &lt;span style="font-weight:bold">platform&lt;/span>: template
&lt;span style="font-weight:bold">sensors&lt;/span>:
&lt;span style="font-weight:bold">kettle_running&lt;/span>:
&lt;span style="font-weight:bold">friendly_name&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Kettle Boiling&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># If the kettle is using more than 5w, assume its on / boiling water&lt;/span>
&lt;span style="font-weight:bold">icon_template&lt;/span>: &amp;gt;-&lt;span style="font-style:italic">
&lt;/span>&lt;span style="font-style:italic"> {% if states(&amp;#39;sensor.kettle_energy_power&amp;#39;) | float &amp;gt; 5 %}
&lt;/span>&lt;span style="font-style:italic"> mdi:kettle-steam
&lt;/span>&lt;span style="font-style:italic"> {% else %}
&lt;/span>&lt;span style="font-style:italic"> mdi:kettle
&lt;/span>&lt;span style="font-style:italic"> {% endif %}&lt;/span>
&lt;span style="font-weight:bold">value_template&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{{states(&amp;#39;sensor.kettle_energy_power&amp;#39;) | float &amp;gt; 5}}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Only problem, Tasmota only publishes the kettle&amp;rsquo;s power once every 300 seconds. This means &lt;code>sensor.kettle_energy_power&lt;/code> only gets updated every 300s which makes it really hard
to fire off a &lt;em>timely&lt;/em> notification when the kettle is done.
The &amp;lsquo;brute-force&amp;rsquo; solution is to configure Tasmota to transmit the telemetry &lt;a href="https://github.com/arendst/Tasmota/issues/2567">continuously&lt;/a>.
Except there&amp;rsquo;s no need for the Tasmota device on the kettle to be constantly informing Home Assistant that there&amp;rsquo;s no power being used whenever the kettle is not on; my application only cares about the &amp;lsquo;&lt;a href="https://en.wikipedia.org/wiki/Signal_edge">falling edge&lt;/a>&amp;rsquo;.&lt;/p>
&lt;p>Borrow the trigger from the &lt;a href="#mr-coffee">Mr. Coffee&lt;/a> rule and shorten the &lt;a href="https://tasmota.github.io/docs/Commands/#teleperiod">telemetry period&lt;/a> only when the kettle
is consuming more than 1 Watt. Like the coffee maker, it&amp;rsquo;s either consuming 0 Watts or about 1.1 Kilowatt.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">Rule1
on ENERGY#Power&amp;gt;1 do Backlog TelePeriod 10; Rule2 1 endon
Rule2
on ENERGY#Power=0 do Backlog TelePeriod 1; Rule2 0 endon
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As soon as the kettle starts using more than 1 Watt, configure Tasmota to publish its sensor data every 10 seconds.
I&amp;rsquo;ll get notified that the water is boiling within 10s; much better than 300s!
Once the power consumption goes back down to 0, reset the telemetry update period and disable the rule.&lt;/p>
&lt;p>The second rule must be disabled to prevent constant triggering of the rule when the kettle is not boiling.
Without the &lt;code>Rule2 0&lt;/code>, the console/logs for the device would be full of statements like this repeating every few seconds:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">RUL: ENERGY#POWER&amp;gt;1 performs &amp;#34;TelePeriod 10&amp;#34;
MQT: stat/tasmota_kettle/RESULT = {&amp;#34;TelePeriod&amp;#34;:10}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Hope that helped!&lt;/p></description></item><item><title>Enhanced Home Assistant Switch Plate (HASP)</title><link>https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/</link><pubDate>Thu, 01 Oct 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/</guid><description>&lt;p>The &lt;a href="https://github.com/aderusha/HASwitchPlate/">HASwitchPlate&lt;/a> project by &lt;code>aderusha&lt;/code> is brilliant. He&amp;rsquo;s managed to arrange some relatively cheap commodity hardware into a package that conveniently fits into a prime location for interacting with Home Automation - the light switch. The entire package sips power off of the already present mains wiring and connects to any MQTT broker via the esp8266 chip. As the HASP was designed to be used with Home Assistant, the humble 2.4 inch LCD transforms into an accessible control surface for an incredibly powerful home automation platform!&lt;/p>
&lt;p>Within moments of discovering the project and browsing through a few examples, my mind ran wild with possibilities. After double checking the relatively low &lt;a href="https://github.com/aderusha/HASwitchPlate#bill-of-materials">B.O.M.&lt;/a> cost,&lt;/p>
&lt;p>While shopping for the parts to make my own version, I got a few ideas.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/installed.jpg" alt="Picture showing modified HASP installed, LCD indicated the colors of the LEDs" />
&lt;figcaption>
&lt;p>
If the LEDs weren&amp;#39;t on, you&amp;#39;d never know they were there 😊
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="modifications">Modifications&lt;/h2>
&lt;p>First, a brief word about indemnification:&lt;/p>
&lt;blockquote>
&lt;p>All instructions and information on this page is purely for informational purposes.&lt;/p>
&lt;p>The original HASP and my modifications come with neither an expressed or implied warranty. By constructing your own, you assume all risk.&lt;/p>
&lt;/blockquote>
&lt;h3 id="software">Software&lt;/h3>
&lt;p>The few software modifications I&amp;rsquo;ve made to the HASP project are relatively small and don&amp;rsquo;t implement anything significant or new; they are &amp;lsquo;quality of life&amp;rsquo; improvements that target small portions of the code.&lt;/p>
&lt;p>I strongly believe that the hardest part of using a given piece automation technology should be taking it out of the box. To wit, Home Assistant has robust - &lt;a href="https://community.home-assistant.io/t/ability-to-set-entity-icon-through-mqtt-discovery/224538">but not perfect&lt;/a> - support for &lt;a href="Https://www.home-assistant.io/docs/mqtt/discovery/">automatic device discovery and configuration via MQTT&lt;/a>. Once a device has connected to the MQTT broker, it simply publishes a document detailing how HA should interface with the device. It&amp;rsquo;s a wonderful experience to see a new device connect to the network for the first time and just a few seconds later the new device is registered in HA, waiting for you to start integrating it into automations 🤩🤤.&lt;/p>
&lt;p>While there are quite a few sensors/stateful-attributes in the original HASP code, none of them automatically present themselves to Home Assistant 😔. I set about fixing that to the best of my abilities. Unfortunately, the LCD backlight is the only peripheral that could be &amp;lsquo;upgraded&amp;rsquo; to automatic configuration without making a ton of changes to the original code base.&lt;/p>
&lt;p>All of the hardware modifications detailed below automatically configure themselves with Home Assistant.&lt;/p>
&lt;p>The original HASP code base uses allocates too little memory for storing MQTT credentials. Any username or password longer than 31 bytes/characters would be &lt;strong>silently&lt;/strong> truncated on save. Despite the &amp;lsquo;credentials saved, rebooting&amp;rsquo; message, the next screen was always a &amp;lsquo;failure to connect&amp;rsquo; message. Frustrating! The pull request to address this is &lt;a href="https://github.com/aderusha/HASwitchPlate/pull/117">here&lt;/a>.&lt;/p>
&lt;h3 id="hardware">Hardware&lt;/h3>
&lt;p>The HASP does support dimming the LCD, but it has no awareness of ambient light levels. This makes it rather difficult to deploy a HASP in any &amp;lsquo;light sensitive&amp;rsquo; location like a bedroom or media room without another device to cue Home Assistant and lower the LCD brightness. Workable, but too high friction to be ideal.&lt;/p>
&lt;p>Light Dependent Resistors - &lt;a href="https://en.wikipedia.org/wiki/Photoresistor">LDR&lt;/a> for short - are a very cheap and compact way to get an approximate light level. Fortunately, the analogue pin is broken out on the &lt;a href="https://github.com/aderusha/HASwitchPlate/tree/master/PCB">PCB&lt;/a> so a simple &lt;a href="https://en.wikipedia.org/wiki/Voltage_divider#Resistive_divider">resistive divider&lt;/a> and a few lines of code are all that&amp;rsquo;s needed to get a a number that linearly correlates to the level of light hitting the face plate.&lt;/p>
&lt;p>It just so happens that there is &lt;em>just enough&lt;/em> room to fit a LDR beneath the surface of the decor plate and out of the way of the LCD. As (not) shown in the picture above, there is no way to tell that the LDR is embedded beneath the surface.&lt;/p>
&lt;p>The range of values from the LDR isn&amp;rsquo;t great, but they are adequate enough to reliably detect if the HASP is in a darkened room.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/ldr-graph.jpg" alt="Screenshot depicting graph of LDR values, rising over time. Annotated to indicate sharp rise in brightness right around sunrise" />
&lt;figcaption>
&lt;p>
ignore the spikes just before noon, those are due to to testing with a flash light
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>While researching potential ways to measure the ambient brightness, I stumbled across the &lt;a href="https://shop.homeseer.com/products/z-wave-dimmer-switch">HomeSeer HS-WD200+&lt;/a> which features a rather novel way to convey additional information to a user; seven RGB leds 😍. It&amp;rsquo;s a brilliant use of such a simple and ubiquitous technology that I&amp;rsquo;m not really sure why every smart switch doesn&amp;rsquo;t do this!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/HS-WD200-Modes.jpg" alt="Picture showing tools/materials required for assembly" />
&lt;figcaption>
&lt;p>
HomeSeer&amp;#39;s WS200 has a delightful innovation... RGB LEDs!
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>With &lt;em>zero&lt;/em> room to spare, four LEDs can fit into a small cavity between the LCD and decor plate surface. Like with the LDR, there is no visual &amp;lsquo;tell&amp;rsquo; that there are LEDs beneath the surface&amp;hellip; unless they&amp;rsquo;re on, of course.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/prototype-leds.jpg" alt="Picture showing a prototype HASP with LEDs embedded beneath the surface and powered on" />
&lt;figcaption>
&lt;p>
Ignore the dirt on the switch. Notice how you can&amp;#39;t tell there&amp;#39;s an LDR beneath the surface
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h4 id="the-enclosure">The enclosure&lt;/h4>
&lt;p>Without consuming more than 1 &lt;a href="https://diy.stackexchange.com/questions/11654/what-does-1-gang-2-gang-and-so-forth-mean-when-talking-about-electrical-bo">gang&lt;/a>, the only realistic way to get the wires for the new components to the HASP PCB is to go around the edge of the LCD&amp;rsquo;s PCB. This is accomplished with two small &amp;lsquo;channels&amp;rsquo; that slightly protrude in the vertical directions from the lip around the LCD and into the box that encloses the electronics.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/CAD-channel-profile.jpg" alt="Screenshot of Fusion360, showing side profile of HASP, annotated to indicate channels in enclosure for wires leading to LED tape, LDR in relation to LCD" />
&lt;figcaption>
&lt;p>
Section analysis from f360 showing small channels around the LCD for wires to LDR and LEDs
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Additionally, I found that the original printed parts do not properly fit in the &lt;a href="https://www.amazon.com/Thomas-Betts-B232A-UPC-Carlon-Bulk/dp/B000GAWYZ8/">two gang electrical box&lt;/a> where I intended to deploy the HASP.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/electric-box-clearance.jpg" alt="Closeup photograph of prototype HASP enclosure and 2-gang electric box. Annotated to show interfering surfaces" />
&lt;figcaption>
&lt;p>
The only way to fit the HASP in my 2-gang electric boxes is to cut out a small section
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>In total, the modifications required to accommodate the LDR and LED tape are relatively small, but &lt;a href="https://github.com/aderusha/HASwitchPlate/issues/116">I had to re-create the model from scratch&lt;/a> so several things are likely a bit different from the original model. It should be relatively easy to port the modifications to the other multi-gang configurations that the original HASP supports.&lt;/p>
&lt;p>The &lt;code>.step&lt;/code> and &lt;code>.f3z&lt;/code> files are available should you want to make the necessary modifications to other switch plate configurations.
The &lt;code>.stl&lt;/code> and &lt;code>.3mf&lt;/code> files are available for easy printing.&lt;/p>
&lt;p>All files available &lt;a href="#files">below&lt;/a> and on &lt;a href="https://github.com/kquinsland/HASwitchPlate/tree/master/3D_Printable_Models/enhanced-HASP">github&lt;/a>.&lt;/p>
&lt;h2 id="assembly">Assembly&lt;/h2>
&lt;p>The steps below are meant to be followed between the original steps &lt;a href="https://github.com/aderusha/HASwitchPlate/blob/master/Documentation/03_Electronics_Assembly.md">&lt;code>03_Electronics_Assembly&lt;/code>&lt;/a> and &lt;a href="https://github.com/aderusha/HASwitchPlate/blob/master/Documentation/04_Project_Enclosure.md">&lt;code>04_Project_Enclosure&lt;/code>&lt;/a>.&lt;/p>
&lt;p>In short, you&amp;rsquo;ll want to assemble and test the HASP PCB as in the original instructions, but use the steps below as a substitute for the enclosure assembly process.&lt;/p>
&lt;h3 id="additional-materials">Additional Materials&lt;/h3>
&lt;p>In addition to everything in the original BOM, you&amp;rsquo;ll need:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>A LDR. Be aware that LDRs come in many different shapes and sizes and have different resistance values. Space is rather tight, so the form factor matters a lot more than the resistance values or band of light that the LDR responds to. If you use a different LDR, you may need to adjust the resistor value to better match your LDR. You can get 50 of the exact model GL5516 that I used for less than $2 &lt;a href="https://s.click.aliexpress.com/e/_dUjV8Rn">here&lt;/a>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>A 10KΩ resistor to form a simple resistive divider with the LDR. This will better map the the full range of the LDR to the 0-1 volt range that the ESP8266 ADC uses. Space is rather limited so the smaller the resistor, the better; no need for anything larger than 1/4 Watt. You can get a 10-pack of 10KΩ resistors &lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2F10-Pcs-1-8-Watt-1-Metal-Film-Resistor-Choose-you-own-values-USA-SELLER%2F302971259661&amp;amp;campid=5338745533&amp;amp;toolid=10001&amp;amp;customid=">here&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>WS2812B LED tape &lt;strong>featuring the 3535SMD package&lt;/strong>. The &amp;lsquo;regular size&amp;rsquo; LED package &lt;em>will &lt;strong>not&lt;/strong> fit&lt;/em> so make sure you use the smaller &lt;code>3535SMD&lt;/code> package! Beyond that, aim for LED tape that is no wider than ~8mm and has highest density possible. After quite some searching, the best that I could find is 8mm wide tape with a density of 144 LEDs per meter. Unfortunately, they don&amp;rsquo;t sell LEDs 4 at a time, so you can pick up 1 meter of the exact LEDs I used &lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2FNarrow-DC-5V-WS2812B-Led-Strip-Individually-Addressable-WS2812-Led-pixel-Light%2F254647279915%3Fhash%3Ditem3b4a29212b%3Ag%3A9D8AAOSwIZ5fBTn7&amp;amp;campid=5338745533&amp;amp;toolid=10001&amp;amp;customid=pixel_tape">here&lt;/a>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Several centimeters of very fine gauge wire. Ideally, multiple colors so you can keep organized but this is not required. Again, space is rather tight, so AWG 28 or 30 is ideal. Much bigger than that and you&amp;rsquo;ll likely have issues fitting everything together. You can get a 1m length of multiple colors &lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2FNarrow-DC-5V-WS2812B-Led-Strip-Individually-Addressable-WS2812-Led-pixel-Light%2F254647279915%3Fhash%3Ditem3b4a29212b%3Ag%3A9D8AAOSwIZ5fBTn7&amp;amp;campid=5338745533&amp;amp;toolid=10001">here&lt;/a>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>HeatShrink Tubing (HST). The exact diameter needed will depend on how compact your soldering is and the size of resistor used. Multiple colors will help keep things organized, but that&amp;rsquo;s not required. I suggest a kit so you can get the perfect diameter and length. You can get a kit &lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2F360pcs-2-1-Heat-Shrink-Tube-Tubing-Sleeving-Wrap-Wire-cable-Insulated-Assorted%2F224122863249%3Fhash%3Ditem342ec37e91%3Ag%3AMbcAAOSwXGhfPCNK&amp;amp;campid=5338745533&amp;amp;toolid=10001">here&lt;/a>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Standard 2.54mm pin headers. You can get a set of male and female headers &lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2F10pcs-Male-Header-1x40-2-54mm-40-Pin-PCB-Through-Hole-Arduino-and-Pi%2F223105297271%3Fepid%3D28022683725%26hash%3Ditem33f21cab77%3Ag%3A~X8AAOSwvFpbdZWA&amp;amp;campid=5338745533&amp;amp;toolid=10001">here&lt;/a>.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/00.prep-electronics.jpg" alt="Picture showing the additional electronic components for mod" />
&lt;figcaption>
&lt;p>
All the components needed for assembly
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>&lt;strong>Note&lt;/strong>: Where possible, I&amp;rsquo;ve used commission links. The links don&amp;rsquo;t raise the price of any item, they simply let the retailer know that I&amp;rsquo;m the reason for your business. In return, I get a small cut of your purchase as a &amp;lsquo;thanks&amp;rsquo; from the retailer. If you&amp;rsquo;re not comfortable with that, you can use a URL unwinding service to get the &amp;lsquo;raw&amp;rsquo; product link and drop the attribution/commission part.&lt;/p>
&lt;h3 id="brass-inserts">Brass inserts&lt;/h3>
&lt;p>The original instructions suggest using glue to secure the brass inserts to the face plate, but I suggest using either a lighter or a very fine tip soldering iron to heat up the brass insert. A hot insert will melt the surrounding plastic which will make for a much stronger joint. The modified version of the HASP face plate used in this guide intentionally features holes slightly too small for the brass inserts so glue won&amp;rsquo;t be enough.&lt;/p>
&lt;p>Fully insert the 20mm screw into the brass insert, use pliers to grasp the screw and apply heat with a lighter for a few seconds and then insert into the face plate. Make sure that the screw is &lt;strong>completely&lt;/strong> inserted into the insert so that molten plastic can&amp;rsquo;t flow into the insert. If molten plastic enters and cools on the threads, it will be rather difficult to later screw things together!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/01.prep-brass-inserts.jpg" alt="Picture showing a 20mm screw fully inserted into brass threaded insert" />
&lt;figcaption>
&lt;p>
Molten plastic can&amp;#39;t flow into a filled insert
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>As the inserts cool, you&amp;rsquo;ll have a few seconds to make adjustments to their orientation before they become fixed. Make sure that each screw is vertical and cool to the touch before moving on to the wiring harness.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/02.inserts-cooling.jpg" alt="Picture showing threaded inserts inserted into faceplate with screws sticking out, pointed vertically" />
&lt;figcaption>
&lt;p>
screws make it easy to perform final alignment on inserts and act as a heatsink
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h3 id="wire-harness">Wire Harness&lt;/h3>
&lt;p>There are only six wires for the two components and the LED tape is the only component where polarity matters. A table mapping each pin on the HASP PCB to each component lead is below.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>HASP PCB Pin&lt;/th>
&lt;th>Component&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>GND&lt;/td>
&lt;td>LED Tape, 10KΩ resistor&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>+5V&lt;/td>
&lt;td>LED Tape VCC in&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>+3.3V&lt;/td>
&lt;td>LDR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>A0&lt;/td>
&lt;td>LDR &amp;amp; 10KΩ resistor junction&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>D0&lt;/td>
&lt;td>N/A&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>D1&lt;/td>
&lt;td>LED Tape CLK/DTA in&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>D2&lt;/td>
&lt;td>N/A&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DBG&lt;/td>
&lt;td>N/A&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>You are &lt;strong>strongly&lt;/strong> encouraged to test / check your work after each step with a simple multimeter. Complete assembly involves irreversible steps, like shrinking HST. If you make a mistake, it&amp;rsquo;s best to catch it before &amp;lsquo;finalizing&amp;rsquo; things as you&amp;rsquo;re almost certainly going to have to destroy the component and or wiring harness to repair it.&lt;/p>
&lt;p>Additionally, you can flash my &lt;a href="https://github.com/kquinsland/HASwitchPlate">modified HASP firmware&lt;/a> to a fully assembled HASP device and use that as a testing device. On boot up, the modified firmware briefly flashes each LED in sequence. About every 10 seconds after boot, the LDR value will be read and published to MQTT. Cover the LDR with your hand and check your MQTT broker or HA to confirm that the value changes significantly between exposed and covered states.&lt;/p>
&lt;h5 id="ldr">LDR&lt;/h5>
&lt;p>Fit the LDR into the face plate and position the leads in the channel under and to the top of the LCD PCB. Then trim the excess length off of the LDR leads so that they extend &amp;lsquo;beyond&amp;rsquo; the LCD by about 8mm or so.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/03.ldr-position.jpg" alt="Picture showing the LDR in position under the LCD with it&amp;#39;s leads trimmed slightly" />
&lt;figcaption>
&lt;p>
LDR under the LCD w/ trimmed leads...
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Remove the LDR from the face plate and straighten the leads out. Lay the LDR, resistor, and wire out as shown below. Use this time to cut the HST down to size so everything but the leg of the LDR that joins the resistor can be covered. &lt;strong>Note:&lt;/strong> the leads on the resistor have also been trimmed down to ~15mm to better fit.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/04.wire-harness.jpg" alt="Picture showing rough layout of LDR and related components" />
&lt;figcaption>
&lt;p>
rough layout of LDR harness
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>It&amp;rsquo;s probably going to be easiest to start with the &amp;lsquo;supply&amp;rsquo; wire which runs directly from the HASP PCB&amp;rsquo;s +3.3v pin to the LDR. As space is exceedingly tight, there is no room for overly large solder joints. Carefully wrap the wire around the lead and apply just enough solder to make good electrical contact. Once the supply wire has been soldered to the LDR, affix the HST so the entirety of the lead and solder joint are protected.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/05.ldr-wire-wrap.jpg" alt="picture showing wire wrapped around the lead of LDR prior to soldering" />
&lt;figcaption>
&lt;p>
strip ~1cm off the end of the wire, wrap around the lead, then solder
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Repeat the same procedure with the lead of the resistor that will go directly to the ground. Affix the HST after the solder joint has cooled.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/06.ldr-ground.jpg" alt="picture showing sire soldered to the &amp;#39;ground-facing&amp;#39; lead of the 10k resistor with heat shrink tubing about to be applied" />
&lt;figcaption>
&lt;p>
No room for mechanically strong solder joints
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Use the same &amp;lsquo;wrap&amp;rsquo; technique with the remaining leads from the LDR and the resistor. Apply just enough solder for good electrical contact between the signal wire and the two leads of the LDR and resistor.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/07.ldr-signal.jpg" alt="picture showing wire wrapped around the LDR and 10K resistor leads" />
&lt;figcaption>
&lt;p>
same wrapping technique, just with two leads this time
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>After the solder joint cools, cover the entire LDR/Resistor assembly in HST so there is no exposed wire or component lead.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/08.hst.jpg" alt="Picture showing rough layout of LDR and related components" />
&lt;figcaption>
&lt;p>
get everything nicely protected behind HST
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Set the LDR component aside for now and move on to the LED tape.&lt;/p>
&lt;h5 id="leds">LEDs&lt;/h5>
&lt;p>If you&amp;rsquo;ve not already trimmed the LED tape to fit in the face plate, do so now. Leave yourself as much room as needed to solder on the one side where you&amp;rsquo;ll need to feed power and data in.&lt;/p>
&lt;p>The LED tape has incredibly small pads so take your time on this. You have about 5 cubic millimeters &lt;em>total&lt;/em> for the three solder joints on the LED tape. Solder just enough for electrical contact, there will be no significant mechanical stress. &lt;strong>Note:&lt;/strong> The arrows printed on the strip point in the direction of data flow; combined with the off-center placement of the LED packages, there is only one way to properly install the LED tape in the decor plate.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/09.wire-alignment.jpg" alt="picture showing wire lined up with one solder pad on the LED tape " />
&lt;figcaption>
&lt;p>
know which way the LED tape wires will need to point to make it into the &amp;#39;channel&amp;#39; prior to soldering
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>After soldering the power, signal and ground wires, flatten them and gently shape them so they align and flow into the channel on the face plate in a manner similar to the LDR. For a bit of mechanical robustness, consider braiding the wires together.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/10.twisted-cable.jpg" alt="picture showing three wires from LED tape carefully braised together for a more compact and stronger cable" />
&lt;figcaption>
&lt;p>
twist the wires together for a more compact and robust cable
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h5 id="pin-header">Pin Header&lt;/h5>
&lt;p>After soldering wires onto the two components, all that&amp;rsquo;s left is soldering the wires to the correct pins on the pin header.&lt;/p>
&lt;p>One at a time, carefully take the pins out of the plastic &amp;lsquo;frame&amp;rsquo;. This is to prevent the heat from the soldering and HST steps from melting the plastic. Consider marking the pin with the location of the &amp;lsquo;frame&amp;rsquo; so you don&amp;rsquo;t take up too much room with the solder joint. You will need the &amp;lsquo;business end&amp;rsquo; of the pin to make good contact with the socket on the HASP board; this is quite difficult if most of the pin can&amp;rsquo;t be slid through the &amp;lsquo;frame&amp;rsquo; because of an excessively large solder joint!&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/11.process.jpg" alt="picture showing single pin removed from pin header, about to be soldered" />
&lt;figcaption>
&lt;p>
remove the pin from the plastic &amp;#39;frame&amp;#39; and carefully solder the wires to the pins
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Make sure that HST is on the wire(s) &lt;em>before&lt;/em> soldering! After the solder joint cools, slip the HST over the solder joint and apply heat until the joint is covered. Repeat this process for the remaining pins. There will be three &amp;lsquo;unused&amp;rsquo; pins that you can just ignore.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/12.unused-pins.jpg" alt="picture showing the unused pins in the wire harness" />
&lt;figcaption>
&lt;p>
A few pins are not needed
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>When all the wires have been soldered and covered, you&amp;rsquo;ll have something that looks like this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/13.harness-finished.jpg" alt="picture showing each component in the decor plate and the finished wiring harness." />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;p>Double check electrical connections and then combine the PCB, enclosure, plate and harness. Carefully align the &amp;lsquo;channels&amp;rsquo; for LDR and LED wires:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/14.finished.jpg" alt="picture of finished assembly ready to be screwed together. Annotated to call attention to pinch points w/ wires" />
&lt;figcaption>
&lt;p>
Align and ensure no pinched wires!
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h3 id="printing">Printing&lt;/h3>
&lt;p>In the electrical boxes there&amp;rsquo;s absolutely no room to spare, so all parts are designed to fit together with &lt;strong>very&lt;/strong> tight clearances. Print as slow as you need to in order too achieve very good dimensional accuracy. Like with the brass inserts, the various screw holes are intentionally undersized for better thread engagement.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/suggested-print.jpg" alt="Screenshot showing modified enclosure files in slicer for 3d printer" />
&lt;figcaption>
&lt;p>
The obvious orientation is the best, no supports needed
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>The HASP does run a bit warm, but not any warmer than other smart switches with similar form-factor. PLA will likely be fine unless you in tend to deploy the HASP in a particularly hot location.&lt;/p>
&lt;h4 id="thermals">Thermals&lt;/h4>
&lt;p>In testing, the parts of the HASP ran ~20º above ambient. Most of that heat comes from the small AC-&amp;gt;DC converter and the LCD. Surprisingly, the ESP8266 does not emit that much heat. Overall, nothing particularly alarming, especially when the HASP is deployed into a larger multi-gang electrical box with with plenty of air to radiate heat into. Apologies in advance for the mixed ºC/ºF units.&lt;/p>
&lt;p>&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/01.removed-side-rear.png" alt="photo from a thermal camera showing the HASP device removed from it&amp;#39;s electrical box, the sides and rear are warm" />
&lt;figcaption>
&lt;p>
HASP removed from electrical box, heat from the AC-DC converter radiating through the enclosure
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/02.removed-top-side.png" alt="photo from a thermal camera showing the HASP device removed from it&amp;#39;s electrical box, the sides and rear are warm" />
&lt;figcaption>
&lt;p>
similar to first picture, parts inside enclosure radiate heat through the enclosure, bringing it to about 20 degrees above ambient temperature
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/03.removed-rear-side.png" alt="photo from a thermal camera showing the HASP device removed from it&amp;#39;s electrical box, the sides and rear are warm" />
&lt;figcaption>
&lt;p>
there are clear hot-spots on the enclosure that match up with the location of the ESP and the AC-DC converter
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/04.front-leds-on.png" alt="photo from a thermal camera showing the HASP device installed in its electrical enclosure. The LCD and LEDs are the warmest part" />
&lt;figcaption>
&lt;p>
Less heat is radiated through the front of the HASP; the LCD backlight and embedded LEDs are clearly the warmest components
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>The tiny PNP transistor that toggles the LCD power is the hottest component, by far. Everything else has a relatively consistent temperature:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/05.internals.png" alt="photo from a thermal camera showing the internals of deployed HASP; the AC-&amp;gt;DC converter is clearly the warmest object" />
&lt;figcaption>
&lt;p>
PNP Transistor is clearly warmest internal component, ESP8266 cooler than expected
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>When installed in wall, the HASP is radiating heat into the electrical box and through neighboring switches:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/06.installed-markup.jpg" alt="photo from a thermal camera showing the HASP as deployed in wall. Heat is evenly radiated through LCD and through neighboring switch" />
&lt;figcaption>
&lt;p>
a little bit of ambient heat radiating through the gap between LCD and switch as well as through the switch
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="future-work">Future work&lt;/h2>
&lt;p>I did accomplish my two main goals:&lt;/p>
&lt;ol>
&lt;li>Ambient light sensor for more responsive backlight control&lt;/li>
&lt;li>HomeSeer-like LEDs for additional information display&lt;/li>
&lt;/ol>
&lt;p>However, there&amp;rsquo;s a few aspects of the HASP that i&amp;rsquo;d like to further improve:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Increased automatic configuration w/ the HASP. There&amp;rsquo;s still a non-trivial amount of work required to set up a HASP with Home Assistant. The HASP device has many different attributes that could be exposed to Home Assistant automatically. E.G.: The HASP will periodically check for a firmware update; the HASP should configure Home Assistant with a &lt;a href="https://www.home-assistant.io/integrations/binary_sensor.mqtt/#configuration">&lt;code>binary_sensor&lt;/code>&lt;/a> that indicates if there&amp;rsquo;s a firmware update available.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Some of the automations that live in Home Assistant to manage button presses / update screen content could probably be re-factored down to a few generic scripts and services.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The display uses a &lt;a href="https://forum.digikey.com/t/resistive-touch-vs-capacitive-touch-whats-the-difference/1063">resistive matrix&lt;/a> to detect touch events. Resistive screens, while cheap, are a bit finnicky and inferior to the more consistent and precise capacitive touch screen tech. If Nextion ever makes a capacitive version of the NX3224T024, then it would be an instant upgrade!&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Similarly, the viewing angle on the LCD is&amp;hellip; not great. The HASP, like most light switches, is at a convenient height for hands&amp;hellip; not eyes. If you&amp;rsquo;re standing relatively close to the HASP, you&amp;rsquo;ll be looking down at the screen with quite a steep angle. Depending on the current screen brightness and colors, this may result in a washed out and illegible screen.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Better LED diffusion. There&amp;rsquo;s not a lot of space for light pipes or similar, but I would like to find a better way of diffusing the LEDs. Or even to fit a masking layer between the LEDs and the plate, so the effect would be akin to a back-lit silhouette.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Effects for the LEDs. Right now, the LEDs only support on/off/brightness commands. Their ability to passively indicate information would be enhanced if Home Assistant could send &amp;lsquo;effect&amp;rsquo; commands, too. E.G.: Rather than HA having to send a constant stream of color/brightness commands to fade between blue, green, yellow, purple, simply send a &lt;code>fade(2s) blue, green, yellow, purple&lt;/code> command.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>There&amp;rsquo;s plenty of spare room on the HASP PCB for the 10KΩ resistor. This would simplify the creation of the wiring harness. I&amp;rsquo;ve been meaning to learn KiKad, this might be a very gentle way to start learning it. 🤔&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Enclose the LED tape 100% inside the HASP. This version works well and the small &amp;lsquo;hole&amp;rsquo; in the enclosure. I don&amp;rsquo;t think there&amp;rsquo;s any safety concern w/ the current design, but I&amp;rsquo;d still like to have the low voltage stuff 100% blocked off from thee electrical box&amp;hellip;&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="files">Files&lt;/h2>
&lt;p>For archive / posterity, all source files are included here. Unless otherwise explicitly stated otherwise, all files below are licensed as &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike&lt;/a> (CC BY-NC-SA).&lt;/p>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/CAD-channel-profile.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/CAD-channel-profile_huf3557e6811054f83d6c066da6e362a76_146168_300x0_resize_q75_box.jpg" width="300" height="125">
&lt;/a>
&lt;figcaption>
&lt;small>Section analysis from f360 showing small channels around the LCD for wires to LDR and LEDs&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/electric-box-clearance.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/electric-box-clearance_huf58d9f58f994f5fc3386c0ee9ba7741a_595046_300x0_resize_q75_box.jpg" width="300" height="205">
&lt;/a>
&lt;figcaption>
&lt;small>The only way to fit the HASP in my 2-gang electric boxes is to cut out a small section&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/00.prep-electronics.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/00.prep-electronics_hu840d6c90086eacc53afc6cd9854fffac_1921095_300x0_resize_q75_box.jpg" width="300" height="190">
&lt;/a>
&lt;figcaption>
&lt;small>All the components needed for assembly&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/01.prep-brass-inserts.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/01.prep-brass-inserts_hue99de1545ab1b4e8a1f78c703c7e00db_1778399_300x0_resize_q75_box.jpg" width="300" height="169">
&lt;/a>
&lt;figcaption>
&lt;small>Molten plastic can&amp;#39;t flow into a filled insert&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/02.inserts-cooling.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/02.inserts-cooling_hu07e3c61c34ed61160be3a79f859eb400_1929998_300x0_resize_q75_box.jpg" width="300" height="166">
&lt;/a>
&lt;figcaption>
&lt;small>screws make it easy to perform final alignment on inserts and act as a heatsink&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/03.ldr-position.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/03.ldr-position_hu1bd2ce9daf86385639d10876539024e3_676881_300x0_resize_q75_box.jpg" width="300" height="143">
&lt;/a>
&lt;figcaption>
&lt;small>LDR under the LCD w/ trimmed leads...&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/04.wire-harness.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/04.wire-harness_hu71b96d1a05e1df3ee64c3981ad9e6dab_2998591_300x0_resize_q75_box.jpg" width="300" height="169">
&lt;/a>
&lt;figcaption>
&lt;small>rough layout of LDR harness&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/05.ldr-wire-wrap.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/05.ldr-wire-wrap_hu8627bf47a5ae116ee04aa108e70ce56c_1254876_300x0_resize_q75_box.jpg" width="300" height="165">
&lt;/a>
&lt;figcaption>
&lt;small>strip ~1cm off the end of the wire, wrap around the lead, then solder&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/06.ldr-ground.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/06.ldr-ground_hu1349227ce5bc5caaad08db86e061dedc_1388792_300x0_resize_q75_box.jpg" width="300" height="155">
&lt;/a>
&lt;figcaption>
&lt;small>No room for mechanically strong solder joints&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/07.ldr-signal.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/07.ldr-signal_hua832255d5a7fcd256e6bb492f1e9737d_1115039_300x0_resize_q75_box.jpg" width="300" height="169">
&lt;/a>
&lt;figcaption>
&lt;small>same wrapping technique, just with two leads this time&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/08.hst.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/08.hst_hu31912292b23f492cd1f37e22c2d6d4b6_1058335_300x0_resize_q75_box.jpg" width="300" height="200">
&lt;/a>
&lt;figcaption>
&lt;small>get everything nicely protected behind HST&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/09.wire-alignment.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/09.wire-alignment_huaea1d9f1eb838c4ba15a2f7af33720a9_769321_300x0_resize_q75_box.jpg" width="300" height="212">
&lt;/a>
&lt;figcaption>
&lt;small>know which way the LED tape wires will need to point to make it into the &amp;#39;channel&amp;#39; prior to soldering&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/10.twisted-cable.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/10.twisted-cable_hue7b70705622f1f0b3e7232d9f9f0df37_600817_300x0_resize_q75_box.jpg" width="300" height="219">
&lt;/a>
&lt;figcaption>
&lt;small>twist the wires together for a more compact and robust cable&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/11.process.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/11.process_hu93074e0b3024e8cc13c2d7f3c0ac56dc_1111739_300x0_resize_q75_box.jpg" width="300" height="251">
&lt;/a>
&lt;figcaption>
&lt;small>remove the pin from the plastic &amp;#39;frame&amp;#39; and carefully solder the wires to the pins&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/12.unused-pins.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/12.unused-pins_hu5cd0461a68334d23deddf4b6a1294171_1162551_300x0_resize_q75_box.jpg" width="300" height="284">
&lt;/a>
&lt;figcaption>
&lt;small>A few pins are not needed&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/13.harness-finished.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/13.harness-finished_hua5b584d3ebb0e123f88cf8ccf1117216_1142587_300x0_resize_q75_box.jpg" width="300" height="311">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/14.finished.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/assembly/14.finished_hua77d1e2180bc67fbf65b06f051489a93_1426974_300x0_resize_q75_box.jpg" width="300" height="179">
&lt;/a>
&lt;figcaption>
&lt;small>Align and ensure no pinched wires!&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/installed.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/installed_hub2bf50855c95bbc45616a7cfcc63aa58_1018309_300x0_resize_q75_box.jpg" width="300" height="285">
&lt;/a>
&lt;figcaption>
&lt;small>If the LEDs weren&amp;#39;t on, you&amp;#39;d never know they were there 😊&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/ldr-graph.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/ldr-graph_hu593a76bffb994c11e5c98e7eb75552c2_40288_300x0_resize_q75_box.jpg" width="300" height="300">
&lt;/a>
&lt;figcaption>
&lt;small>ignore the spikes just before noon, those are due to to testing with a flash light&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/models/box.step">
&lt;i class="far fa-file-code">&lt;/i>
models/box.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/models/box.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/box.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/models/combined.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
models/combined.3mf:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/models/combined.step">
&lt;i class="far fa-file-code">&lt;/i>
models/combined.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/models/enhanced-HASP.f3z">
&lt;i class="far fa-file-">&lt;/i>
models/enhanced-HASP.f3z:
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/models/plate.step">
&lt;i class="far fa-file-code">&lt;/i>
models/plate.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/models/plate.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/plate.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/prototype-leds.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/prototype-leds_huc3855f28b218abee9b660598a6bb642d_522361_300x0_resize_q75_box.jpg" width="300" height="304">
&lt;/a>
&lt;figcaption>
&lt;small>Ignore the dirt on the switch. Notice how you can&amp;#39;t tell there&amp;#39;s an LDR beneath the surface&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/suggested-print.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/suggested-print_hu3026d7095368642cea18036c28f140af_772900_300x0_resize_q75_box.jpg" width="300" height="165">
&lt;/a>
&lt;figcaption>
&lt;small>The obvious orientation is the best, no supports needed&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/01.removed-side-rear.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/01.removed-side-rear_hue7f3e3fe323889e9523fde0d0b16fc09_27411_300x0_resize_box_3.png" width="300" height="400">
&lt;/a>
&lt;figcaption>
&lt;small>HASP removed from electrical box, heat from the AC-DC converter radiating through the enclosure&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/02.removed-top-side.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/02.removed-top-side_hu7f7deb0d48ada52e65cf9d07af4f2d7b_31528_300x0_resize_box_3.png" width="300" height="400">
&lt;/a>
&lt;figcaption>
&lt;small>similar to first picture, parts inside enclosure radiate heat through the enclosure, bringing it to about 20 degrees above ambient temperature&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/03.removed-rear-side.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/03.removed-rear-side_huaf7d1f0412acd7326b9fbe2292beafc4_27688_300x0_resize_box_3.png" width="300" height="400">
&lt;/a>
&lt;figcaption>
&lt;small>there are clear hot-spots on the enclosure that match up with the location of the ESP and the AC-DC converter&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/04.front-leds-on.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/04.front-leds-on_hu2ffecc7e561aeb7b1635133e11faf738_23402_300x0_resize_box_3.png" width="300" height="400">
&lt;/a>
&lt;figcaption>
&lt;small>Less heat is radiated through the front of the HASP; the LCD backlight and embedded LEDs are clearly the warmest components&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/05.internals.png">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/05.internals_huce2a4f8e97e3ddbdf2b0b78056c76aa4_20396_300x0_resize_box_3.png" width="300" height="400">
&lt;/a>
&lt;figcaption>
&lt;small>PNP Transistor is clearly warmest internal component, ESP8266 cooler than expected&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/06.installed-markup.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/thermals/06.installed-markup_hub6a44a9834fd9990d3b6fe92876c3a3b_20990_300x0_resize_q75_box.jpg" width="300" height="400">
&lt;/a>
&lt;figcaption>
&lt;small>a little bit of ambient heat radiating through the gap between LCD and switch as well as through the switch&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/HS-WD200-Modes.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/10/enhanced-home-assistant-switch-plate-hasp/images/HS-WD200-Modes_hu41c9204fb955c7bf61a99d537ead8f86_35404_300x0_resize_q75_box.jpg" width="300" height="300">
&lt;/a>
&lt;figcaption>
&lt;small>HomeSeer&amp;#39;s WS200 has a delightful innovation... RGB LEDs!&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>Adding an airborne particulate mater sensor to WS3 Weather Station</title><link>https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/</link><pubDate>Thu, 27 Aug 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/</guid><description>&lt;p>A while back, I &lt;a href="https://github.com/kquinsland/ws3-to-esphome-bridge/">posted a small bit of code&lt;/a> that could decode the data from the ubiquitous WS3 Weather Station and make it accessible to the amazing &lt;a href="https://www.home-assistant.io/">HomeAssistant&lt;/a> via the wonderful &lt;a href="https://esphome.io/">ESPHome&lt;/a> project. Since then, my weather station has been dutifully collecting data that&amp;rsquo;s been invaluable for augmenting automation that deals with indoor climate.&lt;/p>
&lt;p>As the numerous wild fires in California rage on, &lt;a href="https://www.forbes.com/sites/ericmack/2020/08/21/wildfire-smoke-blankets-the-west-as-california-records-worlds-worst-air-quality/">the air quality has gone from bad to dangerous&lt;/a>. Knowing that outside was warmer, but less humid, was no longer enough to make a smart decision about weather or not to open the windows for some cost-effective cooling. I now need HomeAssistant to be aware of how clean the outside air was before making the decision to pipe in outdoor air.&lt;/p>
&lt;p>This post covers two things:&lt;/p>
&lt;ul>
&lt;li>A small update to the existing WS3 -&amp;gt; ESPHome -&amp;gt; HomeAssistant bridge code to take advantage of the WS3s' support for the ubiquitous &lt;code>PMS5003T&lt;/code> sensor.&lt;/li>
&lt;li>A simple 3d-printable enclosure for deploying the particulate matter sensor outdoors&lt;/li>
&lt;/ul>
&lt;p>When deployed, it looks like this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/04.installed.jpg" alt="Picture showing designed parts assembled and deployed as intended" />
&lt;figcaption>
&lt;p>
Excuse the awkward camera angle; sensor is deployed in an awkward to photograph location.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Please ignore the awkward camera angle as the sensor is deployed in a location where there&amp;rsquo;s not quite enough room for proper camera placement.&lt;/p>
&lt;p>And results in graphs that look like this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/example_dashboard.jpg" alt="Picture showing a simple WS3 dashboard in Grafana" />
&lt;figcaption>
&lt;p>
Smoke particles are between .4μm to .7μm in size... which explains the elevated red line relative to other particle sizes.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>A simplified copy of this post appears on &lt;a href="https://www.thingiverse.com/thing:4581351">thingiverse&lt;/a> and &lt;a href="https://www.prusaprinters.org/prints/39560-outdoor-enclosure-for-pms5003-particulate-matter-s">prusaprinters&lt;/a>.&lt;/p>
&lt;h2 id="the-enclosure">The enclosure&lt;/h2>
&lt;p>As of writing, there&amp;rsquo;s &lt;a href="https://www.thingiverse.com/thing:4044492">one existing enclosure&lt;/a> for the sensor on thingiverse. Unfortunately, the enclosure does not appear to have any design features for mounting to a pole nor does it have any bug-proofing design elements. I took this opportunity to design my own that could be easily mounted, features a slanted &amp;lsquo;roof&amp;rsquo; to prevent standing moisture ingress and could use standard size tobacco pipe filters to keep all but the tiniest of insects/particles out.&lt;/p>
&lt;p>The sensor uses a small fan to draw ambient air past an infrared laser. As airborne particles cross the laser beam, they reflect a certain amount of light which can be correlated with the size of the particle. This data can then be turned into fairly accurate counts of how many particles of a given size are in the sampled air. The enclosure is a basic box with two circular air channels pointed downwards to prevent moisture ingress. The intake and exhaust ports are at staggered heights and pointed in opposite directions and to minimize the chance of recirculating the same air.&lt;/p>
&lt;p>The lower port is the intake which connects to a few small holes on the front of the sensor and the exhaust port is the raised port which connects directly to the exhaust fan. If you could remove the first few mm from the front, it would look something like this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/f360_air_channels.jpg" alt="Screenshot showing labeled ingress/egress for air flow" />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;p>From the side, you can see the two air channels and the few mm of room in the back for wiring. The sensor sits on a &amp;lsquo;pedestal&amp;rsquo; to keep it elevated away from any moisture that may collect on the bottom of the enclosure.&lt;/p>
&lt;p>The base plate/pedestal are secured to the &amp;lsquo;body&amp;rsquo; with two M3 screws. I used &lt;code>10mm&lt;/code> as that&amp;rsquo;s what I had on hand, but screws between 6-12mm should work as well. The holes are sized for a M3, but any similar sized screw will work. Use a lighter or similar to heat the screw as you drive it into the plastic to create your own threads if using a larger/longer screw.&lt;/p>
&lt;p>Besides the &amp;lsquo;pedestal&amp;rsquo; there are a few contact surfaces that hold on to the sensor with a friction fit. The &amp;lsquo;ceiling&amp;rsquo; is a few mm thick and shouldn&amp;rsquo;t permit much moisture ingress but an optional slanted roof component can be printed as an extra precaution.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/f360_side_profile.jpg" alt="Screenshot showing side profile of assembly and the two ports" />
&lt;figcaption>
&lt;p>
Upper and lower chambers for exhaust and intake.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>While designing the enclosure, I used this &lt;a href="https://grabcad.com/library/pms5003-2">&lt;code>PMS5003&lt;/code> model&lt;/a> from Leclercq Gregory. 🙏&lt;/p>
&lt;h3 id="printing">Printing&lt;/h3>
&lt;p>This is a functional part with only three small surfaces that require reasonably tight precision to properly hold onto the sensor. The &lt;code>SPEED&lt;/code> setting with a &lt;code>.2mm&lt;/code> layer height and a reasonable 20% infill gave me part that works and feels water tight. The walls and ceiling need to keep water out so dipping below 15% infill or otherwise using settings that wont give solid layer adhesion is not advised. I printed using ABS for durability, but PLA will probably work if you can deploy into a shaded environment.&lt;/p>
&lt;p>The shroud and the base are not optional, the triangle shaped block is intended to turn the flat roof of the shroud into a slanted roof so water can&amp;rsquo;t collect. It is optional but shown below.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/suggested_print_orientation.jpg" alt="Screenshot showing suggested print bed arrangement" />
&lt;figcaption>
&lt;p>
No raft/support when printed in this orientation.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="assemble">Assemble&lt;/h2>
&lt;p>Briefly:&lt;/p>
&lt;ul>
&lt;li>collect materials&lt;/li>
&lt;li>press-fit the PM2.5 sensor into the enclosure&lt;/li>
&lt;li>make a wire that can interface the PM2.5 sensor to the WS3 board via RJ11&lt;/li>
&lt;li>seal everything up&lt;/li>
&lt;li>glue on mesh screens and angled roof&lt;/li>
&lt;li>plug into WS3&lt;/li>
&lt;li>flash ESPHome onto&lt;/li>
&lt;/ul>
&lt;h3 id="bill-of-materials">Bill of Materials&lt;/h3>
&lt;p>More or less everything that is needed for assembly is pictured below.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/01.collect.jpg" alt="Picture showing tools/materials required for assembly" />
&lt;figcaption>
&lt;p>
More or less everything needed to assemble.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Components:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://www.aliexpress.com/item/32921725022.html">WS3 Weather Station&lt;/a> - Essential / Foundational&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2FDigital-Universal-Particle-Concentration-Laser-Sensor-PMS5003-PM1-0-PM2-5-PM10%2F254616699639&amp;amp;campid=5338734064&amp;amp;toolid=10001&amp;amp;customid=">ST5003T PM2.5 Sensor&lt;/a> - Essential / Foundational&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2FTTGO-Wemos-MINI-D1-ESP32-WiFi-Bluetooth-Wemos-D1-Mini-ESP8266-ESP-32-Module%2F183413480551&amp;amp;campid=5338734064&amp;amp;toolid=10001&amp;amp;customid=">ESP32 Device&lt;/a> - A link to the ESP32 based device that I use but any ESP platform with a spare GPIO that can be used as a UART will work.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://rover.ebay.com/rover/1/711-53200-19255-0/1?mpre=https%3A%2F%2Fwww.ebay.com%2Fitm%2F25-Stainless-Steel-Smoking-Pipe-Screens-3-4-19mm-Tobacco-HOOKAH-FILTER-Heavy%2F183969079809&amp;amp;campid=5338734064&amp;amp;toolid=10001&amp;amp;customid=">3/4 inch tobacco pipe screens&lt;/a> - For bug/critter proofing the enclosure. Strongly suggested for outdoor deployments.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.mcmaster.com/91292A113/">2x M3 x 10mm screws&lt;/a> - Optional. The base can be glued to the shroud or any similar screw will work&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Note&lt;/strong>: Where possible, I&amp;rsquo;ve used referral links. The links don&amp;rsquo;t raise the price of any item, they simply let the retailer know that I sent you and, in return, I get a small cut of your purchase. If you&amp;rsquo;re not comfortable with that, you can use a URL unwinding service to get the &amp;lsquo;raw&amp;rsquo; product link and drop the attribution/commission part.&lt;/p>
&lt;p>General bits:&lt;/p>
&lt;ul>
&lt;li>Superglue&lt;/li>
&lt;li>Waterproofing caulk/sealant&lt;/li>
&lt;li>Drill/Screwdriver&lt;/li>
&lt;li>Driver bit for the screws&lt;/li>
&lt;/ul>
&lt;p>The stepped drill bit in the above picture is not a requirement if you assemble things in the correct oder. The cable egress hole is sized for a &amp;lsquo;typical&amp;rsquo; 3 pair &lt;a href="https://en.wikipedia.org/wiki/Registered_jack#RJ11,_RJ14,_RJ25_wiring">RJ11 cable&lt;/a> plus a tiny bit of wiggle room. I needed a working cable to test the code while the parts were printing so the hole in the printed base needed to be enlarged slightly to fit the head of the cable.&lt;/p>
&lt;h3 id="wiring">Wiring&lt;/h3>
&lt;p>There&amp;rsquo;s no ready-made cable out there that&amp;rsquo;ll join the two devices so one must be made. Fortunately, there&amp;rsquo;s only 6 wires to deal with&amp;hellip; 4 of them are distinct.&lt;/p>
&lt;p>Sacrifice the cable that comes with the PM2.5 sensor and the RJ11 cable by cutting them in half and solder the correct wires together. The &lt;em>color&lt;/em> of the wires that come in both the RJ11 cable and the PM2.5 cable are likely going to differ from the ones I used so I&amp;rsquo;ve left those details out and provided a table showing which pins are to be joined together:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Pin #&lt;/th>
&lt;th>PM2.5 Sensor Pin&lt;/th>
&lt;th>WS3 Pin&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>VCC&lt;/td>
&lt;td>5V&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>GND&lt;/td>
&lt;td>GND&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>SET&lt;/td>
&lt;td>ENABLE&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>RX&lt;/td>
&lt;td>RX&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>TX&lt;/td>
&lt;td>GND&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6&lt;/td>
&lt;td>RESET&lt;/td>
&lt;td>5V&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>NC&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8&lt;/td>
&lt;td>NC&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>For reference, Pin 1 on both the WS3 and PM2.5 Sensor:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/pin_out/WS3_Pins.jpg" alt="Screenshot showing the RJ11 jack on WS3 board w/ pin numbers" />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/pin_out/PM2.5_Pins.jpg" alt="Screenshot showing labeled pins on the 8 pin jack on the back of the PM2.5 sensor" />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;p>With the wiring done, the sensor just needs to be stuffed into the enclosure. Don&amp;rsquo;t forget to thread the RJ11 cable through the hole in the base plate &lt;em>BEFORE&lt;/em> soldering it to the cable for the PM2.5 sensor&amp;hellip; otherwise you&amp;rsquo;ll need that stepped drill bit! 🙃&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/02.assemble.jpg" alt="Picture showing sensor inserted into printed shroud" />
&lt;figcaption>
&lt;p>
Sensor has been press-fit into the enclosure and wire fed through the base plate.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>To finish, secure the base with screws and a bit of water-proofing caulk for good measure:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/03.glue.jpg" alt="Picture showing assembled components while glue/caulk curing" />
&lt;figcaption>
&lt;p>
I suggest waiting until the end to glue on the optional roof and waiting until just before that to glue on the optional mesh screens.
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="the-code">The code&lt;/h2>
&lt;p>Setting up and using ESPHome is outside the scope of this post but there are several &lt;a href="https://esphome.io/guides/getting_started_hassio.html">good guides&lt;/a> out there. Once you have that set up, &lt;a href="https://esphome.io/custom/custom_component.html">include&lt;/a> the &lt;code>ws3.h&lt;/code> file and set up your custom sensor as shown below. A working example and more detail is over on the
&lt;a href="https://github.com/kquinsland/ws3-to-esphome-bridge/">github repo&lt;/a>.&lt;/p>
&lt;p>It&amp;rsquo;ll look like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-weight:bold">uart&lt;/span>:
&lt;span style="font-weight:bold">id&lt;/span>: uart_bus
&lt;span style="font-style:italic"># At this time, ESP does not Transmit anything to the WS3&lt;/span>
&lt;span style="font-weight:bold">tx_pin&lt;/span>: GPIO16
&lt;span style="font-weight:bold">rx_pin&lt;/span>: GPIO17
&lt;span style="font-weight:bold">baud_rate&lt;/span>: 2400
&lt;span style="font-weight:bold">sensor&lt;/span>:
- &lt;span style="font-weight:bold">platform&lt;/span>: custom
&lt;span style="font-weight:bold">lambda&lt;/span>: |-&lt;span style="font-style:italic">
&lt;/span>&lt;span style="font-style:italic"> auto ws3 = new WS3(id(uart_bus));
&lt;/span>&lt;span style="font-style:italic"> App.register_component(ws3);
&lt;/span>&lt;span style="font-style:italic"> return {
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;temperature_sensor,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;pressure_sensor,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;humidity_sensor,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;wind_speed_current_sensor,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;wind_speed_peak_5m_sensor,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;wind_direction_sensor,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;rain_fall_1h_sensor,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;rain_fall_24h_sensor,
&lt;/span>&lt;span style="font-style:italic">
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;particles_03um,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;particles_05um,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;particles_10um,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;particles_25um,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;particles_50um,
&lt;/span>&lt;span style="font-style:italic"> ws3-&amp;gt;particles_100um,
&lt;/span>&lt;span style="font-style:italic"> };&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>With that, check the logs from your instance of ESPHome and you should see something like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">[D][ws3:157]: pkt_read_ok!
[D][WS3:410]: VALID! Packet: [c000s000g000t093r000p000h35b09880,050,080,088,502,056,065,*18
], Checksum: [18] chksum: [18]
[E][WS3:342]: Validating: [c000s000g000t093r000p000h35b09880,050,080,088,502,056,065]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>indicating that the WS3 has detected the PM2.5 sensor and is reporting it&amp;rsquo;s readings in addition to the temperature/wind data. Then just check your HomeAssistant install for the data.&lt;/p>
&lt;h2 id="files">Files&lt;/h2>
&lt;p>For archive / posterity, all source files are included here. All files are licensed as &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike&lt;/a> (CC BY-NC-SA).&lt;/p>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/02.assemble.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/02.assemble_hu581ed75240ad3bd415fa4d000e729c07_1277716_300x0_resize_q75_box.jpg" width="300" height="414">
&lt;/a>
&lt;figcaption>
&lt;small>Sensor has been press-fit into the enclosure and wire fed through the base plate.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/03.glue.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/03.glue_hu4b434a2d0bde22f360c0e8fbf7a649e9_1464402_300x0_resize_q75_box.jpg" width="300" height="398">
&lt;/a>
&lt;figcaption>
&lt;small>I suggest waiting until the end to glue on the optional roof and waiting until just before that to glue on the optional mesh screens.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/example_dashboard.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/example_dashboard_hud37127b2a8725f9b696f09347ad21464_272815_300x0_resize_q75_box.jpg" width="300" height="163">
&lt;/a>
&lt;figcaption>
&lt;small>Smoke particles are between .4μm to .7μm in size... which explains the elevated red line relative to other particle sizes.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/04.installed.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/04.installed_hu2a1504819b520ffab23f58c73dabe877_1392166_300x0_resize_q75_box.jpg" width="300" height="309">
&lt;/a>
&lt;figcaption>
&lt;small>Excuse the awkward camera angle; sensor is deployed in an awkward to photograph location.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/models/BASE.step">
&lt;i class="far fa-file-code">&lt;/i>
models/BASE.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/models/BODY.step">
&lt;i class="far fa-file-code">&lt;/i>
models/BODY.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/models/LID.step">
&lt;i class="far fa-file-code">&lt;/i>
models/LID.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/models/base.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/base.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/models/body.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/body.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/models/combined.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
models/combined.3mf:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/models/lid.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/lid.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/pin_out/PM2.5_Pins.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/pin_out/PM2.5_Pins_hu73d3c3e0df5406e1f5d0c0aa79c239b4_47767_300x0_resize_q75_box.jpg" width="300" height="152">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/pin_out/WS3_Pins.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/pin_out/WS3_Pins_hu320425c47decf2d27d21e4a5ee712e53_888503_300x0_resize_q75_box.jpg" width="300" height="214">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/01.collect.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/01.collect_hu256fbbed5931a8fb15e03274d1dfa3ce_1070239_300x0_resize_q75_box.jpg" width="300" height="338">
&lt;/a>
&lt;figcaption>
&lt;small>More or less everything needed to assemble.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/suggested_print_orientation.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/suggested_print_orientation_hubc29781a1e48d16ebf7b06eb48685880_519298_300x0_resize_q75_box.jpg" width="300" height="175">
&lt;/a>
&lt;figcaption>
&lt;small>No raft/support when printed in this orientation.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/f360_air_channels.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/f360_air_channels_hu16ba34b32cdb392111aa122e323e4ab7_84744_300x0_resize_q75_box.jpg" width="300" height="436">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/f360_side_profile.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/08/adding-an-airborne-particulate-mater-sensor-to-ws3-weather-station/images/f360_side_profile_hu6d0a16d67440fb635793f95d3fd27d1d_152867_300x0_resize_q75_box.jpg" width="300" height="324">
&lt;/a>
&lt;figcaption>
&lt;small>Upper and lower chambers for exhaust and intake.&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>RSS and Home Assistant: early warning for grid blackouts</title><link>https://karlquinsland.com/2020/08/rss-and-home-assistant-early-warning-for-grid-blackouts/</link><pubDate>Sun, 16 Aug 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/08/rss-and-home-assistant-early-warning-for-grid-blackouts/</guid><description>&lt;p>California, like most of the West Coast, is currently in the middle of a prolonged and serious heat-wave. Record breaking temperatures results in a distribution grid stressed beyond it&amp;rsquo;s abilities which guarantees blackouts.&lt;/p>
&lt;p>The &lt;a href="https://en.wikipedia.org/wiki/California_Independent_System_Operator">organization that oversees the electric grid&lt;/a> in California publishes RSS feeds for various types of grid related news and events. All the CA ISO RSS feeds are published &lt;a href="http://www.caiso.com/Pages/GlobalRSS.aspx">here&lt;/a>, but the two feed that I&amp;rsquo;m using are:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="http://content.caiso.com/awe/noticeRSS.xml">http://content.caiso.com/awe/noticeRSS.xml&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://content.caiso.com/awe/noticeflexRSS.xml">http://content.caiso.com/awe/noticeflexRSS.xml&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>As energy demand ramps up, &lt;code>flex&lt;/code> alerts are issued as a call to reduce energy consumption. If demand continues to rise &lt;code>warnings&lt;/code> and, finally, &lt;code>stage3&lt;/code> events are issued. A &lt;code>warning&lt;/code> does not guarantee a &lt;code>stage3&lt;/code> event, but a &lt;code>stage3&lt;/code> event mans that blackouts are all but inevitable in the coming hours. The &lt;em>exact&lt;/em> meaning of each alert type is outlined in &lt;a href="https://www.caiso.com/Documents/SystemAlertsWarningsandEmergenciesFactSheet.pdf">this PDF&lt;/a>.&lt;/p>
&lt;p>The &lt;code>noticeRSS.xml&lt;/code> feed, has &lt;em>early&lt;/em> warning notifications that look like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-xml" data-lang="xml">&lt;span style="font-weight:bold">&amp;lt;item&amp;gt;&lt;/span>
\n
&lt;span style="font-weight:bold">&amp;lt;title&amp;gt;&lt;/span>NOTICE 202002440: CAISO Grid Warning Issued &lt;span style="font-weight:bold">&amp;lt;/title&amp;gt;&lt;/span>
\n
&lt;span style="font-weight:bold">&amp;lt;link&amp;gt;&lt;/span>http://www.caiso.com/awe/noticelog.html#202002440&lt;span style="font-weight:bold">&amp;lt;/link&amp;gt;&lt;/span>
\n
&lt;span style="font-weight:bold">&amp;lt;description&amp;gt;&lt;/span>Effective: 16-Aug-2020 12:00 PM Terminates: 16-Aug-2020 11:59 PM&lt;span style="font-weight:bold">&amp;lt;/description&amp;gt;&lt;/span>
\n
&lt;span style="font-weight:bold">&amp;lt;/item&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note: there&amp;rsquo;s nothing wrong w/ your browser, the &lt;code>\n&lt;/code> characters &lt;em>are&lt;/em> in the actual feed. No matter, the &lt;a href="https://github.com/home-assistant/core/tree/dev/homeassistant/components/feedreader">RSS parser&lt;/a> in Home Assistant &lt;em>can&lt;/em> tolerate them.&lt;/p>
&lt;p>I use the alerts/warnings to do a few simple tasks, but there&amp;rsquo;s so much potential beyond the automation I currently have:&lt;/p>
&lt;ul>
&lt;li>bumps thermostats up by a few degrees to lighten demand*&lt;/li>
&lt;li>re-schedule a few routine activities that are usually done in the evening to as soon as possible (cooking, for example)&lt;/li>
&lt;li>notify me to immediately go check that the generator has fuel&lt;/li>
&lt;/ul>
&lt;ul>
&lt;li>Currently in &amp;lsquo;unarmed&amp;rsquo; mode as I tweak the logic driving the decision&lt;/li>
&lt;/ul>
&lt;h2 id="how-to-do-it">How to do it&lt;/h2>
&lt;p>Basically, add the two feeds above to the &lt;a href="https://www.home-assistant.io/integrations/feedreader/">feedreader&lt;/a> integration and use the &lt;code>feedreader&lt;/code> type of &lt;a href="https://www.home-assistant.io/docs/automation/trigger/#event-trigger">event&lt;/a> to trigger your automation.&lt;/p>
&lt;p>Somewhere in &lt;code>configuration.yaml&lt;/code>, load the &lt;code>feedreader&lt;/code> component.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-weight:bold">feedreader&lt;/span>: !include feedreader/rss.yaml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>and in the &lt;code>feedreader/rss.yaml&lt;/code> file, add the URLs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-weight:bold">urls&lt;/span>:
- http://content.caiso.com/awe/noticeRSS.xml
- http://content.caiso.com/awe/noticeflexRSS.xml
&lt;span style="font-style:italic"># Pull down the feed 2x/ hour&lt;/span>
&lt;span style="font-weight:bold">scan_interval&lt;/span>:
&lt;span style="font-weight:bold">minutes&lt;/span>: 30
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Unfortunately, Home Assistant does not support setting the &lt;code>scan_interval&lt;/code> per feed, so you&amp;rsquo;ll have to figure out a happy middle ground if you&amp;rsquo;ve already got a few RSS feeds you monitor. Likewise, don&amp;rsquo;t pull the feed down excessively&amp;hellip; I don&amp;rsquo;t see a lot of evidence that the feed is cached well and the CA ISO does occasionally have to put banners on the top of their site saying that the site is under heavy load. Don&amp;rsquo;t be the reason the site goes down because &lt;em>you&lt;/em> wanted &lt;strong>instant&lt;/strong> notification.&lt;/p>
&lt;p>If you&amp;rsquo;re not in a position to do any sophisticated automation based on the notification, it&amp;rsquo;s still simple to fire off a notification to &lt;em>manually&lt;/em> prepare:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="font-style:italic">##&lt;/span>
- &lt;span style="font-weight:bold">alias&lt;/span>: Notify when new Flex or Warning issued
&lt;span style="font-weight:bold">trigger&lt;/span>:
&lt;span style="font-weight:bold">platform&lt;/span>: event
&lt;span style="font-weight:bold">event_type&lt;/span>: feedreader
&lt;span style="font-weight:bold">action&lt;/span>:
&lt;span style="font-weight:bold">service&lt;/span>: persistent_notification.create
&lt;span style="font-weight:bold">data_template&lt;/span>:
&lt;span style="font-weight:bold">notification_id&lt;/span>: &lt;span style="font-style:italic">&amp;#34;{{ trigger.event.data.title }}&amp;#34;&lt;/span>
&lt;span style="font-weight:bold">title&lt;/span>: &lt;span style="font-style:italic">&amp;#34;FlexAlert&amp;#34;&lt;/span>
&lt;span style="font-weight:bold">message&lt;/span>: &amp;gt;&lt;span style="font-style:italic">
&lt;/span>&lt;span style="font-style:italic"> {% set tokens = trigger.event.data.description.split(&amp;#39; &amp;#39;) %}
&lt;/span>&lt;span style="font-style:italic"> {% set start_str = &amp;#34;{} {} {}&amp;#34;.format(tokens[1], tokens[2], tokens[3]) %}
&lt;/span>&lt;span style="font-style:italic"> {% set start = strptime(start_str, &amp;#39;%d-%b-%Y %I:%M %p&amp;#39;) %}
&lt;/span>&lt;span style="font-style:italic"> {% set end_str = &amp;#34;{} {} {}&amp;#34;.format(tokens[5], tokens[6], tokens[7]) %}
&lt;/span>&lt;span style="font-style:italic"> {% set end = strptime(end_str, &amp;#39;%d-%b-%Y %I:%M %p&amp;#39;) %}
&lt;/span>&lt;span style="font-style:italic"> &amp;#34;Heads up, electricity demand is likely to exceed production from {{ start.isoformat() }} to {{ end.isoformat() }}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Which should create a simple notification that&amp;rsquo;ll look something like this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/08/rss-and-home-assistant-early-warning-for-grid-blackouts/images/notification.jpg" alt="Ignore the sample text from my testing" />
&lt;figcaption>
&lt;p>
Ignore the sample text from my testing
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>The &lt;code>strptime&lt;/code> function yields &lt;code>start&lt;/code> and &lt;code>end&lt;/code> objects that can be manipulated further:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-fallback" data-lang="fallback">{% set now = now() %}
{% if start.day &amp;gt; now.day -%}
It looks like demand will be high *tomorrow*
{%- endif %}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Happy automating.&lt;/p></description></item><item><title>Announcing The Missing ToDoist Tools</title><link>https://karlquinsland.com/2020/07/announcing-the-missing-todoist-tools/</link><pubDate>Sun, 26 Jul 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/07/announcing-the-missing-todoist-tools/</guid><description>&lt;h1 id="tmtdt-the-missing-todoist-tools-">TMTDT: The Missing ToDoist Tools 🎉&lt;/h1>
&lt;p>As the name implies, TMTDT started as a small collection of scripts that I used to augment ToDoist with features they can&amp;rsquo;t/won&amp;rsquo;t implement. It&amp;rsquo;s grown quite a bit since then.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/announcing-the-missing-todoist-tools/images/demo.gif" alt="I don&amp;#39;t know how to make flashy demo gifs." />
&lt;figcaption>
&lt;p>
I don&amp;#39;t know how to make flashy demo gifs.
&lt;a href="#demo">
See the file driving the demo
&lt;/a>
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>Those scripts started as simple idea and quickly morphed into a creaky, but essential, tool. As more features were added it continued too morph into an unmaintainable mess. Untangling that mess was on my todo list but never a high priority partly because of issues TMTDT was designed to solve 🤦.&lt;/p>
&lt;p>I lost my day job right as the spring of 2020 &lt;a href="https://en.wikipedia.org/wiki/Stay-at-home_order#COVID-19_pandemic">shelter in place&lt;/a> order was put in place. TMTDT is certainly not how I &lt;em>thought&lt;/em> early summer was going to be spent, but a useful way nonetheless.&lt;/p>
&lt;p>One significant chunk of my newly-freed time and a lengthy re-write later, I had something that looked promising. After a &lt;em>lot&lt;/em> more work and some tinkering, I&amp;rsquo;ve got something that feels like far more than a hacky tool for personal use.&lt;/p>
&lt;h2 id="why">Why&lt;/h2>
&lt;p>Why not?&lt;/p>
&lt;p>I had several scripts that I would run on a regular basis to do things like:&lt;/p>
&lt;ul>
&lt;li>set up projects with multiple different types of templates based on things like the date&lt;/li>
&lt;li>fix typos i routinely made while &lt;a href="https://get.todoist.help/hc/en-us/articles/115001745265-Task-Quick-Add">quick adding&lt;/a> tasks.&lt;/li>
&lt;li>re-schedule certain daily tasks if they had been missed&lt;/li>
&lt;/ul>
&lt;p>No joke, I&amp;rsquo;d spend a &lt;em>lot&lt;/em> of time fixing typos, expanding ideas for a project into proper sub-tasks and sections and other routine administrative work:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/announcing-the-missing-todoist-tools/images/time-report.jpg" alt="Representative of time spent during a typical week" />
&lt;figcaption>
&lt;p>
Representative of time spent during a typical week
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>In that specific week, I kept track of how 37 hours were spent. Of those 37, about 4 were spent on general Inbox review / process. At least 3 of those 4 were spent &lt;em>directly&lt;/em> on task triage. 3/37 is about 8%. With no full time day job - &lt;a href="https://karlquinsland.com/contact/">hire me&lt;/a> - that&amp;rsquo;s a fairly representative breakdown for a given week; some time planning the things, lots of time doing the things.&lt;/p>
&lt;p>What would you do with 8% of your time back each week?&lt;/p>
&lt;p>I&amp;rsquo;m kidding.&lt;/p>
&lt;p>We all know that I&amp;rsquo;m not getting any free time back from this.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/announcing-the-missing-todoist-tools/images/xkcd-1319.png" />
&lt;figcaption>
&lt;p>
&lt;a href="https://xkcd.com/1319/">
Credit: XKCD #1319
&lt;/a>
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>I&amp;rsquo;ve written this software to suit my needs, but the decision to make it a bit more robust and featured before release is because I&amp;rsquo;ve noticed a few &amp;lsquo;new&amp;rsquo; tools to better augment ToDoist:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/Hoffelhas/autodoist">autodoist&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/todoist-shortcuts-gmail-v/dehmghpdcahlffompjagejmgbcfahndp">shortcuts&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/6uhrmittag/taskbutler">taskbutler&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://planner-todo.web.app/">planner&lt;/a>. This is more of a UI, but it&amp;rsquo;s a &lt;strong>very&lt;/strong> pretty app.&lt;/li>
&lt;/ul>
&lt;p>And I&amp;rsquo;m genuinely curious about how other people will user it. I am always appreciative when somebody finds a smart way to save some time and shares their trick. I&amp;rsquo;m hoping somebody figures out how to use this tool in a way that I can learn from.&lt;/p>
&lt;p>An announcement post for TMTDT is now on &lt;a href="https://old.reddit.com/r/todoist/comments/hyfl3o/introducing_the_missing_todoist_tools_a/">/r/todoist&lt;/a>.&lt;/p>
&lt;h2 id="how">How&lt;/h2>
&lt;p>The code and some documentation can be found on &lt;a href="https://github.com/kquinsland/the-missing-todoist-tools">GitHub&lt;/a>.&lt;/p>
&lt;p>The demo gif at the top of this post illustrates a simple example, but more through (read: contrived) examples are included in the &lt;a href="https://github.com/kquinsland/the-missing-todoist-tools/tree/master/jobs/v1">jobs&lt;/a> directory.&lt;/p>
&lt;p>The short version:&lt;/p>
&lt;blockquote>
&lt;p>Scriptable tools for building jobs to manage a TooDoist account&lt;/p>
&lt;/blockquote>
&lt;p>Slightly longer version:&lt;/p>
&lt;blockquote>
&lt;p>Architecture inspired by Elastic Search&amp;rsquo;s &lt;a href="https://github.com/elastic/curator/tree/master/curator">Curator&lt;/a>. Functionality built for ToDoist.&lt;/p>
&lt;/blockquote>
&lt;h3 id="demo">Demo&lt;/h3>
&lt;p>The full set of &lt;a href="https://github.com/kquinsland/the-missing-todoist-tools/blob/master/jobs/demo/">resources for the demo are here&lt;/a>, but the &amp;lsquo;meaningful&amp;rsquo; parts are below:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">
&lt;span style="font-style:italic"># apply these labels...&lt;/span>
&lt;span style="font-weight:bold">labels&lt;/span>:
- &lt;span style="font-style:italic">&amp;#34;at_work&amp;#34;&lt;/span>
&lt;span style="font-style:italic"># to tasks that...&lt;/span>
&lt;span style="font-weight:bold">filters&lt;/span>:
- &lt;span style="font-weight:bold">filter&lt;/span>:
&lt;span style="font-style:italic"># Any task that...&lt;/span>
&lt;span style="font-weight:bold">task&lt;/span>:
&lt;span style="font-style:italic"># ... ends in &amp;#39;at work&amp;#39; or &amp;#39;the office&amp;#39;&lt;/span>
&lt;span style="font-weight:bold">content&lt;/span>:
&lt;span style="font-weight:bold">match&lt;/span>: &lt;span style="font-style:italic">&amp;#39;(at work$|at the office$)&amp;#39;&lt;/span>
&lt;span style="font-weight:bold">option&lt;/span>:
&lt;span style="font-style:italic"># remove portions of task content that match the query&lt;/span>
&lt;span style="font-weight:bold">mutate&lt;/span>: &lt;span style="font-weight:bold">Yes&lt;/span>
&lt;span style="font-style:italic"># *AND*&lt;/span>
&lt;span style="font-style:italic"># ... has no labels&lt;/span>
&lt;span style="font-weight:bold">labels&lt;/span>:
&lt;span style="font-weight:bold">absent&lt;/span>: &lt;span style="font-weight:bold">Yes&lt;/span>
&lt;span style="font-style:italic"># *AND*&lt;/span>
&lt;span style="font-style:italic"># ... is in this project&lt;/span>
&lt;span style="font-weight:bold">projects&lt;/span>:
&lt;span style="font-weight:bold">name&lt;/span>:
&lt;span style="font-weight:bold">match&lt;/span>: &lt;span style="font-style:italic">&amp;#39;Inbox&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>and&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">
&lt;span style="font-style:italic"># Create the projects...&lt;/span>
&lt;span style="font-weight:bold">projects&lt;/span>:
&lt;span style="font-style:italic"># ... as child projects of `Garage Sale 🏚️💵`&lt;/span>
- &lt;span style="font-weight:bold">parent&lt;/span>:
&lt;span style="font-weight:bold">project&lt;/span>: Garage Sale 🏚️💵
&lt;span style="font-style:italic"># ... populated with template tasks/sections&lt;/span>
&lt;span style="font-weight:bold">template&lt;/span>:
&lt;span style="font-weight:bold">file&lt;/span>: ./templates/garage-sale.csv
&lt;span style="font-style:italic"># where the name of the projects to create comes from ...&lt;/span>
&lt;span style="font-weight:bold">from&lt;/span>:
&lt;span style="font-weight:bold">filters&lt;/span>:
- &lt;span style="font-weight:bold">filter&lt;/span>:
&lt;span style="font-style:italic"># Any task that...&lt;/span>
&lt;span style="font-weight:bold">task&lt;/span>:
&lt;span style="font-weight:bold">content&lt;/span>:
&lt;span style="font-weight:bold">match&lt;/span>: &lt;span style="font-style:italic">&amp;#34;.&amp;#34;&lt;/span>
&lt;span style="font-weight:bold">option&lt;/span>:
&lt;span style="font-weight:bold">delete&lt;/span>: &lt;span style="font-weight:bold">yes&lt;/span>
&lt;span style="font-weight:bold">projects&lt;/span>:
&lt;span style="font-style:italic"># ... is in this project&lt;/span>
&lt;span style="font-weight:bold">name&lt;/span>:
&lt;span style="font-weight:bold">match&lt;/span>: &lt;span style="font-style:italic">&amp;#39;Garage Sale 🏚️💵&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>CAPP: Cloud Agnostic Proxy Protocol</title><link>https://karlquinsland.com/2020/07/capp-cloud-agnostic-proxy-protocol/</link><pubDate>Tue, 21 Jul 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/07/capp-cloud-agnostic-proxy-protocol/</guid><description>&lt;p>It&amp;rsquo;s another &amp;ldquo;i made a thing!&amp;rdquo; post. 🙃&lt;/p>
&lt;hr>
&lt;p>I&amp;rsquo;m playing around with porting a few different applications over to k8. Some of them - like &lt;a href="https://github.com/kquinsland/skyhole/">skyhole&lt;/a> - rely on UDP packets which my hosted k8 provider of choice (read: cheapest! 💰) &lt;a href="https://ideas.digitalocean.com/ideas/DO-I-310">does not support&lt;/a>.&lt;/p>
&lt;p>The solution is either:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Keep track of all of the node IP addresses that have an exposed &lt;code>nodePort&lt;/code> and have the client connect directly to the cluster on the &lt;code>nodePort&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Set up some sort of intermediary to re-write the packet from the &lt;code>targetPort&lt;/code> &lt;strong>to&lt;/strong> the &lt;code>nodePort&lt;/code>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>Option 1 seems fragile; if a cluster host / node is recycled, the client needs to learn the new correct IP addresses.&lt;/p>
&lt;p>Option 2 seems far more flexible and is basically how most hosted k8 providers do ingress already. In fact, if digital ocean &lt;em>had&lt;/em> UDP support, this tool would never have been created. Bonus: clients that expect a specific port can still connect to the service no matter what &lt;code>nodePort&lt;/code> is used.&lt;/p>
&lt;p>So that&amp;rsquo;s what &lt;a href="https://github.com/kquinsland/cloud-agnostic-protocol-proxy">&lt;code>CAPP&lt;/code>&lt;/a> is: &lt;strong>C&lt;/strong>loud &lt;strong>A&lt;/strong>gnostic &lt;strong>P&lt;/strong>rotocol &lt;strong>P&lt;/strong>roxy.&lt;/p>
&lt;p>It&amp;rsquo;s a repo w/ a small python tool which can collect the IP addresses(s) belonging to each node in an arbitrary k8 cluster and - when combined with a small user config file - generate configuration files for &lt;code>traefik&lt;/code>.&lt;/p>
&lt;p>A &amp;lsquo;reference&amp;rsquo; packer job is included to generate a basic machine image to host traefik. A few lines of &lt;code>cloud_init&lt;/code> is all that&amp;rsquo;s needed to kick the tool off.&lt;/p></description></item><item><title>Systemd Resolved With Consul Agent</title><link>https://karlquinsland.com/2020/07/systemd-resolved-with-consul-agent/</link><pubDate>Tue, 21 Jul 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/07/systemd-resolved-with-consul-agent/</guid><description>&lt;p>I pieced this technique together a while back and created a gist for it. I&amp;rsquo;m creating &lt;em>this&lt;/em> post as a pointer to that gist so I have something that&amp;rsquo;s a bit easier to reference and refer others to.&lt;/p>
&lt;p>And i want to test out the &lt;a href="https://gohugo.io/content-management/shortcodes/#gist">hugo shortcode for embedding a gist&lt;/a> 😏.&lt;/p>
&lt;p>The really short version:&lt;/p>
&lt;ul>
&lt;li>Create a dedicated interface that can only be accessed from the local system&lt;/li>
&lt;li>Bind the consul-agent&amp;rsquo;s DNS service to this local only interface&lt;/li>
&lt;li>Tell &lt;a href="https://www.freedesktop.org/software/systemd/man/systemd-resolved.service.html">&lt;code>systemd-resolved&lt;/code>&lt;/a> that all hostnames with the &lt;code>.consul&lt;/code> TLD can be resolved via a DNS server on this local interface&lt;/li>
&lt;/ul>
&lt;p>No need to disable &lt;code>resolved&lt;/code> and replace it with dnsmasq 😄&lt;/p>
&lt;script type="application/javascript" src="https://gist.github.com/kquinsland/5cdc63614a581d9b392f435740b58729.js">&lt;/script></description></item><item><title>home lab: simple printable cable org</title><link>https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/</link><pubDate>Sat, 18 Jul 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/</guid><description>&lt;p>Quick / another &amp;ldquo;i made a thing!&amp;rdquo; post.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/installed.jpg" alt="Picture showing designed parts deployed as intended (please ignore the lingering dust! 💨)" />
&lt;figcaption>
&lt;p>
Picture showing designed parts deployed as intended (please ignore the lingering dust! 💨)
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>I needed some horizontal / vertical cable rings for cat5 and power cables. I would have used the excellent &lt;a href="https://www.thingiverse.com/thing:3315960">1U Rackmount Cable Management Rings&lt;/a> by &lt;a href="https://www.thingiverse.com/boulwarek/about">boulwarek&lt;/a> except the hole spacing didn&amp;rsquo;t work for my application. I needed cable rings for the &amp;lsquo;front-to-back&amp;rsquo; braces which have distinct dimensions:&lt;/p>
&lt;ul>
&lt;li>holes needed to be spaced &lt;code>10.85mm&lt;/code> apart&lt;/li>
&lt;li>distance between center of screw is &lt;code>20.0mm&lt;/code>&lt;/li>
&lt;/ul>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/hole-dimensions.jpg" alt="Screenshot from Fusion360 showing dimensions between screw holes" />
&lt;figcaption>
&lt;p>
Screenshot from Fusion360 showing dimensions between screw holes
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>I made the rings slightly smaller as the horizontal / vertical runs I needed rings for do not carry more than a few cables.&lt;/p>
&lt;p>A similar copy of this post is on &lt;a href="https://www.thingiverse.com/thing:4546078">thingiverse&lt;/a> and &lt;a href="https://www.prusaprinters.org/prints/36851-server-rack-cable-org">prusaprinters&lt;/a> page.&lt;/p>
&lt;h2 id="printing">Printing&lt;/h2>
&lt;p>Theses are &amp;lsquo;function&amp;rsquo; parts, so the cheapest material and fastest settings work. No support material needed and minimal bridging with the suggested print orientation shown below.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/suggested_print_orientation.jpg" alt="Screenshot showing suggested print bed arrangement" />
&lt;figcaption>
&lt;p>
Screenshot showing suggested print bed arrangement
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="files">Files&lt;/h2>
&lt;p>For archive / posterity, all source files are included here. All files are licensed as &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike&lt;/a> (CC BY-NC-SA).&lt;/p>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/hole-dimensions.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/hole-dimensions_hu83b61487aa052e287a0d86e657470027_73623_300x0_resize_q75_box.jpg" width="300" height="232">
&lt;/a>
&lt;figcaption>
&lt;small>Screenshot from Fusion360 showing dimensions between screw holes&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/horizontal-model.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/horizontal-model_hu543f65d8397ef1c757ed8c5dd191bd79_44806_300x0_resize_q75_box.jpg" width="300" height="337">
&lt;/a>
&lt;figcaption>
&lt;small>Picture showing the CAD model for horizontal variant&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/installed.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/installed_hu8273af6dd11af8c1f0254ae91302bd85_877360_300x0_resize_q75_box.jpg" width="300" height="118">
&lt;/a>
&lt;figcaption>
&lt;small>Picture showing designed parts deployed as intended (please ignore the lingering dust! 💨)&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/models/combined.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
models/combined.3mf:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/models/horizontal.f3d">
&lt;i class="far fa-file-">&lt;/i>
models/horizontal.f3d:
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/models/horizontal.stl">
&lt;i class="far fa-file-code">&lt;/i>
Horizontal STL:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/models/vertical.f3d">
&lt;i class="far fa-file-">&lt;/i>
models/vertical.f3d:
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/models/vertical.stl">
&lt;i class="far fa-file-code">&lt;/i>
Vertical STL:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/suggested_print_orientation.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/suggested_print_orientation_hud61f960f3afd79e64529ec719f59eb42_400356_300x0_resize_q75_box.jpg" width="300" height="207">
&lt;/a>
&lt;figcaption>
&lt;small>Screenshot showing suggested print bed arrangement&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/vertical-model.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-simple-printable-cable-org/images/vertical-model_hu17d82c0049c0096ab66a3dbcef39359e_44352_300x0_resize_q75_box.jpg" width="300" height="241">
&lt;/a>
&lt;figcaption>
&lt;small>Picture showing the CAD model for vertical variant&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>electronics lab: enhanced psu</title><link>https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/</link><pubDate>Thu, 09 Jul 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/</guid><description>&lt;p>While doing the PoE related testing for &lt;a href="https://karlquinsland.com/2020/07/poe-at-a-distance-caused-terrible-cat5-speeds/">this&lt;/a> incident, it occurred to me that I never got around to sharing the files for a small modification to the popular RD6006 PSU.&lt;/p>
&lt;p>While drafting this post, I discovered that there appears to be a newer version of the RD6006: the 6012. As far as I can tell, they&amp;rsquo;re in the same &amp;lsquo;family&amp;rsquo; and have the same dimensions so the CAD and related model files below &lt;em>should&lt;/em> work w/ the RD6012 just as they do w/ the 6006, but i can only &amp;lsquo;guarantee&amp;rsquo; that the CAD and related model files below will work with the &lt;a href="https://hackaday.com/tag/riden-rd6006/">RD6006&lt;/a>.&lt;/p>
&lt;p>A version of this post appears on &lt;a href="https://www.prusaprinters.org/prints/36338-poe-and-qc30-adapter-for-rd6006-psu">prusaprinters&lt;/a> and &lt;a href="https://www.thingiverse.com/thing:4536551">thingiverse&lt;/a>&lt;/p>
&lt;h2 id="what">What&lt;/h2>
&lt;p>A small enclosure for a PoE injector and QC 3.0 charger designed to sit on top of the RD6012 PSU &amp;lsquo;kit&amp;rsquo; sold all over aliexpress and banggood.&lt;/p>
&lt;p>Assembled, it looks like this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/rd6012-assembled.jpg" alt="picture of assembled DR60 series PSU" />
&lt;figcaption>
&lt;p>
As seen on AliExpress
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>The RD6006 is incredibly versatile, but can only supply power for about 85% of the devices that make their way onto my &amp;lsquo;healing&amp;rsquo; bench. I wasn&amp;rsquo;t keen on taking up more valuable space with a device dedicated to PoE injection so finding a way to mod one into the PSU seemed like a good idea. Similarly, adding a versatile USB port seemed like a no-brainer as my &lt;a href="http://www.miniware.com.cn/product/ts80-soldering-iron-more/">favorite soldering iron&lt;/a> is powered via QuickCharge 3.&lt;/p>
&lt;p>Three useful bench tools, one footprint, one consumed power outlet. What&amp;rsquo;s not to love?&lt;/p>
&lt;h2 id="printing">Printing:&lt;/h2>
&lt;p>There are two components for this build:&lt;/p>
&lt;ul>
&lt;li>the &amp;lsquo;plate&amp;rsquo; which rests on the top of the PSU case and has small &amp;lsquo;fences&amp;rsquo; to fix the circuit boards in place. It&amp;rsquo;s the &amp;lsquo;salmon&amp;rsquo; colored component&lt;/li>
&lt;li>the &amp;lsquo;lid&amp;rsquo; is the (mostly) transparent yellow component which holds the auxiliary power supplies (pink components) in place and keeps all voltages away from people.&lt;/li>
&lt;/ul>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/plate_and_lid.jpg" alt="picture of assembled components, colored" />
&lt;figcaption>
&lt;h4>Colorized Components&lt;/h4>
&lt;p>
Relevant components, colored in F360
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>I used black PETG, but any material and at least 10% infill should be fine. Tune the layer height to taste.&lt;/p>
&lt;p>The &amp;lsquo;plate&amp;rsquo; does not need any supports nor does the lid if printed in the suggested print orientation shown below 👇. I printed with settings optimized for speed so there was minimal sagging, but nothing substantial. What little there was didn&amp;rsquo;t interfere with clearance of any other internal component and was completely hidden.&lt;/p>
&lt;p>If you&amp;rsquo;re not comfortable with bridging long distances, you can optionally enforce support material from the build plate to the top of the lid &lt;strong>or&lt;/strong> flip the lid upside down and use supports for the four feet where the screws go. Because any sagging would be hidden inside,&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/print_orientation.jpg" alt="picture of components arranged on print bed" />
&lt;figcaption>
&lt;p>
suggested print orientation
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="components">Components&lt;/h2>
&lt;p>In addition to the miscellaneous wire and crimp connectors, there are two components used in this design:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.aliexpress.com/item/33019891423.html">PoE injector&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.amazon.com/gp/product/B07Y9HP4KM/">QC 3.0 Charger&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="assembly">Assembly&lt;/h2>
&lt;p>I don&amp;rsquo;t have any pictures from the assembly 😞, but it&amp;rsquo;s not particularly difficult to figure out from the attached pictures. In general, the steps to take are:&lt;/p>
&lt;ol start="0">
&lt;li>Print everything and clean up the parts as needed&lt;/li>
&lt;li>de-shell the PoE injector and QC3 charger. A plastic pry-tool or a few flat-head screwdrivers will help here!&lt;/li>
&lt;li>desolder the existing mains connections from both modules and solder on new ones. The new ones don&amp;rsquo;t need to be long, just a bit longer than the leads that came on the module PCBs!&lt;/li>
&lt;li>disconnect power from the assembled PSU and remove the case cover&lt;/li>
&lt;li>place the &amp;lsquo;plate&amp;rsquo; onto the top of the PSU and use a pencil to mark all 5 holes on the cover&lt;/li>
&lt;li>remove the plate, drill out all 5 holes and use a file to smooth down any sharp edges on the big hole as that&amp;rsquo;s where the mains wires will go. A burr poking through insulation means the case may become energized @ mains voltages! 💥 💀&lt;/li>
&lt;li>crimp connectors onto wires and attach to the mains supply &lt;strong>after&lt;/strong> the switch and fuse!&lt;/li>
&lt;li>place the &amp;lsquo;plate&amp;rsquo; back onto the PSU cover&lt;/li>
&lt;li>run the wires through the new hole in the top of the PSU case and through the hole in the &amp;lsquo;plate&amp;rsquo;&lt;/li>
&lt;li>add the PoE injector and QC3 module to the plate&lt;/li>
&lt;li>join the mains leads to the module leads. I used &lt;a href="https://www.amazon.com/Wago-221-413-LEVER-NUTS-Conductor-Connectors/dp/B06XGYXVXR/">Wago&lt;/a> connectors, but simple wirenuts or a screw terminal block will work.&lt;/li>
&lt;li>Use M3 screws to secure the lid to the plate and the PSU. I intentionally drilled the holes slightly too small so the screws would thread against the case. Not ideal, but works absolutely fine for something that&amp;rsquo;s not load-bearing or going to be repeatedly re-screwed.&lt;/li>
&lt;li>re-connect the IEC power connector and power on&lt;/li>
&lt;li>monitor for sounds and smells that indicate you screwed up. begin testing PoE and USB port for proper power.&lt;/li>
&lt;/ol>
&lt;p>Just prior to seating the &amp;lsquo;lid&amp;rsquo; you should have something like this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/cover-and-screws-off.jpg" alt="picture of auxiliary PSUs seated and wired" />
&lt;figcaption>
&lt;p>
components seated and wired
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>When all said and done, you&amp;rsquo;ll get this:&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/modded-assembled.jpg" alt="picture of plate and lid attached to PSU" />
&lt;figcaption>
&lt;p>
everything assembled and powered up
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="files">Files&lt;/h2>
&lt;p>The f360 file is&amp;hellip; a mess. I&amp;rsquo;m not going to share it here. Contact me if you really want it. The &lt;code>stl&lt;/code> and &lt;code>3mf&lt;/code> files are below, though. As you can tell from the initials and date, this project was &amp;lsquo;completed&amp;rsquo; awhile ago.&lt;/p>
&lt;p>For archive / posterity, all source files are included here. All files are licensed as &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike&lt;/a> (CC BY-NC-SA).&lt;/p>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/modded-assembled.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/modded-assembled_hu5e0638bd999b700992e2199b07155936_1574650_300x0_resize_q75_box.jpg" width="300" height="226">
&lt;/a>
&lt;figcaption>
&lt;small>everything assembled and powered up&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/plate_and_lid.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/plate_and_lid_hu7df47cce6e64ee651dfc4aee7a2b6320_100047_300x0_resize_q75_box.jpg" width="300" height="224">
&lt;/a>
&lt;figcaption>
&lt;small>Relevant components, colored in F360&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/models/combined.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
models/combined.3mf:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/models/lid.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/lid.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/models/plate.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/plate.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/cover-and-screws-off.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/cover-and-screws-off_hu3f72322543fc63d58d9c086dc73ec59d_2108898_300x0_resize_q75_box.jpg" width="300" height="192">
&lt;/a>
&lt;figcaption>
&lt;small>components seated and wired&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/print_orientation.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/print_orientation_huacfb77ea22eded6192e18f25c598ee63_329076_300x0_resize_q75_box.jpg" width="300" height="206">
&lt;/a>
&lt;figcaption>
&lt;small>suggested print orientation&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/rd6012-assembled.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/electronics-lab-enhanced-psu/images/rd6012-assembled_hub76e8fd9b3f797047933500d97d420d7_77086_300x0_resize_q75_box.jpg" width="300" height="300">
&lt;/a>
&lt;figcaption>
&lt;small>As seen on AliExpress&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>home lab: mini 'universal' patch panel</title><link>https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/</link><pubDate>Sun, 05 Jul 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/</guid><description>&lt;p>This is another brief &amp;ldquo;i made a thing!&amp;rdquo; posts.&lt;/p>
&lt;h2 id="version-2">Version 2&lt;/h2>
&lt;p>&lt;strong>Update 2020-12-12:&lt;/strong> I outgrew version 1! I needed a few more ports and didn&amp;rsquo;t have much time&amp;hellip; so I just scaled the part up to double the number of jacks. The links below and the thingiverse and prusaprinters links have been updated w/ the new STL files. Printing and attachment works exactly the same as with the 1x8 version. Rather than include the Fusion360 source, I have included a standard STEP file.&lt;/p>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/v2_installed_front.jpg" alt="Picture showing the new 2x8 keystone bracket installed on rack from the front." />
&lt;figcaption>
&lt;/figcaption>
&lt;/figure>
&lt;figure >
&lt;img src="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/v2_installed_rear.jpg" alt="Picture showing the new 2x8 keystone bracket installed on rack from the rear." />
&lt;figcaption>
&lt;p>
Yes, I do need to re-do the cable runs; they&amp;#39;re a mess
&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;h2 id="what">What&lt;/h2>
&lt;p>Taking the side / rear of my rack off every time I needed to change which host(s) were connected to the monitor was starting to get old. Only recently did I realize that you can fit more than just RJ45 jacks in a &lt;a href="https://en.wikipedia.org/wiki/Keystone_module">Keystone Jack&lt;/a>. A few measurements, a quick search through thingiverse and some CAD time later, this is the result.&lt;/p>
&lt;p>The model is tailored to my specific rack, but should be easily adoptable to any other dimensions. Import the Fusion360 model and then edit the first sketch in the timeline as needed and adjust the &lt;code>pattern on line&lt;/code> step to adjust the number of keystone jacks.&lt;/p>
&lt;p>Of course, you can always just glue the print to whichever surface you need it mounted on as there&amp;rsquo;s plenty of broad/flat surface for adhesive if the two built-in screw holes won&amp;rsquo;t work!&lt;/p>
&lt;p>As is, the model has:&lt;/p>
&lt;ul>
&lt;li>8 jacks&lt;/li>
&lt;li>&lt;code>178.5mm&lt;/code> from &amp;lsquo;edge&amp;rsquo; to &amp;lsquo;edge&amp;rsquo; between the two screw holes&lt;/li>
&lt;li>&lt;code>6.5mm&lt;/code> diameter for the holes as my rack uses M6 screws.&lt;/li>
&lt;/ul>
&lt;p>Note: After printing the model you see in the pictures below, I added a small cutout which should make it easier to depress the clip on the &amp;lsquo;male&amp;rsquo; end of a keystone device from the &amp;lsquo;user facing&amp;rsquo; side as you&amp;rsquo;d typically find on a proper patch panel&lt;/p>
&lt;p>All in all, I&amp;rsquo;m quite happy with how it turned out: 8 jacks is more than enough for current and (projected!) future use. The only obvious improvement would be moving the numbers from the bottom to the top where there&amp;rsquo;s more room. As it is now, the perimeters around the numbers look a bit weird as they merge w/ the bottom edge that are flush w/ the rack and the top edges that are flush w/ the jacks.&lt;/p>
&lt;p>Many thanks to &lt;a href="https://www.thingiverse.com/belfers/about">&lt;code>belfers&lt;/code>&lt;/a> for the &lt;a href="https://www.thingiverse.com/thing:3150524">Keystone model&lt;/a>.&lt;/p>
&lt;p>The details are on the &lt;a href="https://www.thingiverse.com/thing:4536257">thingiverse&lt;/a> and &lt;a href="https://www.prusaprinters.org/prints/36325-8-port-keystone-patch-panel">prusaprinters&lt;/a> page.&lt;/p>
&lt;h2 id="printing">Printing:&lt;/h2>
&lt;p>Any material and at least 10% infill should be fine.
No supports if you use the suggested print orientation shown in picture below.
Tolerances on the jacks are somewhat tight so printing at a more accurate setting is probably going to be a good idea.&lt;/p>
&lt;h2 id="files">Files&lt;/h2>
&lt;p>For archive / posterity, all source files are included here. All files are licensed as &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike&lt;/a> (CC BY-NC-SA).&lt;/p>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/rear-installed.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/rear-installed_hua3383d84163f112bd060af4ed3b8937c_1343110_300x0_resize_q75_box.jpg" width="300" height="122">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/front-installed.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/front-installed_hu41ccff79e18526a44598cc32ce35c2c7_1597423_300x0_resize_q75_box.jpg" width="300" height="127">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/models/v1_keystone-bracket.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
models/v1_keystone-bracket.3mf:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/models/v1_keystone-bracket.f3z">
&lt;i class="far fa-file-archive">&lt;/i>
models/v1_keystone-bracket.f3z:
&lt;small style="font-family:'Lucida Console', monospace">f3z&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>Fusion360 Archive&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/models/v1_keystone-bracket.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/v1_keystone-bracket.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/models/v2.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
models/v2.3mf:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/models/v2.step">
&lt;i class="far fa-file-archive">&lt;/i>
models/v2.step:
&lt;small style="font-family:'Lucida Console', monospace">step&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>STEP file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/models/v2.stl">
&lt;i class="far fa-file-code">&lt;/i>
models/v2.stl:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/print_orientation.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/print_orientation_hu76c02f2da9eb89859f866c4853e1d8f8_295257_300x0_resize_q75_box.jpg" width="300" height="227">
&lt;/a>
&lt;figcaption>
&lt;small>Suggested print orientation&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/v2_installed_front.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/v2_installed_front_hueaa041fd3e89eb8857e8d8911e38c610_2003909_300x0_resize_q75_box.jpg" width="300" height="220">
&lt;/a>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/v2_installed_rear.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/07/home-lab-mini-universal-patch-panel/images/v2_installed_rear_huc45c71727a5e03d4cd0254c0178b7cc0_903650_300x0_resize_q75_box.jpg" width="300" height="265">
&lt;/a>
&lt;figcaption>
&lt;small>Yes, I do need to re-do the cable runs; they&amp;#39;re a mess&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item><item><title>PoE at a distance caused terrible cat5 speeds</title><link>https://karlquinsland.com/2020/07/poe-at-a-distance-caused-terrible-cat5-speeds/</link><pubDate>Wed, 01 Jul 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/07/poe-at-a-distance-caused-terrible-cat5-speeds/</guid><description>&lt;p>This is a quick post for made in the hopes that some poor soul in the future will find it and save themselves some time.&lt;/p>
&lt;h2 id="background">Background&lt;/h2>
&lt;p>I&amp;rsquo;ve been experimenting with a few different ways to surface various home automation controls in the appropriate place and at a good time. One prototype host is deployed behind a small LCD under some cabinets in a high traffic area. This host is a raspberry pi 4 with a &lt;a href="https://www.raspberrypi.org/products/poe-hat/">PoE hat&lt;/a>. It boots a very stripped down version of &lt;a href="https://www.raspberrypi.org/downloads/raspberry-pi-os/">Raspberry Pi OS&lt;/a> into a web browser running in Kiosk mode.&lt;/p>
&lt;p>It&amp;rsquo;s pretty simple and does many things well. There&amp;rsquo;s a few small issues that need to be addressed in the CAD files as well as some additional electronic improvements that should be made before I can publish the design / files.&lt;/p>
&lt;p>In any event, this host has been trouble-free until recently. Simple &lt;code>apt update&lt;/code> transfers would take &lt;strong>DAYS&lt;/strong> to complete, simple &lt;code>scp&lt;/code> operations to other hosts on the LAN would trickle by at tens of kB/s. The web app that the host is primarily responsible for displaying would time out or fail to completely load resulting in some &amp;ldquo;a-for-effort&amp;rdquo; &lt;a href="https://www.mavenecommerce.com/2017/10/31/progressive-enhancement-vs-graceful-degradation/">graceful degradation&lt;/a>.&lt;/p>
&lt;h2 id="the-facts">The Facts&lt;/h2>
&lt;p>As soon as I bring up the &lt;code>wlan0&lt;/code> interface and bring down the &lt;code>eth0&lt;/code> interface performance is IMMEDIATELY restored. The web app is responsive and fully loads instantly, &lt;code>scp&lt;/code> is fast like it should be on a LAN and &lt;code>apt update&lt;/code> completes without any errors as fast as my internet connection will let it!&lt;/p>
&lt;p>&lt;strong>Conclusion&lt;/strong>: The problem is &lt;em>not&lt;/em> network related. Both the &lt;code>eth0&lt;/code> and &lt;code>wlan0&lt;/code> interface are on the same &lt;code>vLan&lt;/code> so the bizarre behavior is not likely caused by a QoS policy or firewall rule.&lt;/p>
&lt;p>The rPi and a few other hosts a powered via a a &lt;a href="https://shop.poetexas.com/products/at-4-48v120w/">120 watt&lt;/a> which is in the same closet as my core switch. Two terminations and about 200 feet of cat5 cable later, you get to the rPi host on the other side of the house.&lt;/p>
&lt;p>Continuity tester was used on every segment of the link to confirm the link is good. The segments of the link from the switch to the injector and to the patch-panel all use high quality pre-made cables, as does the final segment from the wall to the rPi. Shocker, they tested fine, just like the in-wall segment.&lt;/p>
&lt;p>Additionally, no other host on the PoE injector is misbehaving. No other host on the PoE injector is indicating that there&amp;rsquo;s not enough power, and the power supply feeding the injector isn&amp;rsquo;t even warm.&lt;/p>
&lt;p>&lt;strong>Conclusion&lt;/strong>: The cables are certainly fine and the PoE injector is &lt;em>probably fine&lt;/em>.&lt;/p>
&lt;p>Next, I disabled the PoE injector all together and use the USBC port on the rPi for power. It was just as performant as with WiFi! I did not expect this result, but it did certainly narrow down the possible problem areas.&lt;/p>
&lt;p>&lt;strong>Conclusion&lt;/strong>: The problem is only present when the host is powered via PoE.&lt;/p>
&lt;p>I was very confident that the PoE injector was not the problem, but in order to be certain, I used a second cheap PoE injector that lives on my bench power supply. Turns out, the same slow speeds manifested with the second injector, too.&lt;/p>
&lt;p>&lt;strong>Conclusion&lt;/strong>: The problem is not in the network, nor is it in the cables, nor is it in the injectors.&lt;/p>
&lt;p>This only leaves one candidate: the host. Unfortunately, there&amp;rsquo;s nothing about the host that screams &amp;ldquo;i&amp;rsquo;m the problem!&amp;rdquo;. The microSD card is new and very fast. There&amp;rsquo;s nothing in the logs indicating a hardware failure. On-device performance (via non-networking benchmarks) is inline with what i&amp;rsquo;d expect.&lt;/p>
&lt;p>Here&amp;rsquo;s two additional facts from some brief testing I did a few weeks ago. I had more or less forgotten about them and only really remembered that:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>When I tried a fresh install of Ubuntu on a fresh microSD card&amp;hellip; same slow speeds.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The host performs &lt;em>perfectly&lt;/em> when plugged into other networks.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>I was &lt;em>confident&lt;/em> then, that the rPi was not the issue and that something about the network was. But I just spent 3 hours systematically testing out every component of the network and concluding that the network is fine!&lt;/p>
&lt;p>&lt;strong>Conclusion&lt;/strong>: I&amp;rsquo;m back where I started; angry and confused.&lt;/p>
&lt;p>The &amp;ldquo;ah ha!&amp;rdquo; moment didn&amp;rsquo;t come until i decided to try my second PoE injector &lt;em>at the client&lt;/em>. Much to my surprise, &lt;strong>it worked!&lt;/strong>.&lt;/p>
&lt;p>After a bit more testing, I determined that the PoE HAT on the rPi is &amp;lsquo;fine&amp;rsquo; when the PoE source is CLOSE&amp;hellip; which probably explains the &amp;lsquo;works fine on other networks&amp;rsquo; fact above.&lt;/p>
&lt;p>That leaves just the &amp;lsquo;problem is OS independent&amp;rsquo; fact which - after thoroughly vetting every part of the network and PoE system - makes it pretty obvious that the problem must be between the rPi and the cat5 cable coming from the wall. There&amp;rsquo;s &lt;em>only&lt;/em> the PoE HAT between the rPi and the cat5 cable coming from the wall. I borrowed a PoE HAT from another host elsewhere on the network and the problematic rPi started behaving again. Network transfer speeds were appropriate and the web app / dashboard was performant again!&lt;/p>
&lt;p>&lt;strong>Conclusion&lt;/strong>: the PoE HAT powering a home automation dashboard has failed in such a way that makes the &lt;code>eth0&lt;/code> interface all but useless. replacing the HAT solved the problem.&lt;/p>
&lt;h2 id="tldr">TL;DR:&lt;/h2>
&lt;p>Several months ago, the home automation dashboard displayed on a PoE powered rPi 4 started to act up. Further investigation showed absolute crap network performance from the host to any other point on the LAN or WAN. After testing each component in isolation, the PoE HAT was the only reaming suspect. After further investigation, the failure mode is &lt;em>not present&lt;/em> when the PoE source is &lt;em>close&lt;/em> to the client, only when the source is far from the client.&lt;/p>
&lt;p>So if you have a PoE powered rPi project out there w/ abysmal &lt;code>eth0&lt;/code> performance, try replacing the PoE hat&amp;hellip;&lt;/p>
&lt;p>Also, if anybody knows &lt;em>why&lt;/em> this happened, I&amp;rsquo;d love to know.&lt;/p></description></item><item><title>Hello World</title><link>https://karlquinsland.com/2020/06/hello-world/</link><pubDate>Sat, 27 Jun 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/06/hello-world/</guid><description>&lt;p>Blowing the dust off the domain, trying Hugo out.&lt;/p>
&lt;p>&lt;em>tap&lt;/em> &lt;em>tap&lt;/em> Is this thing on?&lt;/p></description></item><item><title>home lab: consolidating multiple PSUs</title><link>https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/</link><pubDate>Sat, 27 Jun 2020 00:00:00 +0000</pubDate><guid>https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/</guid><description>&lt;p>A while back, I traded writing salt states and managing systemd &lt;code>.service&lt;/code> files wrapping &lt;code>podman&lt;/code> for the &lt;a href="https://www.youtube.com/watch?v=9wvEwPLcLcA">&amp;lsquo;simplicity&amp;rsquo;&lt;/a> of running kubernetes in my home lab. Jury is still out on weather or not the switch was worth it.&lt;/p>
&lt;p>The cluster is a hodgepodge of second hand Intel NUCs and other scavenged compute hardware i&amp;rsquo;ve collected over the past few years. Some of it runs on 12v, some of it on 19v. For each node, there&amp;rsquo;s a dedicated switch mode power supply. Each supply takes up an outlet and brings a bit of cable mgmt related clutter. The solution is consolidation.&lt;/p>
&lt;p>So thats how this project came to be.&lt;/p>
&lt;h2 id="what">What&lt;/h2>
&lt;p>A set of 3d printable parts to compactly combine two LRS-350 PSUs into a compact unit with optional voltage and current displays.&lt;/p>
&lt;p>The details are on the &lt;a href="https://www.thingiverse.com/thing:4504948">thingiverse&lt;/a> and &lt;a href="https://www.prusaprinters.org/prints/35514-dual-mean-well-lrs-350-psu">prusaprinters&lt;/a> page.&lt;/p>
&lt;h2 id="files">Files&lt;/h2>
&lt;p>For archive / posterity, all source files are included here. All files are licensed as &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike&lt;/a> (CC BY-NC-SA).&lt;/p>
&lt;ul>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/built.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/built_hue8f36c4f699ca512381ec1ecdae0f96e_1394325_300x0_resize_q75_box.jpg" width="300" height="189">
&lt;/a>
&lt;figcaption>
&lt;small>Fully Assembled; ignore the messy workbench&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/cad-back.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/cad-back_hu9cc2ce5e929a14998f22cb542d786aa7_342135_300x0_resize_q75_box.jpg" width="300" height="215">
&lt;/a>
&lt;figcaption>
&lt;small>component view, from rear&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/cad-front.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/cad-front_hue2810dd6e158cf3715e15de998852c44_365005_300x0_resize_q75_box.jpg" width="300" height="220">
&lt;/a>
&lt;figcaption>
&lt;small>component view, from front&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/core.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/core_hue43f3402df27eedd99dff8c904086e8c_310336_300x0_resize_q75_box.jpg" width="300" height="219">
&lt;/a>
&lt;figcaption>
&lt;small>Print Bed arrangement, green is support structures&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/meter-panel.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/meter-panel_hu546d99e5993001046c71e4a3333af77d_135643_300x0_resize_q75_box.jpg" width="300" height="267">
&lt;/a>
&lt;figcaption>
&lt;small>meter panel print orientation&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/models/2x-lrs-psu.f3z">
&lt;i class="far fa-file-archive">&lt;/i>
Consolidated PSU CAD:
&lt;small style="font-family:'Lucida Console', monospace">f3z&lt;/small> &lt;small>file&lt;/small>
&lt;br>
&lt;small>Fusion360 Archive&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/models/box.stl">
&lt;i class="far fa-file-code">&lt;/i>
Box:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/models/brace.stl">
&lt;i class="far fa-file-code">&lt;/i>
Brace:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/models/core.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
Core Components:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/models/lid.stl">
&lt;i class="far fa-file-code">&lt;/i>
Lid:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/models/meter-panel.3mf">
&lt;i class="far fa-file-archive">&lt;/i>
(Optional) Meter Panel:
&lt;small style="font-family:'Lucida Console', monospace">3mf&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/models/meter-panel.stl">
&lt;i class="far fa-file-code">&lt;/i>
(Optional) Meter Panel:
&lt;small style="font-family:'Lucida Console', monospace">stl&lt;/small> &lt;small>file&lt;/small>
&lt;/a>
&lt;/li>
&lt;li>
&lt;figure>
&lt;a target="_blank" href="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/meter-panel-slice.jpg">
&lt;img style="width: auto; height: auto;" src="https://karlquinsland.com/2020/06/home-lab-consolidating-multiple-psus/images/meter-panel-slice_hu512c49ce3497e3dea530288ed57cb214_547680_300x0_resize_q75_box.jpg" width="300" height="255">
&lt;/a>
&lt;figcaption>
&lt;small>using slic3r too remove the second meter cutout&lt;/small>
&lt;/figcaption>
&lt;/figure>
&lt;/li>
&lt;/ul></description></item></channel></rss>
<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Two quick tricks for better HomeAssistant automations - karl</title><meta name=Description content="Simple techniques for cleaner and more powerful automations/templates"><meta property="og:url" content="https://karlquinsland.com/two-tricks-for-better-homeassistant-automations/"><meta property="og:site_name" content="karl"><meta property="og:title" content="Two quick tricks for better HomeAssistant automations"><meta property="og:description" content="Simple techniques for cleaner and more powerful automations/templates"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-23T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-23T00:00:00+00:00"><meta property="article:tag" content="Short-Posts"><meta property="article:tag" content="Home-Automation"><meta property="og:image" content="https://karlquinsland.com/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://karlquinsland.com/images/avatar.webp"><meta name=twitter:title content="Two quick tricks for better HomeAssistant automations"><meta name=twitter:description content="Simple techniques for cleaner and more powerful automations/templates"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://karlquinsland.com/two-tricks-for-better-homeassistant-automations/><link rel=prev href=https://karlquinsland.com/ws3-weather-station-pm25-sensor/><link rel=next href=https://karlquinsland.com/enhanced-homeassistantswitchplate/><link rel=stylesheet href=/css/style.min.658eb25b73ad29ab864a36ed014516c5047802d1ff98d0080132d1abe1332f5b.css integrity="sha256-ZY6yW3OtKauGSjbtAUUWxQR4AtH/mNAIATLRq+EzL1s="><link rel=preload href=/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0="></noscript><link rel=preload href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8="></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Two quick tricks for better HomeAssistant automations","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/karlquinsland.com\/two-tricks-for-better-homeassistant-automations\/"},"genre":"posts","keywords":"short-posts, home-automation","wordcount":1290,"url":"https:\/\/karlquinsland.com\/two-tricks-for-better-homeassistant-automations\/","datePublished":"2020-09-23T00:00:00+00:00","dateModified":"2020-09-23T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"karl"},"description":"Simple techniques for cleaner and more powerful automations/templates"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-blog"></i> Posts </a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i> Résumé </a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i> Tags </a><a class=menu-item href=/contact/><i class="fas fa-address-book"></i> Contact </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title><i class="fas fa-blog"></i>Posts</a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i>Résumé</a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i>Tags</a><a class=menu-item href=/contact/ title><i class="fas fa-address-book"></i>Contact</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Two quick tricks for better HomeAssistant automations</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>karl</a></span>&nbsp;<span class=post-category>included in <a href=/categories/posts/><i class="far fa-folder fa-fw" aria-hidden=true></i>Posts</a>&nbsp;<a href=/categories/home-assistant/><i class="far fa-folder fa-fw" aria-hidden=true></i>Home Assistant</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-09-23>2020-09-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1290 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#slightly-easier-to-maintain-templates>(slightly) easier to maintain templates</a></li><li><a href=#use-input_-in-the-trigger-for-an-automation>Use <code>input_*</code> in the <code>trigger</code> for an automation</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>It&rsquo;s hard to believe, but the venerable Home Assistant project has just celebrated it&rsquo;s <a href=https://www.home-assistant.io/blog/2020/09/17/release-115/ target=_blank rel="noopener noreffer"><strong>7th</strong> birthday with release <code>.115</code></a>! While HA does get better with each new release, it is by no means perfect :D. This post came about because of a new feature in release <code>.115</code> and the subsequent limitations of that feature!</p><p>In the course of trying to integrate Home Assistant with all the things, everybody eventually hits some major limitation or bug and is forced to find some sort of workaround. Below are a few techniques that I&rsquo;ve collected over the years to simplify some of my Home Assistant configuration and work around some of the platforms various limitations.</p><p>To be sure, nothing below is new or groundbreaking. I am just presenting how I use them in the hopes that they end up being useful to anybody else that googles similar problems.</p><h3 id=slightly-easier-to-maintain-templates>(slightly) easier to maintain templates</h3><p>Sometimes, you&rsquo;ll have many entities in a given <a href=https://www.home-assistant.io/docs/configuration/templating/ target=_blank rel="noopener noreffer">template</a> and - depending on the complexity of the template - you may need to refer to each entity multiple times. This is a simple technique that allows you define the list of entities one time and refer to them as needed throughout the template in a succinct way. This makes the template a bit cleaner / shorter which inturn makes it easier to maintain.</p><p>To illustrate the technique, I&rsquo;ve reproduced a <a href=https://www.home-assistant.io/integrations/template/ target=_blank rel="noopener noreffer">template sensor</a> that averages all of the different particulate matter readings from my <a href=/ws3-weather-station-pm25-sensor/ rel>outdoor weather station</a> into a single number. <strong>Bonus:</strong> this approach works around the &lsquo;only one entity&rsquo; limit with the <a href=https://www.home-assistant.io/integrations/statistics/ target=_blank rel="noopener noreffer">statistics</a> platform!</p><p>I want to get an average of 6 different entities:</p><ul><li>sensor.ws3_pm_0_3mm</li><li>sensor.ws3_pm_0_5mm</li><li>sensor.ws3_pm_10_0mm</li><li>sensor.ws3_pm_1_0mm</li><li>sensor.ws3_pm_2_5mm</li><li>sensor.ws3_pm_5_0mm</li></ul><p>Since each entity is nearly the same, it&rsquo;s far easier to only store the small portion of the entity ID that is unique and programmatically generate the full entity ID once throughout the template.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># In an ideal world, I would use use the AQI metric, but the data that the WS3 exposes to me does not have the correct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   units. AQI needs PPM but I have units in particles per Litre of air. In order to turn the unit I have into a PPM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   I need to make some guesses about the actual chemical content of the air / know the mass of each particle. Not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   impossible... but why bother? I can generate my own metric which wll be functionally equivalent to AQI.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   A single number that represents the state of the air; the higher the number, the more particles in the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   air, the less healthy the air.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># The &#39;stats&#39; sensor platform in HA does not support multiple entity IDs, unfortunately, so I have to do it w/ a template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   sensor.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://community.home-assistant.io/t/get-average-of-multiple-temperature-sensors/4050/4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sensors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>average_particulate_count</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>unique_id</span><span class=p>:</span><span class=w> </span><span class=l>ws3_particulate_matter_sensor_average</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>friendly_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Average Particulate Count&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;particles / .1L Air&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value_template</span><span class=p>:</span><span class=w> </span><span class=p>&gt;-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        {## We need to use namespace() so the accumulator exists outside of the loop scope ##}
</span></span></span><span class=line><span class=cl><span class=sd>        {% set accumulator = namespace(value=0.0) %}
</span></span></span><span class=line><span class=cl><span class=sd>        {## The sensors all have the same prefix so we  store only the particulate size / suffix ##}
</span></span></span><span class=line><span class=cl><span class=sd>        {% set counts = [&#39;0_3mm&#39;, &#39;0_5mm&#39;, &#39;10_0mm&#39;, &#39;1_0mm&#39;,&#39;2_5mm&#39;, &#39;5_0mm&#39;,] %}
</span></span></span><span class=line><span class=cl><span class=sd>        {% for ct in counts -%}
</span></span></span><span class=line><span class=cl><span class=sd>          {% set val = states(&#34;sensor.ws3_pm_&#34;+ct) | float %}
</span></span></span><span class=line><span class=cl><span class=sd>          {% set accumulator.value = accumulator.value + val %}
</span></span></span><span class=line><span class=cl><span class=sd>        {%- endfor %}
</span></span></span><span class=line><span class=cl><span class=sd>        {## Sum up all the counts and device by the number of things and round the number ##}
</span></span></span><span class=line><span class=cl><span class=sd>        {{ (accumulator.value/(counts|length))|round(2)}}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=use-input_-in-the-trigger-for-an-automation>Use <code>input_*</code> in the <code>trigger</code> for an automation</h3><p>The &rsquo;new&rsquo; feature in <code>.115</code> that I eluded to is support for using various <a href=https://www.home-assistant.io/blog/2020/09/17/release-115/#use-input_-helpers-in-conditions target=_blank rel="noopener noreffer"><code>input_*</code> objects in the <code>condition</code> section of an automation</a>. This makes it possible to modify the parameters of an automation at run time! This was possible in the past, but would require a Rube Goldberg-esque setup chaining multiple templates/inputs/automations together; it was a mess to build and maintain!</p><p>Unfortunately, there is no support for <code>input_*</code> helpers in the <em>trigger</em> section of an automation. As of release <code>.115</code>, it is impossible to do something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>some-example-pipe-dream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Use a input_number with a trigger block</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trigger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>numeric_state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_id</span><span class=p>:</span><span class=w> </span><span class=l>sensor.temperature</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>above</span><span class=p>:</span><span class=w> </span><span class=l>input_number.max_temp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>below</span><span class=p>:</span><span class=w> </span><span class=l>input_number.min_temp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>for</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>minutes</span><span class=p>:</span><span class=w> </span><span class=l>input_number.temp_automation_time_threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Turn the fan on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>switch.turn_on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entity_id</span><span class=p>:</span><span class=w> </span><span class=l>switch.dream-machine</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>If we can find an alternate way to trigger that automation, then we can move the comparison w/ the dynamic value to the <code>condition</code> block which brings our pipe-dream closer to reality :D. Fortunately, a significant number of automations do not require <em>real time</em> triggering so if we can &lsquo;settle&rsquo; for an automation that may be delayed by a brief interval then we can use the cron-like <a href=https://www.home-assistant.io/docs/automation/trigger/#time-pattern-trigger target=_blank rel="noopener noreffer"><code>time_pattern</code></a> trigger to launch the part of the automation that we care about. In short, changing an automation from a push based trigger to a poll based trigger.</p><p>Here is an example automation that turns a bathroom fan on if the humidity in the bathroom rises above a user-configured threshold. The humidity sensor is battery powered and reports the humidity only on changes or after several seconds (whichever is longer). This means that the automation is <em>already</em> not going to trigger in &lsquo;real time&rsquo; so what&rsquo;s the harm in delaying it&rsquo;s activation by a few more seconds?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>bathroom-fan-on-until-humidity-below-threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Turns on ventilation fan once humidity gets out of hand</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trigger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>time_pattern</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Behaves just like cron</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># See: https://www.home-assistant.io/docs/automation/trigger/#time-pattern-trigger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Every 30 seconds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>seconds</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/30&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># We *also* want to re-run the conditional check as soon as the value of the numeric input changes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entity_id</span><span class=p>:</span><span class=w> </span><span class=l>input_number.bath_fan_humidity_threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># The approach below is the &#39;traditional&#39; way that only triggers the automation the &#39;optimal&#39; number of times;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   only when the sensor state changes.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># This is also the only way to use the very helpful above/below + for blocks but comes at the expense of not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   being able to modify the conditions using the input_* helpers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># - platform: state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   entity_id: sensor.bathroom_humidity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   above: input_number.max_temp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   below: input_number.min_temp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   for:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#     minutes: input_number.temp_automation_time_threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>condition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Compare the humidity value to the &#39;low&#39; value. If we&#39;re above this, we turn the fan on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># TODO: Next month of WTF, it would be lovely if we could have templates here so quickly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   bang out an expression like {{(input_number.some_input + 10)}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=l>numeric_state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entity_id</span><span class=p>:</span><span class=w> </span><span class=l>sensor.bathroom_humidity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>above</span><span class=p>:</span><span class=w> </span><span class=l>input_number.bath_fan_humidity_threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Turn the fan on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>switch.turn_on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entity_id</span><span class=p>:</span><span class=w> </span><span class=l>switch.bathroom_fan</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>Yes, I absolutely could&rsquo;ve used the <a href=https://www.home-assistant.io/docs/automation/trigger/#state-trigger target=_blank rel="noopener noreffer"><code>state</code></a> trigger to fire off the contrition check every time that a new humidity reading came in. I chose to use the &lsquo;cron&rsquo; approach to illustrate how to make this technique work for two reasons:</p><ol><li>I find the <code>state</code> trigger to be useful when combined with the <code>above:</code> / <code>below:</code> and <code>for:</code> &lsquo;modifiers&rsquo;. Currently, those modifiers are only supported in the <code>trigger</code> block and therefore can&rsquo;t be configured with <code>input_*</code>. The whole point is to have some aspects of the automation that can be adjusted at run time w/o having to edit the automation.</li><li>Some automations may not have a reliable/consistent push-based trigger event that they can use. In these cases, a regular polling approach is the only &lsquo;fall back&rsquo;.</li></ol></div></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-09-23</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/two-tricks-for-better-homeassistant-automations/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/short-posts/>Short-Posts</a>,&nbsp;<a href=/tags/home-automation/>Home-Automation</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/ws3-weather-station-pm25-sensor/ class=prev rel=prev title="Adding an airborne particulate mater sensor to WS3 Weather Station"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Adding an airborne particulate mater sensor to WS3 Weather Station</a>
<a href=/enhanced-homeassistantswitchplate/ class=next rel=next title="Enhanced Home Assistant Switch Plate (HASP)">Enhanced Home Assistant Switch Plate (HASP)<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>¯\_(ツ)_/¯</div><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.152.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>karl</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.76e39bd605d45b2d1944123c66608b0c8bb9baeb70720b212571531c7cf9bc2a.css integrity="sha256-duOb1gXUWy0ZRBI8ZmCLDIu5uutwcgshJXFTHHz5vCo="><script type=text/javascript src=/lib/autocomplete/autocomplete.min.ae2da1bd62c6469ee27770ad1cddf2e8296d8a7f6d85b091463e5200c5e320af.js integrity="sha256-ri2hvWLGRp7id3CtHN3y6Cltin9thbCRRj5SAMXjIK8="></script><script type=text/javascript src=/lib/lunr/lunr.min.08a93c0120364b01159db3c287f39b2180bb740334472bda0675bd3f18981676.js integrity="sha256-CKk8ASA2SwEVnbPCh/ObIYC7dAM0RyvaBnW9PxiYFnY="></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.3d9120fa621da6d613c1698b7014ec6bdf4620366e8f2b7b547059f4b6f6272b.js integrity="sha256-PZEg+mIdptYTwWmLcBTsa99GIDZujyt7VHBZ9Lb2Jys="></script><script type=text/javascript src=/lib/clipboard/clipboard.min.e17a1d816e13c0826e0ed7febfabc3277f45571234bde0bf9120829a7169edc9.js integrity="sha256-4XodgW4TwIJuDtf+v6vDJ39FVxI0veC/kSCCmnFp7ck="></script><script type=text/javascript src=/lib/katex/katex.min.eb18207487161674e717087c317db14ac1a62dadaecccb802499ce173bfeb739.js integrity="sha256-6xggdIcWFnTnFwh8MX2xSsGmLa2uzMuAJJnOFzv+tzk="></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.cb7f4ca60ed5dc3e258415f8c7a3b46d4a93578a52adf83011f18a7f190e7602.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.52ce78fab4860d24ef22128a52ce24ca01368a9034457a565a1d3fccbab0ddbb.js integrity="sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.5c0a121a8b490afc85860a522347aeb34fb508c6b23044e5d29f6b2194227b51.js integrity="sha256-XAoSGotJCvyFhgpSI0eus0+1CMayMETl0p9rIZQie1E="></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.612a51a43205bbcf3b4af348dc2e8aa60f77f4fe5535ebc57f13054b61607d6c.js integrity="sha256-YSpRpDIFu887SvNI3C6Kpg939P5VNevFfxMFS2FgfWw="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3WZ55XG701",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-3WZ55XG701" async></script></body></html>
<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>ESPHome for Sonoff T5 family of Switches - karl</title><meta name=Description content="... and a brief teardown of the US version."><meta property="og:url" content="https://karlquinsland.com/sonoff-t5-esphome/">
<meta property="og:site_name" content="karl"><meta property="og:title" content="ESPHome for Sonoff T5 family of Switches"><meta property="og:description" content="... and a brief teardown of the US version."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-11T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-11T00:00:00+00:00"><meta property="article:tag" content="Esphome"><meta property="article:tag" content="Home-Assistant"><meta property="og:image" content="https://karlquinsland.com/sonoff-t5-esphome/images/pcb.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://karlquinsland.com/sonoff-t5-esphome/images/pcb.jpg"><meta name=twitter:title content="ESPHome for Sonoff T5 family of Switches"><meta name=twitter:description content="... and a brief teardown of the US version."><meta name=twitter:site content="@somerandomguy"><meta name=application-name content="karl"><meta name=apple-mobile-web-app-title content="karl"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://karlquinsland.com/sonoff-t5-esphome/><link rel=prev href=https://karlquinsland.com/yeelight-monitor-lamp-teardown-esphome/><link rel=next href=https://karlquinsland.com/pulse-eight-hdmi-cec-injector-teardown/><link rel=stylesheet href=/lib/normalize/normalize.min.055364f5be272caa092b0e6654c165828707f8ab971e2656383a6d6392bc345e.css integrity="sha256-BVNk9b4nLKoJKw5mVMFlgocH+KuXHiZWODptY5K8NF4="><link rel=stylesheet href=/css/style.min.1e2694bed152fa2922dbe909a441838ed693d88b1330f97485bfa8ed78da42df.css integrity="sha256-HiaUvtFS+iki2+kJpEGDjtaT2IsTMPl0hb+o7XjaQt8="><link rel=stylesheet href=/lib/fontawesome-free/all.min.876d023d9d10c97941b80c3b03e2a5b94631ff7a4af9cee5604a6a2d39718d84.css integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ="><link rel=stylesheet href=/lib/animate/animate.min.3c770e90f98eb21b0c042fafb49755af93306fbaf42e449524f94fae9fc83295.css integrity="sha256-PHcOkPmOshsMBC+vtJdVr5Mwb7r0LkSVJPlPrp/IMpU="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ESPHome for Sonoff T5 family of Switches","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/karlquinsland.com\/sonoff-t5-esphome\/"},"genre":"posts","keywords":"esphome, home assistant","wordcount":9554,"url":"https:\/\/karlquinsland.com\/sonoff-t5-esphome\/","datePublished":"2023-11-11T00:00:00+00:00","dateModified":"2023-11-11T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":"... and a brief teardown of the US version."}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-blog"></i> Posts </a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i> Résumé </a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i> Tags </a><a class=menu-item href=/contact/><i class="fas fa-address-book"></i> Contact </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title><i class="fas fa-blog"></i>Posts</a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i>Résumé</a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i>Tags</a><a class=menu-item href=/contact/ title><i class="fas fa-address-book"></i>Contact</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">ESPHome for Sonoff T5 family of Switches</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Author</a></span>&nbsp;<span class=post-category>included in <a href=/categories/teardown/><i class="far fa-folder fa-fw"></i>Teardown</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-11-11>2023-11-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;9554 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;45 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#esphome-for-sonoff-t5-family-of-switches>ESPHome for Sonoff T5 family of Switches</a><ul><li><a href=#brief-hardware-overview>Brief hardware overview</a><ul><li><a href=#led-locations>LED locations</a></li></ul></li><li><a href=#t5-improvements-over-m5>T5 improvements over M5</a><ul><li><a href=#small-touch-area>Small Touch Area</a></li><li><a href=#indicating-touch-zone-and-relay-state>Indicating touch zone and relay state</a></li></ul></li><li><a href=#esphome-configuration>ESPHome Configuration</a><ul><li><a href=#features>Features</a><ul><li><a href=#indicator--template-light>Indicator / &ldquo;Template&rdquo; Light</a></li><li><a href=#regimes>Regimes</a></li><li><a href=#dynamic-timer>Dynamic Timer</a></li></ul></li></ul></li><li><a href=#yaml>YAML</a><ul><li><a href=#file-structure>File structure</a><ul><li><a href=#garageyaml><code>garage.yaml</code></a></li><li><a href=#packagesbaseesphomeyaml><code>packages/base.esphome.yaml</code></a></li><li><a href=#packagesbaseyaml><code>packages/base.yaml</code></a></li><li><a href=#packagesbuzzeryaml><code>packages/buzzer.yaml</code></a></li><li><a href=#packagescountdown-timeryaml><code>packages/countdown-timer.yaml</code></a></li><li><a href=#packageslight-automationsyaml><code>packages/light-automations.yaml</code></a></li><li><a href=#packagesstatus_ledyaml><code>packages/status_led.yaml</code></a></li><li><a href=#packagestemplate_lighth><code>packages/template_light.h</code></a></li><li><a href=#packagestouch_disableyaml><code>packages/touch_disable.yaml</code></a></li><li><a href=#packagesvariantc3yaml><code>packages/variant.c3.yaml</code></a></li></ul></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=esphome-for-sonoff-t5-family-of-switches>ESPHome for Sonoff T5 family of Switches</h1><p>It&rsquo;s hard to beat Sonoff switches when it comes to well-made, affordable, Home Assistant compatible switches.
Ever since they announced the <a href=https://sonoff.tech/product/smart-wall-switches/tx-ultimate/ target=_blank rel="noopener noreffer">T5 series</a>, I&rsquo;ve been patiently waiting for the US variant to become available so I could replace my M5 switches with T5 switches.</p><p>Don&rsquo;t get me wrong, the M5 switches are great&mldr; but <a href=#t5-improvements-over-m5 rel>not perfect</a>.</p><p>The T5 switches improve on the M5 limitations with some new and novel hardware features.
Taking advantage of these unique features requires a considerably more complex <a href=#esphome-configuration rel>ESPHome configuration</a> than the M5 series switches.</p><p>But before diving into the configuration, let&rsquo;s briefly take a closer look at the hardware.</p><h2 id=brief-hardware-overview>Brief hardware overview</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>Everything I&rsquo;m going to cover below is for the US version.</p><p>Presumably the international version has a different layout and total number of LEDs.</p></div></div></div><p>The T5 series follows the &ldquo;two part&rdquo; design of the M5 switches; there&rsquo;s a &ldquo;base&rdquo; that gets mounted in the wall and then the &ldquo;face plate&rdquo; that snaps on to the base.
All high-voltage electronics stay in the base and the face plate is just a PCB with a touch sensor and LEDs.
As far as I can tell, the face plates are interchangeable between the 1, 2, 3 and 4 relay variants but only within the same family; the physical features that mate the face plate to the base differ between M and T series switches.</p><p>The one bit of information that <a href=https://github.com/SmartHome-yourself/sonoff-tx-ultimate-for-esphome/issues/15 target=_blank rel="noopener noreffer">doesn&rsquo;t seem to be readily available online</a> is the location of the LEDs on the PCB, specifically the US version.</p><h3 id=led-locations>LED locations</h3><p>For the US version, there are 32 LEDs around the perimeter of the switch; 6 on the top, 6 on the bottom, and 10 on each side.</p><figure><img src=/sonoff-t5-esphome/images/pcb.jpg alt="Clear shot of the PCB showing location of each LED. This is from the rear so the numbers on the right will be on the left when looking at the front of the switch."><figcaption><p>Clear shot of the PCB showing location of each LED. This is from the rear so the numbers on the right will be on the left when looking at the front of the switch.</p></figcaption></figure><p>From the front of the switch, mounted in traditional &ldquo;tall&rdquo; orientation:</p><ul><li>Top right corner going down the right side
LED 32, 1-9</li><li>Bottom right corner going across the bottom to the left
LED 10-15</li><li>Bottom left corner going up the left side
LED 16-25</li><li>Top left corner going across the top to the right
LED 26-31</li></ul><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>Note that the silk screen on the PCB starts counting at 1 but ESPHome starts counting at 0.</div></div></div><h2 id=t5-improvements-over-m5>T5 improvements over M5</h2><p>My issues with the M5 switches can be broadly summarized as:</p><ul><li>The physical touch targets are <strong>TINY</strong> relative to the size of the switch face.</li><li>There&rsquo;s only a <strong>TINY</strong> single-color LED that indicates the state of the switch <em>and</em> where the user should touch to trigger the relay.</li></ul><h3 id=small-touch-area>Small Touch Area</h3><p>The <code>1C</code> variant has the largest touch area but it&rsquo;s still only about 50% of the switch face.
As you increase the number of relays, the area dedicated to each physical touch zone decreases which makes it harder to press.</p><p>If you&rsquo;re coming into a room with arms full of groceries and you try to hit one of the buttons on the <code>3C</code> variant with your elbow, you&rsquo;re going to have a bad time.
There&rsquo;s no reason why the physical touch zones couldn&rsquo;t use the entire surface of the switch.</p><figure><img src=/sonoff-t5-esphome/images/sonoff_m5_series.webp alt="Unlike the International version of the M5 series, the US version doesn't use the full surface of the switch for touch input."><figcaption><p>Unlike the International version of the M5 series, the US version doesn't use the full surface of the switch for touch input.</p></figcaption></figure><p>The T5 series fixes this by making the entire surface of the switch touch sensitive!</p><figure><img src=/sonoff-t5-esphome/images/sonoff_full_touch.webp alt="Instead of a single touch zone, the entire surface is touch sensitive."><figcaption><p>Instead of a single touch zone, the entire surface is touch sensitive.</p></figcaption></figure><p>This introduces a <em>new</em> problem, though, how do you know where to touch to toggle a given output?
Look at these two styles of face plates for the T5 series and see if you can identify which belongs to the 1, 2, 3 and 4 relay variants:</p><figure><img src=/sonoff-t5-esphome/images/sonoff_t5_faceplates.webp alt="Which face plate belongs to which variant? You can't tell just by looking at them!"><figcaption><p>Which face plate belongs to which variant? You can't tell just by looking at them!</p></figcaption></figure><p><strong>You can&rsquo;t.</strong></p><p>If you look <strong>really close</strong>, you can see <em>very</em> faint delineation lines between the touch zones but it&rsquo;s not obvious at a glance and it certainly will not be obvious to guests looking at the switch from across the room.
Trying to figure out where to touch in a <em>dark</em> room is even harder.</p><p>We can solve this with the LEDs around the perimeter of the switch, though!</p><h3 id=indicating-touch-zone-and-relay-state>Indicating touch zone and relay state</h3><p>The M5 switches have a single red LED for each physical button that is fully illuminated when the relay is on.
As a group, these indicator LEDs can be dimmed to indicate where to touch to trigger the relay.</p><figure><img src=/sonoff-t5-esphome/images/sonoff_m5_led.webp alt="You can _clearly_ tell that this is a 3 relay variant and the left most relay is ON."><figcaption><p>You can _clearly_ tell that this is a 3 relay variant and the left most relay is ON.</p></figcaption></figure><p>To get a comparable visual indicator, we can use the LEDs around the perimeter of the touch panel; split the LEDs on the sides into groups; one group per relay/touch-area.</p><p>Instead of using LEDs on both the right and left side together, alternate which side is lit up to indicate the state of the relay; if the LEDs on the left are lit up, the relay is on and if the LEDs on the right are lit up, the relay is off.</p><p>Given this picture, you can <em>clearly</em> tell that this T5 switch supports two touch areas and both relays are currently off:</p><figure><img src=/sonoff-t5-esphome/images/2c_side-example.jpg alt="Please ignore the smudge on the bottom half of the switch that I didn't notice until after I took the picture."><figcaption><p>Please ignore the smudge on the bottom half of the switch that I didn't notice until after I took the picture.</p></figcaption></figure><p>This is a <em>huge</em> improvement over the M5 series switches but it comes with a cost: complexity.
The T5 comes in 1, 2, 3 and 4 relay variants.
Each relay means a set of lights that need to be controlled.
Excluding the RGB LEDs on the top/bottom of the switch, this gives us up to 8 partition lights that we need to create in the ESPHome configuration.</p><h2 id=esphome-configuration>ESPHome Configuration</h2><p>Here&rsquo;s what the UI looks like for the 1 relay variant.</p><figure><img src=/sonoff-t5-esphome/images/ha01.png alt="1 Relay variant with timer for light counting down."><figcaption><p>1 Relay variant with timer for light counting down.</p></figcaption></figure><p>For a single switch that has just a single relay, there&rsquo;s an awful lot going on here as the copious amount of <code>yaml</code> <a href=#file-structure rel>below</a> will demonstrate.
Normally I&rsquo;d just show the <code>yaml</code> with comments in the relevant sections but there&rsquo;s a few &ldquo;features&rdquo; that I want to detail first before diving into how they are implemented.</p><h3 id=features>Features</h3><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>Home Assistant orders entities alphabetically and does not offer any way to cluster related entities together.
I&rsquo;m going in the same order that they appear in the screenshot above even though it&rsquo;ll seem like I&rsquo;m jumping around a bit.</div></div></div><p><strong>Controls:</strong></p><ul><li><code>light.{Bottom,Top}</code>: These are the bottom/top <a href=https://esphome.io/components/light/partition.html target=_blank rel="noopener noreffer">partitions</a> of the RGB LEDs around the perimeter of the switch. I don&rsquo;t use them for anything in the ESPHome configuration but they are exposed to Home Assistant so that I can use them for other automations and notifications. Think &ldquo;pulse the top LEDs on the front-door switch when the garage door is open&rdquo; &mldr;</li><li><code>light.Mood Light</code>: This is the entire ring of RGB LEDs around the perimeter of the switch. Like the Top/Bottom lights, I don&rsquo;t use this for anything explicitly in the ESPHome configuration but it is exposed to Home Assistant so that I can use it for other automations and notifications.</li><li><code>light.Light</code>: This is the actual light entity that is controlled by the relay.</li></ul><p><strong>Configuration:</strong></p><ul><li><code>button.{Daytime,Nighttime} Mode</code>: These act as simple &ldquo;one touch&rdquo; buttons that set the <code>light.Indicator</code> to a hardcoded color/brightness for a given <a href=#regimes rel>regime</a>.</li><li><code>button.Determine Mode</code>: This is a manual trigger for an otherwise automatic script that determines which <a href=#regimes rel>regime</a> to use.</li><li><code>light.Indicator</code>: This is a <a href=#indicator--template-light rel>&ldquo;template&rdquo; light</a> that wraps the set of lights that indicate the state of the relay and touch zone.</li><li><code>number.Light Timer</code>: This is a <a href=#dynamic-timer rel>dynamic timer</a> that is used to turn off the light after a given amount of time. A sane default value is chosen but it can be overridden from the Home Assistant UI if needed. Example: normally, keep the bathroom fan on for 30 minutes unless taking a long and luxurious bath, then adjust the timer for 90 minutes.</li><li><code>button.Light Timer Restart</code>: Restarts the dynamic timer for the light. Useful for extending the amount of time the light is on if, for example, Home Assistant detects that the room is still occupied.</li><li><code>switch.Light Timer</code>: Toggle to control if the dynamic timer should be armed or not.</li><li><code>switch.Sun position changes light regime</code>: Toggle to control if the sun position should trigger a change in the <a href=#regimes rel>regime</a>.</li><li><code>switch.Touch Enable</code>: Toggle to control if the touch sensor inputs should be processed or ignored.</li></ul><p><strong>Diagnostic:</strong></p><ul><li><code>text.Light Timeout Time Remaining</code>: This is a <a href=https://esphome.io/components/text_sensor/template.html target=_blank rel="noopener noreffer">template text</a> that displays the remaining time on the <a href=#dynamic-timer rel>dynamic timer</a>. Useful for triggering other automations when the timer is about to expire.</li></ul><h4 id=indicator--template-light>Indicator / &ldquo;Template&rdquo; Light</h4><p>Remember that the <a href=#indicating-touch-zone-and-relay-state rel>solution</a> to the &ldquo;where do I touch to toggle / what&rsquo;s the current state of the&rdquo; relay problem is to use the LEDs around the perimeter of the switch.
Specifically, cut the LEDs on left and right side into groups and then associate each left/right pair with a relay/touch zone.</p><p>This will result in two &ldquo;lights&rdquo; for <em>each</em> relay; one for the &ldquo;on&rdquo; state and one for the &ldquo;off&rdquo; state.
I want to hide these lights from Home Assistant as they are just an implementation detail and should not be controlled directly.
For each relay, I want only a single &ldquo;template&rdquo; light that I can assign color/brightness to and have that automatically propagate to the &ldquo;on&rdquo; or &ldquo;off&rdquo; partition light as appropriate for the relay&rsquo;s current state.</p><p>This single light is the <code>light.Indicator</code> entity.</p><p>ESPHome doesn&rsquo;t <em>technically</em> have a &ldquo;template&rdquo; light but it does have a <a href=https://esphome.io/components/light/custom.html target=_blank rel="noopener noreffer">custom light component</a> that can be used to create a &ldquo;template&rdquo; light.</p><p>For convenience, the <code>button.{Daytime,Nighttime} Mode</code> entities set the color/brightness of the <code>light.Indicator</code> to a hardcoded value for the given regime.
This is useful for quickly getting each indicator light into a consistent state after some other automation has changed the color/brightness for a subset of indicator lights.</p><h4 id=regimes>Regimes</h4><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>Note<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>I use the word regime and mode interchangeably to refer to a set of color/brightness values for the indicator lights.
This is a byproduct of an earlier version of the configuration where I had stricter control over weather or not the partition lights or moodlight should be &ldquo;in control&rdquo; of what the RGB LEDs are doing.
I&rsquo;ve since relaxed this requirement and settled on a general &ldquo;the partition lights are in control until the Moodlight is turned on&rdquo; policy.</p><p>This ultimately stems from how ESPHome tries to make a single string of addressable LEDs behave like multiple independent strings of LEDs.
The last &ldquo;light&rdquo; to be updated is the one that &ldquo;wins&rdquo;, and gets to control the LEDs.
If you set an effect like Rainbow on the moodlight and then turn on the partition lights, the partition lights will &ldquo;win&rdquo; until the moodlight moves to a new color; then the moodlight will &ldquo;win&rdquo; until the partition lights are updated again.</p><p>However, when the moodlight is turned <em>off</em>, the partition lights will resume their default regime.</p></div></div></div><p>Since each &ldquo;indicator&rdquo; light is exposed to Home Assistant, it&rsquo;s possible to set a unique color for each relay if desired.
But without explicitly changing the color/brightness of the indicator lights, two &ldquo;baked-in&rdquo; modes are present: daytime, and nighttime.</p><p>The color/brightness values for these two modes are declared once in the <code>yaml</code>, so they&rsquo;re easy to change if your particular deployment calls for different colors.
It just so happened that given the various locations that each switch is deployed a soft blue and red happened to work best for me.</p><p>Here&rsquo;s two pictures of the same switch under the &ldquo;no-moodlight&rdquo; regime in both daytime and nighttime mode.</p><p>In the first photo, relays 1 and 3 are on, relay 2 is off.
In the second photo, relay 1 is off but 2 and 3 are on.</p><figure><img src=/sonoff-t5-esphome/images/daytime.jpg alt="Lightish blue is easy to see / spot in the daytime."><figcaption><p>Lightish blue is easy to see / spot in the daytime.</p></figcaption></figure><figure><img src=/sonoff-t5-esphome/images/nighttime.jpg alt="The dark red color looks a lot better at night."><figcaption><p>The dark red color looks a lot better at night.</p></figcaption></figure><h4 id=dynamic-timer>Dynamic Timer</h4><p>I&rsquo;ve already covered the basics of how to do this with ESPHome in my <a href=https://karlquinsland.com/esphome-dynamic-timer/ rel>&ldquo;dynamic timers in ESPHome&rdquo;</a> post.
The same technique is used again here but it&rsquo;s been refined a bit and turned into a proper package which is easier to re-use.</p><h2 id=yaml>YAML</h2><p>There are some similarities to the examples provided by <a href=https://smarthomeyourself.de/ target=_blank rel="noopener noreffer"><code>SmartHome-yourself</code></a> in their <a href=https://github.com/SmartHome-yourself/sonoff-tx-ultimate-for-esphome target=_blank rel="noopener noreffer"><code>sonoff-tx-ultimate-for-esphome</code> custom component</a> but I ultimately decided to go in a different direction for most things.
I still use his custom component for the touch sensor but the rest of the configuration is my own.</p><p>Below I have provided a complete and working example of the configuration for a 3 relay variant.
I specifically chose the 3 relay variant because it&rsquo;s the most complex; creating a 1 or 2 relay variant is a subset of the 3 relay variant; take what&rsquo;s below and delete the parts you don&rsquo;t need.</p><p>For this example, I&rsquo;ve provided a sample <code>garage.yaml</code> file which is a lightly modified version of the configuration I have deployed.
Specifically, I have a combination of lights and a fan wired to the switch so the example demonstrates how to use multiple relays to control multiple different types of devices.</p><p>I&rsquo;ve left comments throughout the files to explain what&rsquo;s going on and why.
Those comments - in addition to the &ldquo;features&rdquo; described above - should be enough to get you started with your own configuration.</p><h3 id=file-structure>File structure</h3><p>For readability and composability, I like to break up my ESPHome configuration into multiple files using the <a href=https://esphome.io/guides/configuration-types.html#packages target=_blank rel="noopener noreffer"><code>packages</code></a> pattern.</p><p>Here is how I have this example laid out:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ tree .
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── garage.yaml
</span></span><span class=line><span class=cl>└── packages
</span></span><span class=line><span class=cl>    ├── base.esphome.yaml
</span></span><span class=line><span class=cl>    ├── base.yaml
</span></span><span class=line><span class=cl>    ├── buzzer.yaml
</span></span><span class=line><span class=cl>    ├── countdown-timer.yaml
</span></span><span class=line><span class=cl>    ├── light-automations.yaml
</span></span><span class=line><span class=cl>    ├── status_led.yaml
</span></span><span class=line><span class=cl>    ├── template_light.h
</span></span><span class=line><span class=cl>    ├── touch_disable.yaml
</span></span><span class=line><span class=cl>    └── variant.c3.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>2</span> directories, <span class=m>10</span> files
</span></span></code></pre></td></tr></table></div></div><p>Assuming you reproduce this structure, you can compile and flash the example with:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>❯ esphome -s version_hash <span class=k>$(</span>git rev-parse --short HEAD<span class=k>)</span> run garage.yaml
</span></span></code></pre></td></tr></table></div></div><p>If you don&rsquo;t want to embed the git hash into the build, remove the <code>-s version_hash $(git rev-parse --short HEAD)</code> part and remove the <code>version_hash</code> substitution from <code>packages/base.esphome.yaml</code>.</p><h4 id=garageyaml><code>garage.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># A lightly modified version of a deployed sonoff T5 switch.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This example demonstrates how to use multiple relays to control multiple different types of devices.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># In this case, two lights and a fan.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Also demonstrates how to use the timer package to create a countdown timer for the fan.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Build / flash with:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ❯ esphome -s version_hash $(git rev-parse --short HEAD) run garage.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This build results in a pretty full flash so be careful about adding more features!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     RAM:   [=         ]  13.0% (used 42704 bytes from 327680 bytes)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     Flash: [======    ]  61.3% (used 1124229 bytes from 1835008 bytes)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>substitutions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Upper case used for human facing labels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variant</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Garage&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Lower case is for hostname and machine facing labels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>variant_lc</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;garage&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># For 2023.11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>esphome_area</span><span class=p>:</span><span class=w> </span><span class=l>Garage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Each instance of the timer needs a unique id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># This suffix will be appended to the id of each component to make it unique.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timer_one_instance_uid</span><span class=p>:</span><span class=w> </span><span class=l>fan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>common</span><span class=p>:</span><span class=w> </span>!<span class=l>include packages/base.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 3 relay version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>output</span><span class=p>:</span><span class=w> </span>!<span class=l>include</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>packages/variant.c3.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Relay 1,3 are wired up to lights</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>out_1_state_exp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;current_values.is_on()&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>out_3_state_exp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;current_values.is_on()&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>out_2_state_exp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;state&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Want the fan to have an auto-off timer function.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fan_relay_timeout_automation</span><span class=p>:</span><span class=w> </span>!<span class=l>include</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>packages/countdown-timer.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Prefix for the UI components</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entity_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Fan&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Suffix to create unique ids for each component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># We need substitution to work in THIS file as well not just the included</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>instance_uid</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${timer_one_instance_uid}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timer_duration_seconds</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Pass in which entity / how to control it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timer_control_entity_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;out_2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Will get plugged into this expression:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># call-&gt;${timer_control_action_exp}.perform();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># So values are &#34;turn_on()&#34; or &#34;turn_off()&#34; or &#34;toggle()&#34; depending on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#  what the the value of id(${timer_control_entity_id}) supports.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timer_control_action_exp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;turn_off()&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Will get plugged into this expression:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># if ( ${timer_control_entity_state_exp} )</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># so needs to return a bool. Exact value will depend on the type of entity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># being controlled. E.G.: &#34;.current_values.is_on()&#34; or &#34;.state&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timer_control_entity_state_exp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;id(out_2).state&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Customize what each of the three relays do</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>light</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Relay 1 and 2 are the fan/light combo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Fan Light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>out_1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>binary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>output</span><span class=p>:</span><span class=w> </span><span class=l>relay_1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:ceiling-fan-light&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_DEFAULT_OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># When changing between states, we need to update the partition light(s)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Main overhead light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Main Light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>out_3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>binary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>output</span><span class=p>:</span><span class=w> </span><span class=l>relay_3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_DEFAULT_OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://esphome.io/components/fan/binary.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>fan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Fan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>out_2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>binary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>output</span><span class=p>:</span><span class=w> </span><span class=l>relay_2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:fan&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># On boot, fan should be off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>ALWAYS_OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Wire in the count down timer automation if enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>if</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>condition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># If the countdown timer is enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;return id(glbl_timeout_armed_${timer_one_instance_uid});&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># The light is already on, start counting the seconds.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># When timer ends, light will be turned off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>_timer_tick_${timer_one_instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>else</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>logger.log</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>DEBUG</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${timer_one_instance_uid} turned on, countdown timer not armed&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># This can be called by the natural end of the timer OR manually through any other source.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>if</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>condition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># If the timer is still running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;return id(_timer_tick_${timer_one_instance_uid}).is_running();&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>on_timer_stop_${timer_one_instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># Don&#39;t wait for ESPHome to schedule updating the text sensor to re-draw the HA UI.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># As soon as the entity is off cancel the timer and update the text sensor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;id(s_txt_timeout_remaining_${timer_one_instance_uid}).update();&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>else</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>logger.log</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>DEBUG</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${timer_one_instance_uid} turned off, countdown timer not armed&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Don&#39;t abstract the touch handling away behind a variant specific file.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Allow for customizing what happens for a given touch event/location on a per-device basis.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tx_ultimate_touch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>tx_touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uart</span><span class=p>:</span><span class=w> </span><span class=l>uart_touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>on_press</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Let the user know we&#39;ve registered the touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>buzz_default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Like &#34;traditional&#34; switches, we act as soon as pressed and do not wait for &#34;release&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Unless user has disabled touch input processing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>&gt;</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        ESP_LOGD(&#34;tx_ultimate_touch.on_press&#34;, &#34;Touch Position: %d / State: %d&#34;, touch.x, touch.state);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        if (!id(glbl_sw_touch_enable)) {
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;tx_ultimate_touch.on_press&#34;, &#34;Touch is disabled, ignoring&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          return;
</span></span></span><span class=line><span class=cl><span class=sd>        }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        // 3 ch version means we split the touch surface into 3 equal size zones
</span></span></span><span class=line><span class=cl><span class=sd>        // 0-3, 4-7, 8-11
</span></span></span><span class=line><span class=cl><span class=sd>        // There&#39;s nothing stopping you from creating unequal sized zones if desired!
</span></span></span><span class=line><span class=cl><span class=sd>        /////////////////////////////////
</span></span></span><span class=line><span class=cl><span class=sd>        // The if/else pattern is extended or shortened depending on the number of relays
</span></span></span><span class=line><span class=cl><span class=sd>        // In addition to modifying the if/else pattern, you&#39;ll need to update the code that
</span></span></span><span class=line><span class=cl><span class=sd>        //    checks the state of each output.
</span></span></span><span class=line><span class=cl><span class=sd>        // Below, out_1 and out_3 are lights so current_values.is_on() is used instead of just .state
</span></span></span><span class=line><span class=cl><span class=sd>        //    which works for binary fan / out_2.
</span></span></span><span class=line><span class=cl><span class=sd>        // I wish ESPHome would have a more homogenous API for this since there IS a homogenous
</span></span></span><span class=line><span class=cl><span class=sd>        //  API for calling the turn_on/turn_off methods!
</span></span></span><span class=line><span class=cl><span class=sd>        /////////////////////////////////
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        if (touch.x &lt;= 3) {
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;tx_ultimate_touch.on_press&#34;, &#34;Toggle 1&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          if(id(out_1).current_values.is_on() ) {
</span></span></span><span class=line><span class=cl><span class=sd>            id(out_1).turn_off().perform();
</span></span></span><span class=line><span class=cl><span class=sd>          } else {
</span></span></span><span class=line><span class=cl><span class=sd>            id(out_1).turn_on().perform();
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>        } else if (touch.x &lt;= 7) {
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;tx_ultimate_touch.on_press&#34;, &#34;Toggle 2&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          if(id(out_2).state ) {
</span></span></span><span class=line><span class=cl><span class=sd>            id(out_2).turn_off().perform();
</span></span></span><span class=line><span class=cl><span class=sd>          } else {
</span></span></span><span class=line><span class=cl><span class=sd>            id(out_2).turn_on().perform();
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>        } else {
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;tx_ultimate_touch.on_press&#34;, &#34;Toggle 3&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          if(id(out_3).current_values.is_on() ) {
</span></span></span><span class=line><span class=cl><span class=sd>            id(out_3).turn_off().perform();
</span></span></span><span class=line><span class=cl><span class=sd>          } else {
</span></span></span><span class=line><span class=cl><span class=sd>            id(out_3).turn_on().perform();
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>        }</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packagesbaseesphomeyaml><code>packages/base.esphome.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>esphome</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>${hostname}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>friendly_name</span><span class=p>:</span><span class=w> </span><span class=l>${friendly_name}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>comment</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Controls ${friendly_name}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>area</span><span class=p>:</span><span class=w> </span><span class=l>${esphome_area}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build_path</span><span class=p>:</span><span class=w> </span><span class=l>../../build-root/${hostname}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The device name / hostname is unique enough</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name_add_mac_suffix</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>project</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;t5.${variant_lc}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1.0.${version_hash}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>includes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>packages/template_light.h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Shortly after booting up, refresh the partition lights to make sure the right</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># colors are used.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Might be useful in day-to-day use, but is _very_ useful when testing late at night and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   after flashing new build and the lights come on full blast/white!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>on_boot</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># The higher the number, the earlier in the boot process it runs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># We do need to wait for NTP to get a fix, though.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># With that, we can properly figure out which light mode to use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>priority</span><span class=p>:</span><span class=w> </span>-<span class=m>200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>button.press</span><span class=p>:</span><span class=w> </span><span class=l>button_determine_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Throttle writing parameters to the internal flash memory to reduce ESP memory wear / degradation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>flash_write_interval</span><span class=p>:</span><span class=w> </span><span class=l>15min</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esp32</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># There is no platform.io board preset so we go with a generic one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>board</span><span class=p>:</span><span class=w> </span><span class=l>esp32dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Enable logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>logger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#  hardware_uart: UART2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>binary_sensor</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>script</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># I don&#39;t need to see wifi strength, internal temp and other sensor updates spamming logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>text_sensor</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sensor</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Also don&#39;t need to get log span every time I toggle main relays</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>switch</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mqtt.fan</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fan</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>light</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># DEBUG is very helpful for mapping position to numbers but it&#39;s a lot of spam otherwise</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tx_ultimate_touch</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>uart_debug</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ledc.output</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Note: the content of these includes is not shown in this example as the values are unique to my setup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># The name of the package matches the name of the component set up in the package so you can substitute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   your own values as needed. E.G.: you&#39;d set up your own MQTT connection and remove the one I have here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>time</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/ntp/home.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mqtt</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/mqtt/home.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ota</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/ota/home.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web_server</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/web_server.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wifi</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/wifi/home.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>friendly_uptime</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/sensor/friendly_uptime.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Enable IPv6 support</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Note, seems like dual-stack isn&#39;t well supported w/ the IP address text sensor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># See: https://github.com/esphome/issues/issues/5126</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipv6</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/network/ipv6.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>text_sensor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># See above GH issue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/sensor/ip_addr.wifi.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>button</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Allow restarting via HA UI</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- !<span class=l>include ../../../packages/button/restart.external.config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- !<span class=l>include ../../../packages/button/safemode.external.config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>sensor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Misc diagnostic sensors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/sensor/esp32_internal_temp.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/sensor/wifi_signal_strength.config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>binary_sensor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>&lt;&lt;</span><span class=p>:</span><span class=w> </span>!<span class=l>include ../../../packages/binary_sensor/connection_status.config.yaml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packagesbaseyaml><code>packages/base.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Base configuration for the Sonoff T5 switches</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://templates.blakadder.com/sonoff_T5-1C-86</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://github.com/SmartHome-yourself/sonoff-tx-ultimate-for-esphome</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>substitutions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Displayed in HA frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>friendly_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${variant} Switch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>friendly_name_short</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${variant}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${variant_lc}-switch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>version_hash</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;not_set&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>external_components</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/SmartHome-yourself/sonoff-tx-ultimate-for-esphome</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=l>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>components</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>tx_ultimate_touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://esphome.io/guides/configuration-types.html#packages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Common configuration used in virtually every device on my network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>esphome</span><span class=p>:</span><span class=w> </span>!<span class=l>include base.esphome.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Device specific</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>status_led</span><span class=p>:</span><span class=w> </span>!<span class=l>include status_led.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Automatic day/night regime for partitioned LEDs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>day_night_mode</span><span class=p>:</span><span class=w> </span>!<span class=l>include light-automations.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Buzzer motor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>buzzer</span><span class=p>:</span><span class=w> </span>!<span class=l>include buzzer.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Global &#34;ignore touch&#34; switch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>touch_disable</span><span class=p>:</span><span class=w> </span>!<span class=l>include touch_disable.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># regardless of which variant, we have some common configurations for LED lights</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>light</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Expose all LEDs as a single lamp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Mood Light&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>neopixelbus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>GRB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>variant</span><span class=p>:</span><span class=w> </span><span class=l>WS2811</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>num_leds</span><span class=p>:</span><span class=w> </span><span class=m>32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Gently fade between states</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>default_transition_length</span><span class=p>:</span><span class=w> </span><span class=m>1.</span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># The mood light is meant for subtle indications so we don&#39;t really overdo it here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>effects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>addressable_rainbow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Rainbow&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>speed</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>width</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>pulse</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Pulse&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>transition_length</span><span class=p>:</span><span class=w> </span><span class=m>1.</span><span class=l>4s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>update_interval</span><span class=p>:</span><span class=w> </span><span class=l>1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># When the mood light is turned off, will need to restore the last state to the side/indicator leds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>resume_normal_regime_for_leds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Leave the lights on the side for relay/switch state indication.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Use the top/bottom of the switch for general indication purposes.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Note that ALL the leds are on the same bus so ESPHome is doing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   a lot of internal processing / merging to generate the &#34;final&#34; stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   of data to send to the LEDs. Complicated / quick moving effects don&#39;t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   look awesome here so we keep it simple, subtle and slow.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Top&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_sw_top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>25</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>effects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>addressable_scan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Scan&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>addressable_rainbow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Rainbow&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>speed</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>width</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Bottom&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_sw_bottom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>effects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>addressable_scan</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Scan&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>addressable_rainbow</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Rainbow&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>speed</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>width</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Interact with the touch panel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>uart</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tx_pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rx_pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>uart_touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>baud_rate</span><span class=p>:</span><span class=w> </span><span class=m>115200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>data_bits</span><span class=p>:</span><span class=w> </span><span class=m>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>stop_bits</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>parity</span><span class=p>:</span><span class=w> </span><span class=l>NONE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>direction</span><span class=p>:</span><span class=w> </span><span class=l>RX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dummy_receiver</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>after</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bytes</span><span class=p>:</span><span class=w> </span><span class=m>2048</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Debug raw packets from the touch panel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sequence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=l>UARTDebug::log_hex(direction, bytes, &#39; &#39;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>switch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># I tried to make this a switch that I could toggle from HA.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The hope was that It would function as a quick way to disable all touch inputs.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># I was able to reliably trigger a crash when the switch was toggled.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Leaving this as an internal switch that can&#39;t be controlled from HA to avoid the crash and using</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   a template switch to disable touch inputs instead.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># TODO: if I can&#39;t really control this, just make it a GPIO output?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># See: https://esphome.io/components/output/gpio.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;touch panel power&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=l>GPIO5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>inverted</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>touch_power</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_DEFAULT_ON</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packagesbuzzeryaml><code>packages/buzzer.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># There is a very small motor w/ an offset weight that vibrates the switch.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Rather than basic binary control we can use PWM for more interesting patterns.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>output</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>ledc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO21</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>out_buzzer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Standard &#34;click&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>buzz_default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Enable output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>output.turn_on</span><span class=p>:</span><span class=w> </span><span class=l>out_buzzer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>output.ledc.set_frequency</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>out_buzzer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>frequency</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000Hz&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>output.set_level</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>out_buzzer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;30%&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=l>20ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>output.set_level</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>out_buzzer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;90%&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=l>30ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>output.turn_off</span><span class=p>:</span><span class=w> </span><span class=l>out_buzzer</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packagescountdown-timeryaml><code>packages/countdown-timer.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Common bits for GPIO based timer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>globals</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># For the auto-off automation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_timeout_armed_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_timeout_length_ticks_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${timer_duration_seconds}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># We ALSO need to keep track of the number of &#39;ticks&#39; that have passed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_timeout_ticks_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This particular implementation intentionally does not restart the timer when the time is running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   and changed. If the timer is running but the user changes the duration, the timer will keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   counting ticks until it expires. Restarting the timer via HA is possible by either toggling the enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   switch or setting the time to 0, waiting 1 second for ESPHome to figure out that the timer has expires</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   and then setting the time back / turning on the $thing.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Not elegant so we provide this helper button to clear out the elapsed time and start the timer over.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This can be more useful than the above method if the timer is running and the user wants to &#34;add&#34; more time.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># E.G.: Home Assistant can detect that $room is still occupied but that the timer is about to expire and can just</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   press the button so the light does not go off while the room is still occupied instead of having to guess</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   about what the user wants and just extending the timer by some arbitrary amount.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>button</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${entity_name} Timeout Restart&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>btn_restart_timer_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:timer-refresh-outline&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_press</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Just set the elapsed ticks to 0 and start the _tick script</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_timeout_ticks_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>_timer_tick_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># And a way to disable the timer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>switch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Another arm/disarm toggle for the &#34;auto off&#34; timer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${entity_name} Timer&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_timeout_arm_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;switch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:link-variant&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Default to on unless user says no.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_DEFAULT_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Lambda to figure out the current state/value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      if (id(glbl_timeout_armed_${instance_uid})) {
</span></span></span><span class=line><span class=cl><span class=sd>        return true;
</span></span></span><span class=line><span class=cl><span class=sd>      } else {
</span></span></span><span class=line><span class=cl><span class=sd>        return false;
</span></span></span><span class=line><span class=cl><span class=sd>      }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_on_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># If the $thing is already on, start counting down</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            // Indicate that the timer _should_ be set, though
</span></span></span><span class=line><span class=cl><span class=sd>            id(glbl_timeout_armed_${instance_uid}) = true;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            auto TAG = &#34;template.Timeout Automation.turn_on_action&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>            if ( ${timer_control_entity_state_exp} ) {
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(TAG, &#34;Timeout Automation ARMED with &#39;${timer_control_entity_id}&#39;&#39; already on... starting timer!&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>              id(_timer_tick_${instance_uid}).execute();
</span></span></span><span class=line><span class=cl><span class=sd>            } else {
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(TAG, &#34;Timeout Automation ARMED with &#39;${timer_control_entity_id}&#39;&#39; NOT on... nothing to do!&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>            }
</span></span></span><span class=line><span class=cl><span class=sd>            // Don&#39;t wait for ESPHome to schedule updating the text sensor to re-draw the HA ui
</span></span></span><span class=line><span class=cl><span class=sd>            id(s_txt_timeout_remaining_${instance_uid}).update();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_off_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># If the light is still on when the timeout timer is engaged then we stop the timer and clean up.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># The light will just stay on until something else turns it off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            // Set the global to OFF, it will be checked next time the _tick fires
</span></span></span><span class=line><span class=cl><span class=sd>            id(glbl_timeout_armed_${instance_uid}) = false;
</span></span></span><span class=line><span class=cl><span class=sd>            id(on_timer_stop_${instance_uid}).execute();
</span></span></span><span class=line><span class=cl><span class=sd>            // Don&#39;t wait for ESPHome to schedule updating the text sensor to re-draw the HA ui
</span></span></span><span class=line><span class=cl><span class=sd>            id(s_txt_timeout_remaining_${instance_uid}).update();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Expose a control to HA so we can adjust timer length</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://esphome.io/components/number/template.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>number</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${entity_name} Timeout Length&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>num_timeout_length_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:timer-cog-outline&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=l>minutes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Internally, we do everything in seconds but I can&#39;t really see the value in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   allowing the user to set precise values in seconds. Do you really need a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   timer for 170 seconds or can we just do 3 minutes and call it good?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># To Home Assistant, we&#39;ll expose a number input that allows the user to set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   the number of whole minutes. A slider _can_ work but when the MAX value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   is quite a ways from the min and typical, the slider is not very useful and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   direct numeric input becomes a bit more appropriate even if the UX is bad</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   on mobile.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>box</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># At least one minute and no more than 6 hours</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>min_value</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max_value</span><span class=p>:</span><span class=w> </span><span class=m>360</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>step</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      // HA expects value in minutes, we do everything in seconds so convert
</span></span></span><span class=line><span class=cl><span class=sd>      return (int) id(glbl_timeout_length_ticks_${instance_uid})/60;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Store the val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_timeout_length_ticks_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span>!<span class=l>lambda |-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=l>return (int) x*60;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># And update the text sensor so HA displays the new value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;id(s_txt_timeout_remaining_${instance_uid}).update();&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># And while counting down, show the time remaining to HA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>text_sensor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${entity_name} Timeout Time Remaining&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>s_txt_timeout_remaining_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:timer-stop-outline&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;diagnostic&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># If i set this to 10s, then every 10s we need to get on WiFi and talk to MQTT... even if the value hasn&#39;t changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># If i set this to the esphome default of 60s, the timer does not update often in the UI which leads to ... poor experience.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># The solution is to manually update it when appropriate.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>update_interval</span><span class=p>:</span><span class=w> </span><span class=l>never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      auto TAG=&#34;textSensor.lambda.${instance_uid}&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>      //Assuming 3 digits for hours, min, seconds _and_ three colons + 2 char extra
</span></span></span><span class=line><span class=cl><span class=sd>      char buff[15];
</span></span></span><span class=line><span class=cl><span class=sd>      int hr, min, sec;
</span></span></span><span class=line><span class=cl><span class=sd>      hr = min = sec = 0;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      int _remaining_sec = id(glbl_timeout_length_ticks_${instance_uid}) - id(_glbl_timeout_ticks_${instance_uid});
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      // Sanity checks
</span></span></span><span class=line><span class=cl><span class=sd>      if(_remaining_sec &lt; 0) {
</span></span></span><span class=line><span class=cl><span class=sd>        ESP_LOGE(TAG, &#34;negative time remaining error! _remaining_sec: %d&#34;, _remaining_sec);
</span></span></span><span class=line><span class=cl><span class=sd>        return {&#34;negative time remaining error&#34;};
</span></span></span><span class=line><span class=cl><span class=sd>      }
</span></span></span><span class=line><span class=cl><span class=sd>      if(! id(glbl_timeout_armed_${instance_uid})) {
</span></span></span><span class=line><span class=cl><span class=sd>        return {&#34;Disarmed&#34;};
</span></span></span><span class=line><span class=cl><span class=sd>      }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      ESP_LOGD(TAG, &#34;_remaining_sec: %d&#34;, _remaining_sec);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      hr = _remaining_sec/3600;
</span></span></span><span class=line><span class=cl><span class=sd>      min = (_remaining_sec % 3600) / 60;
</span></span></span><span class=line><span class=cl><span class=sd>      sec = _remaining_sec % 60;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      ESP_LOGD(TAG, &#34;hr: %d, min: %d, sec: %d&#34;, hr, min, sec);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      snprintf(buff, 15, &#34;%02d:%02d:%02d&#34;, hr, min, sec);
</span></span></span><span class=line><span class=cl><span class=sd>      ESP_LOGD(TAG, &#34;buff: %s&#34;, buff);
</span></span></span><span class=line><span class=cl><span class=sd>      return to_string(buff);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># End meaning the natural conclusion of the timer. Do whatever we&#39;re supposed to do when the timer fires off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>on_timer_end_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto call = id(${timer_control_entity_id});
</span></span></span><span class=line><span class=cl><span class=sd>          call-&gt;${timer_control_action_exp}.perform();
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGI(&#34;script.on_timer_end_${instance_uid}&#34;, &#34;output should be ${timer_control_action_exp}!&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Stop meaning the pre-mature ending of the timer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>on_timer_stop_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Do not start a new run. Issue a warning.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto TAG = &#34;lambda.on_timer_stop_${instance_uid}&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // For now, we just clean up the _timer_tick_${instance_uid} stuff.
</span></span></span><span class=line><span class=cl><span class=sd>          // I could use this opportunity to do other things like turn the light off when the timer is stopped...
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          id(_timer_tick_${instance_uid}).stop();
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_timeout_ticks_${instance_uid}) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(TAG, &#34;_timer_tick_${instance_uid} now stopped and _glbl_timeout_ticks_${instance_uid} is %d&#34;, id(_glbl_timeout_ticks_${instance_uid}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_timer_tick_${instance_uid}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Start a new run after previous runs completes. This will happen until timer.stop() is called on us</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>queued</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># A single &#39;tick&#39; is 1 second long</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=l>1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto TAG = &#34;timer_tick.${instance_uid}&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // First, update the number of ticks
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_timeout_ticks_${instance_uid}) += 1;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // Then update the text sensor showing the time remaining; do this every 10 ticks
</span></span></span><span class=line><span class=cl><span class=sd>          // We also update on the FIRST tick so the user has immediate confirmation that we&#39;re counting down
</span></span></span><span class=line><span class=cl><span class=sd>          if( id(_glbl_timeout_ticks_${instance_uid}) % 10 == 0 || id(_glbl_timeout_ticks_${instance_uid}) == 1) {
</span></span></span><span class=line><span class=cl><span class=sd>            id(s_txt_timeout_remaining_${instance_uid}).update();
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // Then check if we have timed out
</span></span></span><span class=line><span class=cl><span class=sd>          if (id(_glbl_timeout_ticks_${instance_uid}) &gt;= id(glbl_timeout_length_ticks_${instance_uid}) ) {
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            // If we have timed out, run the script to handle the timer expiration
</span></span></span><span class=line><span class=cl><span class=sd>            // It&#39;s cleaner to call out to a script rather than put all the &#34;what no?&#34; code in here!
</span></span></span><span class=line><span class=cl><span class=sd>            id(on_timer_end_${instance_uid}).execute();
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;_glbl_timeout_ticks_${instance_uid} is &gt;= glbl_timeout_length_ticks  %d &gt;= %d &#34;, id(_glbl_timeout_ticks_${instance_uid}), id(glbl_timeout_length_ticks_${instance_uid}) );
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            // And then re-set the internal counter
</span></span></span><span class=line><span class=cl><span class=sd>            id(_glbl_timeout_ticks_${instance_uid}) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            // And finally, stop the ticking timer
</span></span></span><span class=line><span class=cl><span class=sd>            id(_timer_tick_${instance_uid}).stop();
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;_timer_tick_${instance_uid} now stopped!&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          } else {
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;_glbl_timeout_ticks_${instance_uid} is &lt; glbl_timeout_length_ticks  %d &lt; %d &#34;, id(_glbl_timeout_ticks_${instance_uid}), id(glbl_timeout_length_ticks_${instance_uid}) );
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            // make sure we run again.. unless we&#39;re not supposed to
</span></span></span><span class=line><span class=cl><span class=sd>            if( id(glbl_timeout_armed_${instance_uid}) ) {
</span></span></span><span class=line><span class=cl><span class=sd>              id(_timer_tick_${instance_uid}).execute();
</span></span></span><span class=line><span class=cl><span class=sd>            }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          }</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packageslight-automationsyaml><code>packages/light-automations.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Create two buttons to trigger night/day mode immediately and expose them to HA for easy automation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Also offer up a template switch + global to control weather or not the sun triggers transition between modes.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>substitutions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Found after some trial/error.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># In dark room, make light.turn_on calls in HA dev tools, dialing the brightness down as much as possible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># until lights no longer turned on and the general color/brightness was what I wanted for the room.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># nt = night time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nt_exp_red</span><span class=p>:</span><span class=w> </span><span class=m>255</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nt_exp_green</span><span class=p>:</span><span class=w> </span><span class=m>110</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nt_exp_blue</span><span class=p>:</span><span class=w> </span><span class=m>84</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nt_exp_bright</span><span class=p>:</span><span class=w> </span><span class=m>28</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># dt = day time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dt_exp_red</span><span class=p>:</span><span class=w> </span><span class=m>127</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dt_exp_green</span><span class=p>:</span><span class=w> </span><span class=m>172</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dt_exp_blue</span><span class=p>:</span><span class=w> </span><span class=m>255</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dt_exp_bright</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=l>/255.0;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>globals</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_automation_sun_position_triggers_light_modes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Store to flash on change; not expected to change often</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_normal_regime_mode_is_nighttime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># On boot, assume it is not night time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Note that this only figures out WHICH mode we should be in, it does not actually change any light colors.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_normal_regime_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># So simple we don&#39;t need a lambda :D</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>if</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>condition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>sun.is_above_horizon</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>logger.log</span><span class=p>:</span><span class=w> </span><span class=l>Sun is above horizon!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_normal_regime_mode_is_nighttime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>else</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>logger.log</span><span class=p>:</span><span class=w> </span><span class=l>Sun is below horizon!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_normal_regime_mode_is_nighttime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>button</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Daytime Mode&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>button_daytime_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:sun-clock&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_press</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>do_daytime_mode_active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_normal_regime_mode_is_nighttime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Nighttime Mode&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>button_nighttime_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:lightbulb-night&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_press</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>do_nighttime_mode_active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_normal_regime_mode_is_nighttime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># A helper button to trigger the &#34;reset lights to normal regime/color&#34; script</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Determine Mode&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>button_determine_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:theme-light-dark&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_press</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Consult the sun position to figure out which mode we should be in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Day/Night will be stored in `glbl_normal_regime_mode_is_nighttime`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_normal_regime_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Based on what&#39;s stored in the global, set the template lights to the correct colors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># And then refresh the partition lights</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          if ( id(glbl_normal_regime_mode_is_nighttime) ) {
</span></span></span><span class=line><span class=cl><span class=sd>            id(do_nighttime_mode_active).execute();
</span></span></span><span class=line><span class=cl><span class=sd>          } else {
</span></span></span><span class=line><span class=cl><span class=sd>            id(do_daytime_mode_active).execute();
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>          id(resume_normal_regime_for_leds).execute();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Switch to control different bits of functionality</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>switch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Sun position changes light modes&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_sun_position_triggers_light_modes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:theme-light-dark&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># By default, we want the automation enabled.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_DEFAULT_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class=l>switch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      if (id(glbl_automation_sun_position_triggers_light_modes)) {
</span></span></span><span class=line><span class=cl><span class=sd>        return true;
</span></span></span><span class=line><span class=cl><span class=sd>      } else {
</span></span></span><span class=line><span class=cl><span class=sd>        return false;
</span></span></span><span class=line><span class=cl><span class=sd>      }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_on_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            id(glbl_automation_sun_position_triggers_light_modes) = true;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_off_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            id(glbl_automation_sun_position_triggers_light_modes) = false;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://esphome.io/components/sun.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>sun</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sun_position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>latitude</span><span class=p>:</span><span class=w> </span>!<span class=l>secret home_latitude_deg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>longitude</span><span class=p>:</span><span class=w> </span>!<span class=l>secret home_longitude_deg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When the sun is up, we assume ambient brightness is sufficient to show the user where the buttons are</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>on_sunrise</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Delays us a bit after true sun rise.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>elevation</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=l>°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>if</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>condition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;return id(glbl_automation_sun_position_triggers_light_modes);&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>button.press</span><span class=p>:</span><span class=w> </span><span class=l>button_daytime_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>else</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>logger.log</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Sunrise, but automation disabled.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When the sun sets, though, we want the LEDS to come on at about 50% brightness. They can then be seen in a dim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   room. When the relay is activated, the led will be on FULL which is distinct from the background 50% brightness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>on_sunset</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Trigger a bit before the sun actually sets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>elevation</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=l>°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>if</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>condition</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;return id(glbl_automation_sun_position_triggers_light_modes);&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>button.press</span><span class=p>:</span><span class=w> </span><span class=l>button_nighttime_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>else</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>logger.log</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Sunset, but automation disabled.&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packagesstatus_ledyaml><code>packages/status_led.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># I can&#39;t find a ton of evidence that there actually IS a status LED on the T5... but it costs nothing to include this.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://github.com/SmartHome-yourself/sonoff-tx-ultimate-for-esphome/blob/main/tx_ultimate_local.yaml#L53</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status_led</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=l>GPIO33</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>inverted</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packagestemplate_lighth><code>packages/template_light.h</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;esphome.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  ESPHome does not have a template light component but it does have &#34;custom&#34; light component.
</span></span></span><span class=line><span class=cl><span class=cm>  As it turns out, the backbones example that they provide for setting up a custom light component
</span></span></span><span class=line><span class=cl><span class=cm>    is exactly what I need to do. Love it when stuff works out that way :D!
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>  Essentially, I have two partition lights that I want to present to Home Assistant as a single light.
</span></span></span><span class=line><span class=cl><span class=cm>  Which partition light is active depends on the state of relay / switched output.
</span></span></span><span class=line><span class=cl><span class=cm>  This &#34;template&#34; entity just needs to &#34;store&#34; the color/brightness assigned by the user / HA.
</span></span></span><span class=line><span class=cl><span class=cm>  When appropriate, we&#39;ll consult the stored values and forward them to the appropriate partition light.
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TemplateLight</span> <span class=o>:</span> <span class=k>public</span> <span class=n>Component</span><span class=p>,</span> <span class=k>public</span> <span class=n>LightOutput</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>public</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=n>setup</span><span class=p>()</span> <span class=k>override</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ESP_LOGCONFIG</span><span class=p>(</span><span class=s>&#34;TemplateLight&#34;</span><span class=p>,</span> <span class=s>&#34;Nothing to do for setup...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>LightTraits</span> <span class=nf>get_traits</span><span class=p>()</span> <span class=k>override</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>traits</span> <span class=o>=</span> <span class=n>LightTraits</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>traits</span><span class=p>.</span><span class=n>set_supported_color_modes</span><span class=p>({</span><span class=n>ColorMode</span><span class=o>::</span><span class=n>RGB</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>traits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Called when there&#39;s a new state to write out to hardware.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// The whole point of this Light is that there IS no hardware to drive so we do nothing
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=nf>write_state</span><span class=p>(</span><span class=n>LightState</span> <span class=o>*</span><span class=n>state</span><span class=p>)</span> <span class=k>override</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: I might need to implement the minimum brightness here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Implementation here might be useful: https://esphome.io/api/float__output_8cpp_source#l00016
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// See: https://github.com/esphome/feature-requests/issues/920
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// float red, green, blue;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// state-&gt;current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ESP_LOGD(&#34;TemplateLight&#34;, &#34;Color is. R: %f, G: %f, B: %f.&#34;, red, green, blue);
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=packagestouch_disableyaml><code>packages/touch_disable.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># For reasons that I don&#39;t understand, toggling the GPIO that powers the touch panel causes a crash.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># I would have preferred using that to lock out touch inputs but this plan-B works well enough.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This is useful for &#34;guest&#34; or &#34;cleaning&#34; mode when you don&#39;t want the touch panel to do anything.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>globals</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_sw_touch_enable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>switch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Touch Enable&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_sw_touch_disable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:publish-off&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class=l>switch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># If something goes wrong, a reboot should re-enable touch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>ALWAYS_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      if (id(glbl_sw_touch_enable)) {
</span></span></span><span class=line><span class=cl><span class=sd>        return true;
</span></span></span><span class=line><span class=cl><span class=sd>      } else {
</span></span></span><span class=line><span class=cl><span class=sd>        return false;
</span></span></span><span class=line><span class=cl><span class=sd>      }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_on_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            id(glbl_sw_touch_enable) = true;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_off_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            id(glbl_sw_touch_enable) = false;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=packagesvariantc3yaml><code>packages/variant.c3.yaml</code></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Each variant has a slightly different set of template lights to turn on/off for day/night mode.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># The c2 and c1 versions of this file are mostly identical except for:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - the number of the template lights; the C1 variant only has a left/right partition light instead of 2 or three</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#         left/right partition lights as would be present on the C2 or C3 variants.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - the specific led numbers used in each partition are different; all variants have 10 LEDs on each side but</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#         those 10 total must be broken up into 1,2,3 partitions based on the variant.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - the number of outputs; the C1 variant only has 1 outputs instead of 2 or 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Each variant file must define/implement the same scripts though.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># WHAT each script does is slightly different per variant. The C1 variant of `do_nighttime_mode_active` only</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   adjusts `template_light_1` since there is no template_light_2 or template_light_3 on the C1 variant.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Likewise, the C2 variant of `figure_out_which_partition_to_light` only has case 1 and case 2 defined since</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   there is no `leds_button_3_right` or `leds_button_3_left` on the C2 variant.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>do_nighttime_mode_active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;script.do_nighttime_mode_active&#34;, &#34;Nighttime mode activated...&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          float red = ${nt_exp_red};
</span></span></span><span class=line><span class=cl><span class=sd>          float green = ${nt_exp_green};
</span></span></span><span class=line><span class=cl><span class=sd>          float blue = ${nt_exp_blue};
</span></span></span><span class=line><span class=cl><span class=sd>          float bright = ${nt_exp_bright};
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;script.do_nighttime_mode_active&#34;, &#34;Setting TEMPLATE(s) =&gt; R: %f G: %f B: %f BR: %f&#34;, red, green, blue, bright);
</span></span></span><span class=line><span class=cl><span class=sd>          id(template_light_1).turn_on().set_rgb( red, green, blue ).set_brightness(bright).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>          id(template_light_2).turn_on().set_rgb( red, green, blue ).set_brightness(bright).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>          id(template_light_3).turn_on().set_rgb( red, green, blue ).set_brightness(bright).set_transition_length(0).perform();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>do_daytime_mode_active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;script.do_daytime_mode_active&#34;, &#34;Daytime mode activated...&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          float red = ${dt_exp_red};
</span></span></span><span class=line><span class=cl><span class=sd>          float green = ${dt_exp_green};
</span></span></span><span class=line><span class=cl><span class=sd>          float blue = ${dt_exp_blue};
</span></span></span><span class=line><span class=cl><span class=sd>          float bright = ${dt_exp_bright};
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(&#34;script.do_daytime_mode_active&#34;, &#34;Setting TEMPLATE(s) =&gt; R: %f G: %f B: %f BR: %f&#34;, red, green, blue, bright);
</span></span></span><span class=line><span class=cl><span class=sd>          id(template_light_1).turn_on().set_rgb( red, green, blue ).set_brightness(bright).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>          id(template_light_2).turn_on().set_rgb( red, green, blue ).set_brightness(bright).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>          id(template_light_3).turn_on().set_rgb( red, green, blue ).set_brightness(bright).set_transition_length(0).perform();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto TAG = &#34;script.figure_out_which_partition_to_light&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>          // We don&#39;t know WHICH partition light to pull RGB/BR from, but regardless we do need place to store....
</span></span></span><span class=line><span class=cl><span class=sd>          float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(TAG, &#34;Trigger was output %d&#34;, output_num);
</span></span></span><span class=line><span class=cl><span class=sd>          switch (output_num) {
</span></span></span><span class=line><span class=cl><span class=sd>            case 1:
</span></span></span><span class=line><span class=cl><span class=sd>                // Output 1 is top button, so we want to light the top partition
</span></span></span><span class=line><span class=cl><span class=sd>                id(template_light_1).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>                id(template_light_1).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>                ESP_LOGD(TAG, &#34;Light State =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>                // Will be either just .state for entities that have bool on/off properties or something like
</span></span></span><span class=line><span class=cl><span class=sd>                //  .current_values.is_on() for entities that don&#39;t.
</span></span></span><span class=line><span class=cl><span class=sd>                if(id(out_1).${out_1_state_exp}) {
</span></span></span><span class=line><span class=cl><span class=sd>                  ESP_LOGD(TAG, &#34;out_1: ON, setting left side ON&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_1_left).turn_on().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_1_right).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                } else {
</span></span></span><span class=line><span class=cl><span class=sd>                  ESP_LOGD(TAG, &#34;out_1: OFF, setting right side ON&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_1_left).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_1_right).turn_on().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                }
</span></span></span><span class=line><span class=cl><span class=sd>                break;
</span></span></span><span class=line><span class=cl><span class=sd>            case 2:
</span></span></span><span class=line><span class=cl><span class=sd>                // Output 2 is middle button, so we want to light the second partition
</span></span></span><span class=line><span class=cl><span class=sd>                id(template_light_2).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>                id(template_light_2).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>                ESP_LOGD(TAG, &#34;Light State =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>                // The C++ code we call changes based on which type of output out_2 is
</span></span></span><span class=line><span class=cl><span class=sd>                if(id(out_2).${out_2_state_exp}) {
</span></span></span><span class=line><span class=cl><span class=sd>                  ESP_LOGD(TAG, &#34;out_2: ON, setting left side ON&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_2_left).turn_on().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_2_right).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                } else {
</span></span></span><span class=line><span class=cl><span class=sd>                  ESP_LOGD(TAG, &#34;out_2: OFF, setting right side ON&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_2_left).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_2_right).turn_on().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                }
</span></span></span><span class=line><span class=cl><span class=sd>                break;
</span></span></span><span class=line><span class=cl><span class=sd>            case 3:
</span></span></span><span class=line><span class=cl><span class=sd>                // Output 3 is bottom button, so we want to light the third partition
</span></span></span><span class=line><span class=cl><span class=sd>                id(template_light_3).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>                id(template_light_3).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>                ESP_LOGD(TAG, &#34;Light State =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>                if(id(out_3).${out_3_state_exp}) {
</span></span></span><span class=line><span class=cl><span class=sd>                  ESP_LOGD(TAG, &#34;out_3: ON, setting left side ON&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_3_left).turn_on().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_3_right).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                } else {
</span></span></span><span class=line><span class=cl><span class=sd>                  ESP_LOGD(TAG, &#34;out_3: OFF, setting right side ON&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_3_left).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                  id(leds_button_3_right).turn_on().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>                }
</span></span></span><span class=line><span class=cl><span class=sd>                break;
</span></span></span><span class=line><span class=cl><span class=sd>              default:
</span></span></span><span class=line><span class=cl><span class=sd>                ESP_LOGE(TAG, &#34;Unknown output number: %d&#34;, output_num);
</span></span></span><span class=line><span class=cl><span class=sd>                return;
</span></span></span><span class=line><span class=cl><span class=sd>            }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Called on boot or any time we&#39;re transitioning from mood-light to a &#34;normal&#34; mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>resume_normal_regime_for_leds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># When resuming normal regime, figure out which color scheme we should be using and then run the &#34;figure out which partition to light&#34; script for each output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_normal_regime_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See the LEDs section of readme.md</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># There are 10 LEDs on each side, we have 3 groups which means we&#39;ll need 4 &#34;buffers&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 10 - 4 = 6 and 6/3 is 2 so we&#39;ll use 2 leds per partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>light</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Button TOP Left (internal)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_button_1_left</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>23</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Button TOP Right (internal)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_button_1_right</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Button MIDDLE Left (internal)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_button_2_left</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Button MIDDLE Right (internal)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_button_2_right</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Button BOTTOM Left (internal)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_button_3_left</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Button BOTTOM Right (internal)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>partition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_button_3_right</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>segments</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>leds_all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=m>6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=m>7</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Expose a &#34;template&#34; light entity to HA.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Use this to &#34;wrap&#34; the partition lights and pass through values to them.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># See readme.md for more info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      // Sign of life
</span></span></span><span class=line><span class=cl><span class=sd>      ESP_LOGD(&#34;light.template_light&#34;, &#34;Alive!&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      auto template_light_1 = new TemplateLight();
</span></span></span><span class=line><span class=cl><span class=sd>      App.register_component(template_light_1);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      auto template_light_2 = new TemplateLight();
</span></span></span><span class=line><span class=cl><span class=sd>      App.register_component(template_light_2);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      auto template_light_3 = new TemplateLight();
</span></span></span><span class=line><span class=cl><span class=sd>      App.register_component(template_light_3);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      return {template_light_1, template_light_2, template_light_3};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lights</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Indicator 1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>template_light_1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Expose to HA, under config section</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Template light should restore to last state / ON at boot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_AND_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># We do not bother with gamma correction here, we want to keep the values as unadulterated as possible as this is JUST a pass through</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># The actual light(s) that we pass values to will handle gamma correction (if configured)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gamma_correct</span><span class=p>:</span><span class=w> </span><span class=m>0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Likewise, we do not want to do any smoothing here, we want to pass the values through as quickly as possible</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>default_transition_length</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># In testing, I can&#39;t get the (gamma corrected...) partition light(s) to turn on at all below ~20%.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Not clear _why_ this is (too dim to see?) but it&#39;s a problem because there&#39;s nothing preventing you from setting a brightness of &lt; 20% in HA.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># HA thinks that the light is on, but it&#39;s not actually on.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Ideally i&#39;d be able to set min_brightness here like I can with other types of light in ESPHome, but I can&#39;t.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># More than likely i&#39;ll need to implement this myself in the template_light.h file.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># We need to link our state to the actual partition lights... which is not as straightforward as expected.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># After a lot of trial/error, this is the least janky method I could come up with.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Because we have a transition length of 0, the on_state hook really shouldn&#39;t be called more than 2x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Once as soon as any command is received; it&#39;ll print the state we&#39;re about to move away from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Once as soon as we&#39;ve reached the  commanded state that was just received; it&#39;ll print the state we&#39;re at / should match what HA commanded.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># However, the on_state call is STILL needed because a light that is on full red and then given a command to go to full purple will not pass through</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>#   on/off state.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_turn_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get user requested RGB values and pass them through to the partition lights
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_1).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_1).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Pass through should happen ONLY in the on_state and on_turn_off hooks so just log here
</span></span></span><span class=line><span class=cl><span class=sd>              // Since we have ZERO gamma correction, the values here should _match_ the ones set in HA
</span></span></span><span class=line><span class=cl><span class=sd>              // They&#39;ll just be normalized though. So HA sends red: 255, here, we get 1.0
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_1.on_turn_on&#34;, &#34;ON_TURN_ON =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get template RGB values
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_1).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_1).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>              // OFF means OFF so both partitions should be off
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_1.on_turn_off&#34;, &#34;TURN OFF&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>              id(leds_button_1_left).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>              id(leds_button_1_right).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_state</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get template RGB values
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_1).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_1).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_1.on_state&#34;, &#34;State =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># Figure out which partition light to light up now that we have an updated state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># Output 1 = top</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Indicator 2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>template_light_2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_AND_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gamma_correct</span><span class=p>:</span><span class=w> </span><span class=m>0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>default_transition_length</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_turn_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get user requested RGB values and pass them through to the partition lights
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_2).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_2).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Pass through should happen ONLY in the on_state and on_turn_off hooks so just log here
</span></span></span><span class=line><span class=cl><span class=sd>              // Since we have ZERO gamma correction, the values here should _match_ the ones set in HA
</span></span></span><span class=line><span class=cl><span class=sd>              // They&#39;ll just be normalized though. So HA sends red: 255, here, we get 1.0
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_2.on_turn_on&#34;, &#34;ON_TURN_ON =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get template RGB values
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_2).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_2).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>              // OFF means OFF so both partitions should be off
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_2.on_turn_off&#34;, &#34;TURN OFF&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>              id(leds_button_2_left).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>              id(leds_button_2_right).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_state</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get template RGB values
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_2).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_2).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_2.on_state&#34;, &#34;State =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># Output 2 = middle on 3c version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Indicator 3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>template_light_3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_AND_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gamma_correct</span><span class=p>:</span><span class=w> </span><span class=m>0.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>default_transition_length</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_turn_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get user requested RGB values and pass them through to the partition lights
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_3).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_3).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Pass through should happen ONLY in the on_state and on_turn_off hooks so just log here
</span></span></span><span class=line><span class=cl><span class=sd>              // Since we have ZERO gamma correction, the values here should _match_ the ones set in HA
</span></span></span><span class=line><span class=cl><span class=sd>              // They&#39;ll just be normalized though. So HA sends red: 255, here, we get 1.0
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_3.on_turn_on&#34;, &#34;ON_TURN_ON =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get template RGB values
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_3).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_3).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>              // OFF means OFF so both partitions should be off
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_3.on_turn_off&#34;, &#34;TURN OFF&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>              id(leds_button_3_left).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();
</span></span></span><span class=line><span class=cl><span class=sd>              id(leds_button_3_right).turn_off().set_rgb( red, green, blue ).set_brightness(br).set_transition_length(0).perform();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>on_state</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>              // Get template RGB values
</span></span></span><span class=line><span class=cl><span class=sd>              float red, green, blue, br;
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_3).current_values_as_rgb(&amp;red, &amp;green, &amp;blue);
</span></span></span><span class=line><span class=cl><span class=sd>              id(template_light_3).current_values_as_brightness(&amp;br);
</span></span></span><span class=line><span class=cl><span class=sd>              ESP_LOGD(&#34;template_light_3.on_state&#34;, &#34;State =&gt; R: %f, G: %f, B: %f BR: %f&#34;, red, green, blue, br);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>figure_out_which_partition_to_light</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>output_num</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Set up the gpio outputs for the relays</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>output</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>relay_1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>relay_2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>relay_3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO27</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-11-11</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/sonoff-t5-esphome/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/esphome/>Esphome</a>,&nbsp;<a href=/tags/home-assistant/>Home-Assistant</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/yeelight-monitor-lamp-teardown-esphome/ class=prev rel=prev title="ESPHome on the Yeelight Monitor Light Bar Pro"><i class="fas fa-angle-left fa-fw"></i>ESPHome on the Yeelight Monitor Light Bar Pro</a>
<a href=/pulse-eight-hdmi-cec-injector-teardown/ class=next rel=next title="Inside of the Pulse-Eight HDMI CEC Injector.">Inside of the Pulse-Eight HDMI CEC Injector.<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>¯\_(ツ)_/¯</div><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.143.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.4710034e669c7ff17f823f9ba12cf8a36582d65b007f79cbc4a3c11d7db2e4ca.css integrity="sha256-RxADTmacf/F/gj+boSz4o2WC1lsAf3nLxKPBHX2y5Mo="><link rel=stylesheet href=/lib/katex/copy-tex.min.bf9ff4137fec38f6255419e142d0883c9c52090885d746f80eee12b273d9b3e0.css integrity="sha256-v5/0E3/sOPYlVBnhQtCIPJxSCQiF10b4Du4SsnPZs+A="><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.bcff85fb5e00d68802850b393ac7792c997f722f536f38e26638c46dca8e5eb6.js integrity="sha256-vP+F+14A1ogChQs5Osd5LJl/ci9TbzjiZjjEbcqOXrY="></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.615590a2ca2b667afa7c02ef396f5500b62e22795ddbb46448f90494605d09a5.js integrity="sha256-YVWQosorZnr6fALvOW9VALYuInld27RkSPkElGBdCaU="></script><script type=text/javascript src=/lib/lunr/lunr.min.df84a2d58ea594c04a3371b48d020b55ea10284c2ec636e4e331965d7313e29b.js integrity="sha256-34Si1Y6llMBKM3G0jQILVeoQKEwuxjbk4zGWXXMT4ps="></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js integrity="sha256-+2SfyuYhd9/mPmcIHdzrgwtc4fBaQYTpu7fYesS49OU="></script><script type=text/javascript src=/lib/clipboard/clipboard.min.8a7739925f4c03586479852df840b7061948832a7fda30c8c812d2ea4dd4c4f2.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI="></script><script type=text/javascript src=/lib/katex/katex.min.17f5dd6b9f123dd7140abfb18521b3f4c036cd004f6f40121182a8865f140877.js integrity="sha256-F/Xda58SPdcUCr+xhSGz9MA2zQBPb0ASEYKohl8UCHc="></script><script type=text/javascript src=/lib/katex/auto-render.min.f74776a677f0d2be0af0264058f928e2ba455d0b19bc985304660d922a43a6b2.js integrity="sha256-90d2pnfw0r4K8CZAWPko4rpFXQsZvJhTBGYNkipDprI="></script><script type=text/javascript src=/lib/katex/copy-tex.min.2ab2237329021bc443986c8327f6e61357fb68a54e5d233d224023718c02207d.js integrity="sha256-KrIjcykCG8RDmGyDJ/bmE1f7aKVOXSM9IkAjcYwCIH0="></script><script type=text/javascript src=/lib/katex/mhchem.min.5cea356d6025c5a2f18c454c83ec5674dbb04fab1cd1d75569e77788c6b6f888.js integrity="sha256-XOo1bWAlxaLxjEVMg+xWdNuwT6sc0ddVaed3iMa2+Ig="></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.f51938f3065a40ee841bcb558e4330e31fd26c0ea55343fff8770b88b0319a3c.js integrity="sha256-9Rk48wZaQO6EG8tVjkMw4x/SbA6lU0P/+HcLiLAxmjw="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3WZ55XG701",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-3WZ55XG701" async></script></body></html>
<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=X-UA-Compatible content="IE=edge, chrome=1"><title>Using ESPHome to Automatically restart frozen cable modem - karl</title><meta name=Description content="Alternate title: Something I probably wouldn't have had to hack together if Comcast wasn't so terrible."><meta property="og:url" content="https://karlquinsland.com/automatic-modem-restart-with-esphome/"><meta property="og:site_name" content="karl"><meta property="og:title" content="Using ESPHome to Automatically restart frozen cable modem"><meta property="og:description" content="Alternate title: Something I probably wouldn't have had to hack together if Comcast wasn't so terrible."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-09T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-09T12:52:15-07:00"><meta property="article:tag" content="Esphome"><meta property="article:tag" content="Home-Assistant"><meta property="article:tag" content="Home-Automation"><meta property="og:image" content="https://karlquinsland.com/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://karlquinsland.com/images/avatar.png"><meta name=twitter:title content="Using ESPHome to Automatically restart frozen cable modem"><meta name=twitter:description content="Alternate title: Something I probably wouldn't have had to hack together if Comcast wasn't so terrible."><meta name=twitter:site content="@somerandomguy"><meta name=application-name content="karl"><meta name=apple-mobile-web-app-title content="karl"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=https://karlquinsland.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://karlquinsland.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://karlquinsland.com/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=https://karlquinsland.com/apple-touch-icon.png><link rel=mask-icon href=https://karlquinsland.com/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=https://karlquinsland.com/site.webmanifest><link rel=canonical href=https://karlquinsland.com/automatic-modem-restart-with-esphome/><link rel=prev href=https://karlquinsland.com/arris-sb8200-prometheus-exporter/><link rel=next href=https://karlquinsland.com/arizer-xq2-teardown/><link rel=stylesheet href=https://karlquinsland.com/lib/normalize/normalize.min.055364f5be272caa092b0e6654c165828707f8ab971e2656383a6d6392bc345e.css integrity="sha256-BVNk9b4nLKoJKw5mVMFlgocH+KuXHiZWODptY5K8NF4="><link rel=stylesheet href=https://karlquinsland.com/css/style.min.1e2694bed152fa2922dbe909a441838ed693d88b1330f97485bfa8ed78da42df.css integrity="sha256-HiaUvtFS+iki2+kJpEGDjtaT2IsTMPl0hb+o7XjaQt8="><link rel=stylesheet href=https://karlquinsland.com/lib/fontawesome-free/all.min.876d023d9d10c97941b80c3b03e2a5b94631ff7a4af9cee5604a6a2d39718d84.css integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ="><link rel=stylesheet href=https://karlquinsland.com/lib/animate/animate.min.3c770e90f98eb21b0c042fafb49755af93306fbaf42e449524f94fae9fc83295.css integrity="sha256-PHcOkPmOshsMBC+vtJdVr5Mwb7r0LkSVJPlPrp/IMpU="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Using ESPHome to Automatically restart frozen cable modem","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/karlquinsland.com\/automatic-modem-restart-with-esphome\/"},"genre":"posts","keywords":"esphome, home-assistant, home-automation","wordcount":2685,"url":"https:\/\/karlquinsland.com\/automatic-modem-restart-with-esphome\/","datePublished":"2024-06-09T00:00:00+00:00","dateModified":"2024-06-09T12:52:15-07:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":"Alternate title: Something I probably wouldn't have had to hack together if Comcast wasn't so terrible."}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=https://karlquinsland.com/ title=karl>Karl</a></div><div class=menu><div class=menu-inner><a class=menu-item href=https://karlquinsland.com/posts/><i class="fas fa-blog"></i> Posts </a><a class=menu-item href=https://karlquinsland.com/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i> Résumé </a><a class=menu-item href=https://karlquinsland.com/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i> Tags </a><a class=menu-item href=https://karlquinsland.com/contact/><i class="fas fa-address-book"></i> Contact </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=https://karlquinsland.com/ title=karl>Karl</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=https://karlquinsland.com/posts/ title><i class="fas fa-blog"></i>Posts</a><a class=menu-item href=https://karlquinsland.com/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i>Résumé</a><a class=menu-item href=https://karlquinsland.com/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i>Tags</a><a class=menu-item href=https://karlquinsland.com/contact/ title><i class="fas fa-address-book"></i>Contact</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Using ESPHome to Automatically restart frozen cable modem</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://karlquinsland.com/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-06-09>2024-06-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2685 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;13 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#the-fix>The &ldquo;fix&rdquo;</a><ul><li><a href=#baseyaml><code>base.yaml</code></a></li><li><a href=#modemyaml><code>modem.yaml</code></a></li><li><a href=#all-together-now>All together now</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>Part of the reason for developing my <a href=https://karlquinsland.com/arris-sb8200-prometheus-exporter/ rel>SB8200 monitor</a> was to get to the bottom of some infrequent but regular outages.</p><p>To make a long story short, the <a href=https://en.wikipedia.org/wiki/Link_aggregation target=_blank rel="noopener noreffer">LAG</a> implementation on the modem seems to have some issues.
A quick google will return many complaint threads detailing issues with the modem regularly locking up all traffic stopping.
More annoyingly, these reports date back <em>years</em> and allege that later revisions of the firmware <em>might</em> fix the issue for good.</p><p>My ISP is <a href=https://deadline.com/2014/09/netflix-discovery-response-comcast-extortion-840530 target=_blank rel="noopener noreffer">evil</a> and doesn&rsquo;t give me a way to check for or manually update the firmware on device.</p><p>As expected, their stance is that all my issues will go away if I rent <em>their</em> modem and let them up-sell me a faster service tier, though 🙄.</p><p>When the modem falls over, it&rsquo;s pretty sudden; things will be fine one moment and then no traffic flows the next.
The exact timing seems to vary a bit, but the average time between lockups is about 10 days with very little variance.</p><p>I&rsquo;ve been &ldquo;lucky&rdquo; in the sense that most of these lockups have happened during the day while I was at home; I could notice the issue, triage and fix it pretty quickly.
My dashboards have at most 300 seconds of down time or so.</p><p>There&rsquo;s only so much luck to go around, though; what happens when I&rsquo;m out of the house?I&rsquo;ve been thinking about how to automate the process of restarting the modem and this is what I came up with.</p><h2 id=the-fix>The &ldquo;fix&rdquo;</h2><p>My modem is powered through a <a href=https://devices.esphome.io/devices/Sonoff-S31 target=_blank rel="noopener noreffer">Sonoff S31 plug</a> running <a href=https://esphome.io/ target=_blank rel="noopener noreffer">ESPHome</a>.</p><p>Every 10 seconds, the S31 tries to fetch the modem&rsquo;s http interface using the <a href=https://esphome.io/components/http_request.html target=_blank rel="noopener noreffer"><code>http_request</code></a> component.
If - after 2 seconds - the modem doesn&rsquo;t respond, a counter is incremented.
Once the counter reaches 5 consecutive failures, the power to the modem is briefly interrupted just as if I had unplugged it, counted to 10 and plugged it back in.</p><p>To make this bit of ESPHome configuration re-usable, I&rsquo;ve packaged up the functionality into a pair of standalone files that can be included into an existing ESPHome configuration.</p><p>Documentation for why/how things work has been put in the comments of each file to aid understanding.</p><figure><img src=https://karlquinsland.com/automatic-modem-restart-with-esphome/images/ha.png alt="How the S31 powering modem appears in Home Assistant"><figcaption><p>How the S31 powering modem appears in Home Assistant</p></figcaption></figure><h3 id=baseyaml><code>base.yaml</code></h3><p>This implements 95% of the logic and everything that&rsquo;s not implementation specific:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>substitutions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># How many seconds between http requests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>poll_interval_seconds</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># How many failed requests before we take action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># If polling happens every 10 seconds and runs for at most 2 seconds then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 5 failures in a row would mean that the host has been in a failed state for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># somewhere between 50 and 60 seconds before we take action.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>consecutive_failure_threshold</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># How many polls to wait for until action can be taken again</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lockout_ticks_count</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>globals</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># How many seconds between checking the remote host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_http_poll_interval_ticks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=l>${poll_interval_seconds}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Not clear if script execution is blocked while the http request is in flight.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># It appears to be, so I might be able to safely remove this?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_request_in_flight</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Lockout/cool-down prevents a failed result from immediately triggering another cycle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># E.g.: if the poll target is down and we power cycle it and then immediately check... it won&#39;t respond</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># which will mean another power cycle ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_lockout_ticks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=l>${lockout_ticks_count}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Need to keep track of the number of ticks since we last took the failure action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_ticks_since_last_failure_action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Monotonically increasing counter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_ticks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># How many failures have we had?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_failures_count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># How many failures before we do something?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_http_poll_failures_threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=l>${consecutive_failure_threshold}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Allows for disconnecting consecutive failure action if needed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_consecutive_failure_action_enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_value</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>initial_value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Expose the current state of the poll/lockout timer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>text_sensor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;HTTP Poll Status&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>txt_operation_mode</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:information-off-outline&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;diagnostic&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Will be called to update as necessary from other components</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>update_interval</span><span class=p>:</span><span class=w> </span><span class=l>never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      // This lambda function should never be called / we should never update the text sensor this way
</span></span></span><span class=line><span class=cl><span class=sd>      return {&#34;Unknown&#34;};</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Expose the current success/failure counts for stats</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>sensor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Consecutive Poll Failure Count&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>s_consecutive_poll_failure_count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:progress-alert&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;diagnostic&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      if (id(_glbl_http_poll_failures_count)) {
</span></span></span><span class=line><span class=cl><span class=sd>        return id(_glbl_http_poll_failures_count);
</span></span></span><span class=line><span class=cl><span class=sd>      } else {
</span></span></span><span class=line><span class=cl><span class=sd>        return 0.0;
</span></span></span><span class=line><span class=cl><span class=sd>      }</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Will be called to update as necessary from other components</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>update_interval</span><span class=p>:</span><span class=w> </span><span class=l>never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Allow tweaking the poll interval and failure threshold via Home Assistant</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://esphome.io/components/number/template.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>number</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Poll Interval&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>num_poll_interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:timer-sand&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=l>seconds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>box</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>min_value</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max_value</span><span class=p>:</span><span class=w> </span><span class=m>120</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>step</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      return (int) id(glbl_http_poll_interval_ticks);</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Store the val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_http_poll_interval_ticks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span>!<span class=l>lambda |-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=l>return (int) x;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Consecutive Failure Threshold&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>num_consecutive_failure_threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:alert-minus-outline&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>unit_of_measurement</span><span class=p>:</span><span class=w> </span><span class=l>failures</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>box</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>min_value</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max_value</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>step</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      return (int) id(glbl_http_poll_failures_threshold);</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Store the val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>glbl_http_poll_failures_threshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span>!<span class=l>lambda |-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=l>return (int) x;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>switch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># A global arm/disarm switch for the http poll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;HTTP Request Check&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_http_request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:web-sync&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># It&#39;s OK to have this set to ON at boot since we immediately go into lockout mode before we start polling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_DEFAULT_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># This way we don&#39;t need to create a global for the state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>optimistic</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>_on_http_poll_turned_on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_turn_off</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w> </span><span class=l>_on_http_poll_turned_off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># In addition to polling, also gate the actual consecutive failure action.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># This way, action can be disabled without disabling the polling itself; useful for testing polling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   or just gathering stats about how often the poll fails...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Consecutive Failure Action Enable&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_cons_failure_action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:alert-outline&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>entity_category</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;config&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># It&#39;s OK to have this set to ON at boot since we immediately go into lockout mode before we start polling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>RESTORE_DEFAULT_ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># This way we don&#39;t need to create a global for the state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>      return id(_glbl_http_poll_consecutive_failure_action_enabled);</span><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_on_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_consecutive_failure_action_enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>turn_off_action</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>globals.set</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_glbl_http_poll_consecutive_failure_action_enabled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When polling starts back up, we have some variable initialization to do</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_on_http_poll_turned_on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_ticks) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_ticks_since_last_failure_action) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_failures_count) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_request_in_flight) = false;
</span></span></span><span class=line><span class=cl><span class=sd>          id(txt_operation_mode).publish_state(&#34;Armed&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          id(_http_poll_tick).execute();</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># When polling function is turned off, there&#39;s a few things to clean up</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_on_http_poll_turned_off</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_ticks) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_ticks_since_last_failure_action) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_request_in_flight) = false;
</span></span></span><span class=line><span class=cl><span class=sd>          id(txt_operation_mode).publish_state(&#34;Disarmed&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          id(_do_poll).stop();
</span></span></span><span class=line><span class=cl><span class=sd>          id(_http_poll_tick).stop();</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># What do we do when we get a 200 response?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_on_http_poll_ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Poll was OK, indicate status and reset the _glbl_http_poll_failures_count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto const static TAG = &#34;_on_http_poll_ok&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(TAG, &#34;Poll OK. Resetting failure count.&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_failures_count) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          id(s_consecutive_poll_failure_count).update();
</span></span></span><span class=line><span class=cl><span class=sd>          id(txt_operation_mode).publish_state(&#34;Success&#34;);</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># What do we do when we get a non-200 response?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_on_http_poll_failure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Disable timer, have the text sensor update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto const static TAG = &#34;_on_http_poll_failure&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>          // Count and publish
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_failures_count)++;
</span></span></span><span class=line><span class=cl><span class=sd>          id(s_consecutive_poll_failure_count).update();
</span></span></span><span class=line><span class=cl><span class=sd>          
</span></span></span><span class=line><span class=cl><span class=sd>          id(txt_operation_mode).publish_state(&#34;Failure&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGW(TAG, &#34;Failures: %i, Threshold: %i&#34;, id(_glbl_http_poll_failures_count), id(glbl_http_poll_failures_threshold));
</span></span></span><span class=line><span class=cl><span class=sd>          
</span></span></span><span class=line><span class=cl><span class=sd>          if( id(_glbl_http_poll_failures_count) &gt;= id(glbl_http_poll_failures_threshold) ) {
</span></span></span><span class=line><span class=cl><span class=sd>            id(_on_http_poll_failure_threshold_met).execute();
</span></span></span><span class=line><span class=cl><span class=sd>          }</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># And when failure count reaches threshold, what do we do?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_on_http_poll_failure_threshold_met</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Disable timer, have the text sensor update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto const static TAG = &#34;_on_http_poll_failure_threshold_met&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGE(TAG, &#34;Consecutive failure threshold met!&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          if (id(_glbl_http_poll_consecutive_failure_action_enabled)) {
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGE(TAG, &#34;Executing action!&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>            // User must provide _valid_ C++ code here to be substituted in at compile time
</span></span></span><span class=line><span class=cl><span class=sd>            ${failure_threshold_met_action}
</span></span></span><span class=line><span class=cl><span class=sd>          } else {
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGE(TAG, &#34;Action disabled!&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // Reset the failure count
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_failures_count) = 0;
</span></span></span><span class=line><span class=cl><span class=sd>          id(s_consecutive_poll_failure_count).update();
</span></span></span><span class=line><span class=cl><span class=sd>          // Reset the time since last failure counter to enter lockout mode
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_ticks_since_last_failure_action) = 0;</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_do_poll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># DO NOT start a new run until the previous one completes!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>single</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Tell the user we&#39;re polling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // Indicate we are now polling
</span></span></span><span class=line><span class=cl><span class=sd>          id(txt_operation_mode).publish_state(&#34;Polling&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_request_in_flight) = true;</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Fire off the http request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>http_request.get</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>http_poll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>${http_url}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>verify_ssl</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># In testing, was able to confirm that this will be called even if there&#39;s an error.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># If failure occurred before HTTP could happen, status will be negative integer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># ESPHome does not permit defining lambda functions &#34;externally&#34;... but we can do this with scripts.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># To make this package as re-usable as possible, call into a `handle_on_response` script and expect the user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># to provide one at compile time.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>on_response</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>script.execute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>handle_on_response</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>status_code</span><span class=p>:</span><span class=w> </span>!<span class=l>lambda |- </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=l>return status_code;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>duration_ms</span><span class=p>:</span><span class=w> </span>!<span class=l>lambda |-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=l>return duration_ms;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>_http_poll_tick</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Start a new run after previous runs completes. This will happen until timer.stop() is called on us</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>queued</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max_runs</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># A single &#39;tick&#39; is 1 second long</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=l>1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          /*
</span></span></span><span class=line><span class=cl><span class=sd>            The &#34;super loop&#34; scheduler.
</span></span></span><span class=line><span class=cl><span class=sd>            This script is called every second and is responsible for determining if it&#39;s time to poll the target.
</span></span></span><span class=line><span class=cl><span class=sd>          */
</span></span></span><span class=line><span class=cl><span class=sd>          auto const static TAG = &#34;lambda._http_poll_tick&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>          static int num_ticks = 0;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // Count this tick
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_ticks) += 1;
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_ticks_since_last_failure_action)++;
</span></span></span><span class=line><span class=cl><span class=sd>          num_ticks = id(_glbl_http_poll_ticks);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // Are we supposed to be running at all?
</span></span></span><span class=line><span class=cl><span class=sd>          if( !id(sw_http_request) ) {
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;Not running. sw_http_request: %i&#34;, id(sw_http_request).state);
</span></span></span><span class=line><span class=cl><span class=sd>            id(_on_http_poll_turned_off).execute();
</span></span></span><span class=line><span class=cl><span class=sd>            return;
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // Check if there&#39;s already a request in flight.
</span></span></span><span class=line><span class=cl><span class=sd>          // Note that there appears to be a yaml only way of checking if a script is already running?
</span></span></span><span class=line><span class=cl><span class=sd>          // I can&#39;t find an API that allows me to do this ... so for now we have to keep track of this flag in a global bool.
</span></span></span><span class=line><span class=cl><span class=sd>          if (id(_glbl_http_poll_request_in_flight)) {
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;Request in flight! Nothing to do...&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>            id(_on_http_poll_turned_off).execute();
</span></span></span><span class=line><span class=cl><span class=sd>            return;
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // We should be running and there is currently no request in flight... Are we in lockout?
</span></span></span><span class=line><span class=cl><span class=sd>          if( id(_glbl_http_poll_ticks_since_last_failure_action) &lt; id(_glbl_http_poll_lockout_ticks) ) {
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;In lockout! ticks_since_last_failure_action: %i, lockout_ticks: %i&#34;, id(_glbl_http_poll_ticks_since_last_failure_action), id(_glbl_http_poll_lockout_ticks));
</span></span></span><span class=line><span class=cl><span class=sd>            
</span></span></span><span class=line><span class=cl><span class=sd>            // TODO: add the lockout time remaining to the text sensor?
</span></span></span><span class=line><span class=cl><span class=sd>            id(txt_operation_mode).publish_state(&#34;Locked Out&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            id(_http_poll_tick).execute();
</span></span></span><span class=line><span class=cl><span class=sd>            return;
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // We&#39;re not in lock out...Is it time to poll?
</span></span></span><span class=line><span class=cl><span class=sd>          if( num_ticks % id(glbl_http_poll_interval_ticks) != 0 ) {
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;Not time to poll. num_ticks: %i, interval_ticks: %i&#34;, num_ticks, id(glbl_http_poll_interval_ticks));
</span></span></span><span class=line><span class=cl><span class=sd>            id(txt_operation_mode).publish_state(&#34;Waiting&#34;);
</span></span></span><span class=line><span class=cl><span class=sd>          } else {
</span></span></span><span class=line><span class=cl><span class=sd>            ESP_LOGD(TAG, &#34;Time to poll! num_ticks: %i, glbl_http_poll_interval_ticks: %i&#34;, num_ticks, id(glbl_http_poll_interval_ticks));
</span></span></span><span class=line><span class=cl><span class=sd>            id(_do_poll).execute();
</span></span></span><span class=line><span class=cl><span class=sd>          }
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          // re-schedule so we&#39;re called again in a second!
</span></span></span><span class=line><span class=cl><span class=sd>          id(_http_poll_tick).execute();</span><span class=w>          
</span></span></span></code></pre></td></tr></table></div></div><h3 id=modemyaml><code>modem.yaml</code></h3><p>This file is the &ldquo;implementation specific&rdquo; details that can&rsquo;t be done in <code>base.yaml</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>base</span><span class=p>:</span><span class=w> </span>!<span class=l>include</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>base.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Comcast does not permit users to change this address on their own modems... 😡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http://192.168.100.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># When enough consecutive failures have been detected, this is what is &#34;injected&#34; into the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># `_on_http_poll_failure_threshold_met` script. It must be _valid_ c++ code or compilation will fail.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Elsewhere in my main ESPHome configuration, I have button that triggers an automation to </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># briefly cut and then restore power to effectively power cycle the modem.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># This code is the same as the user manually pressing that button.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failure_threshold_met_action</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;id(btn_modem_restart).press();&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># In testing, the web server on modem does come up quickly but seems to go back down after</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># ISP pushes their configuration down. Web server comes back up a few seconds later.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Best to just wait a while for things to stabilize.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lockout_ticks_count</span><span class=p>:</span><span class=w> </span><span class=m>120</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Note: not possible to have this defined in `base.yaml` and tweaked with !extend here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://github.com/esphome/issues/issues/5360</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>http_request</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>http_poll</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>follow_redirects</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>2s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Note: omit this for ESP32 devices :)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>esp8266_disable_ssl_support</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This is where a request result is classified into either a failure or success.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># It lives outside of the base package because each http server is different.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>script</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>handle_on_response</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># status_code, duration_ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>status_code</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>duration_ms</span><span class=p>:</span><span class=w> </span><span class=l>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>lambda</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          auto const static TAG = &#34;_do_poll.on_response&#34;;
</span></span></span><span class=line><span class=cl><span class=sd>          // Request is no longer in flight
</span></span></span><span class=line><span class=cl><span class=sd>          id(_glbl_http_poll_request_in_flight) = false;
</span></span></span><span class=line><span class=cl><span class=sd>          ESP_LOGD(TAG, &#34;Response status: %d, Duration: %u ms&#34;, status_code, duration_ms);
</span></span></span><span class=line><span class=cl><span class=sd>          // Nominally, 200/OK is the ONLY success condition but since modem uses 302 redirect to HTTPS
</span></span></span><span class=line><span class=cl><span class=sd>          // and the ESP8266 does not support TLS, we can&#39;t follow the redirect to the 200/OK page and
</span></span></span><span class=line><span class=cl><span class=sd>          // must consider the 302 redirect as a success as well.
</span></span></span><span class=line><span class=cl><span class=sd>          switch( status_code ) {
</span></span></span><span class=line><span class=cl><span class=sd>              case 200:
</span></span></span><span class=line><span class=cl><span class=sd>                id(_on_http_poll_ok).execute();
</span></span></span><span class=line><span class=cl><span class=sd>                break;
</span></span></span><span class=line><span class=cl><span class=sd>              case 302:
</span></span></span><span class=line><span class=cl><span class=sd>                id(_on_http_poll_ok).execute();
</span></span></span><span class=line><span class=cl><span class=sd>                break;
</span></span></span><span class=line><span class=cl><span class=sd>              default:
</span></span></span><span class=line><span class=cl><span class=sd>                ESP_LOGW(TAG, &#34;Response status: %d, Duration: %u ms&#34;, status_code, duration_ms);
</span></span></span><span class=line><span class=cl><span class=sd>                id(_on_http_poll_failure).execute();
</span></span></span><span class=line><span class=cl><span class=sd>                break;
</span></span></span><span class=line><span class=cl><span class=sd>            }</span><span class=w>          
</span></span></span></code></pre></td></tr></table></div></div><h3 id=all-together-now>All together now</h3><p>Hopefully it&rsquo;s clear to see that <code>modem.yaml</code> wraps/includes <code>base.yaml</code>.
This is how <code>modem.yaml</code> is injected into the existing configuration that I have deployed on the S31 powering my modem.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># See: https://esphome.io/guides/configuration-types.html#packages</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Omitted: common packages for Network info, NTP, OTA, MQTT, </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   relay/gpio and other device specific things... etc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Add http polling configured for this specific application</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http_poll</span><span class=p>:</span><span class=w> </span>!<span class=l>include packages/http_poll/modem.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>logger</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#  &lt;...&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>logs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ESPHome considers anything not 200/OK as a failure and will WARN about it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># See: https://github.com/esphome/esphome/blob/38b7bed2faa522e7e065d8362d6ea0bcaf1c64d5/esphome/components/http_request/http_request.cpp#L92</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># This is technically correct but results in log spam that is not useful to me.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># For my purposes, hearing anything back from the modem (302 or 200) counts as a success.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Silence log spam by hiding all http_request log lines unless they&#39;re ERROR level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http_request</span><span class=p>:</span><span class=w> </span><span class=l>ERROR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>button</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Note: must not conflict with the button named &#34;Restart&#34; which reboots the ESP, not toggles the relay!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Modem Restart&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>btn_modem_restart</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:restart&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_press</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>switch.turn_off</span><span class=p>:</span><span class=w> </span><span class=l>sw_relay_toggle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=l>15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>switch.turn_on</span><span class=p>:</span><span class=w> </span><span class=l>sw_relay_toggle</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-06-09&nbsp;<a class=git-hash href=https://github.com/kquinsland/kquinsland.github.io/commit/a7e56604957b486d1a8a55b93f4d3dcfbba25e22 target=_blank title="commit by karl(github@karlquinsland.com) a7e56604957b486d1a8a55b93f4d3dcfbba25e22: Fix tagging">
<i class="fas fa-hashtag fa-fw"></i>a7e5660</a></span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=https://karlquinsland.com/automatic-modem-restart-with-esphome/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=https://karlquinsland.com/tags/esphome/>Esphome</a>,&nbsp;<a href=https://karlquinsland.com/tags/home-assistant/>Home-Assistant</a>,&nbsp;<a href=https://karlquinsland.com/tags/home-automation/>Home-Automation</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=https://karlquinsland.com/>Home</a></span></section></div><div class=post-nav><a href=https://karlquinsland.com/arris-sb8200-prometheus-exporter/ class=prev rel=prev title="Arris SB8200 Prometheus Exporter"><i class="fas fa-angle-left fa-fw"></i>Arris SB8200 Prometheus Exporter</a>
<a href=https://karlquinsland.com/arizer-xq2-teardown/ class=next rel=next title="Arizer XQ2 Teardown">Arizer XQ2 Teardown<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>¯\_(ツ)_/¯</div><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.139.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://karlquinsland.com/ target=_blank></a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://karlquinsland.com/lib/katex/katex.min.4710034e669c7ff17f823f9ba12cf8a36582d65b007f79cbc4a3c11d7db2e4ca.css integrity="sha256-RxADTmacf/F/gj+boSz4o2WC1lsAf3nLxKPBHX2y5Mo="><link rel=stylesheet href=https://karlquinsland.com/lib/katex/copy-tex.min.bf9ff4137fec38f6255419e142d0883c9c52090885d746f80eee12b273d9b3e0.css integrity="sha256-v5/0E3/sOPYlVBnhQtCIPJxSCQiF10b4Du4SsnPZs+A="><script type=text/javascript src=https://karlquinsland.com/lib/smooth-scroll/smooth-scroll.min.bcff85fb5e00d68802850b393ac7792c997f722f536f38e26638c46dca8e5eb6.js integrity="sha256-vP+F+14A1ogChQs5Osd5LJl/ci9TbzjiZjjEbcqOXrY="></script><script type=text/javascript src=https://karlquinsland.com/lib/autocomplete/autocomplete.min.615590a2ca2b667afa7c02ef396f5500b62e22795ddbb46448f90494605d09a5.js integrity="sha256-YVWQosorZnr6fALvOW9VALYuInld27RkSPkElGBdCaU="></script><script type=text/javascript src=https://karlquinsland.com/lib/lunr/lunr.min.df84a2d58ea594c04a3371b48d020b55ea10284c2ec636e4e331965d7313e29b.js integrity="sha256-34Si1Y6llMBKM3G0jQILVeoQKEwuxjbk4zGWXXMT4ps="></script><script type=text/javascript src=https://karlquinsland.com/lib/lazysizes/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js integrity="sha256-+2SfyuYhd9/mPmcIHdzrgwtc4fBaQYTpu7fYesS49OU="></script><script type=text/javascript src=https://karlquinsland.com/lib/clipboard/clipboard.min.8a7739925f4c03586479852df840b7061948832a7fda30c8c812d2ea4dd4c4f2.js integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI="></script><script type=text/javascript src=https://karlquinsland.com/lib/katex/katex.min.17f5dd6b9f123dd7140abfb18521b3f4c036cd004f6f40121182a8865f140877.js integrity="sha256-F/Xda58SPdcUCr+xhSGz9MA2zQBPb0ASEYKohl8UCHc="></script><script type=text/javascript src=https://karlquinsland.com/lib/katex/auto-render.min.f74776a677f0d2be0af0264058f928e2ba455d0b19bc985304660d922a43a6b2.js integrity="sha256-90d2pnfw0r4K8CZAWPko4rpFXQsZvJhTBGYNkipDprI="></script><script type=text/javascript src=https://karlquinsland.com/lib/katex/copy-tex.min.2ab2237329021bc443986c8327f6e61357fb68a54e5d233d224023718c02207d.js integrity="sha256-KrIjcykCG8RDmGyDJ/bmE1f7aKVOXSM9IkAjcYwCIH0="></script><script type=text/javascript src=https://karlquinsland.com/lib/katex/mhchem.min.5cea356d6025c5a2f18c454c83ec5674dbb04fab1cd1d75569e77788c6b6f888.js integrity="sha256-XOo1bWAlxaLxjEVMg+xWdNuwT6sc0ddVaed3iMa2+Ig="></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=https://karlquinsland.com/js/theme.min.f51938f3065a40ee841bcb558e4330e31fd26c0ea55343fff8770b88b0319a3c.js integrity="sha256-9Rk48wZaQO6EG8tVjkMw4x/SbA6lU0P/+HcLiLAxmjw="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3WZ55XG701",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-3WZ55XG701" async></script></body></html>
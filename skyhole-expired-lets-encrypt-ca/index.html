<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Using new Lets Encrypt intermediate chain with SkyHole - karl</title><meta name=Description content="Another victim of the recently expired Lets Encrypt Root Certificate"><meta property="og:url" content="https://karlquinsland.com/skyhole-expired-lets-encrypt-ca/"><meta property="og:site_name" content="karl"><meta property="og:title" content="Using new Lets Encrypt intermediate chain with SkyHole"><meta property="og:description" content="Another victim of the recently expired Lets Encrypt Root Certificate"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-01T00:00:00+00:00"><meta property="article:tag" content="Troubleshooting"><meta property="article:tag" content="LetsEncrypt"><meta property="og:image" content="https://karlquinsland.com/images/avatar.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://karlquinsland.com/images/avatar.webp"><meta name=twitter:title content="Using new Lets Encrypt intermediate chain with SkyHole"><meta name=twitter:description content="Another victim of the recently expired Lets Encrypt Root Certificate"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://karlquinsland.com/skyhole-expired-lets-encrypt-ca/><link rel=prev href=https://karlquinsland.com/apc-ups-energy-in-homeassistant/><link rel=next href=https://karlquinsland.com/hardware-accelerated-graphics-on-the-raspberry-pi-4-a-snappier-kds/><link rel=stylesheet href=/css/style.min.658eb25b73ad29ab864a36ed014516c5047802d1ff98d0080132d1abe1332f5b.css integrity="sha256-ZY6yW3OtKauGSjbtAUUWxQR4AtH/mNAIATLRq+EzL1s="><link rel=preload href=/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0="></noscript><link rel=preload href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8="></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Using new Lets Encrypt intermediate chain with SkyHole","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/karlquinsland.com\/skyhole-expired-lets-encrypt-ca\/"},"genre":"posts","keywords":"troubleshooting, LetsEncrypt","wordcount":1478,"url":"https:\/\/karlquinsland.com\/skyhole-expired-lets-encrypt-ca\/","datePublished":"2021-10-01T00:00:00+00:00","dateModified":"2021-10-01T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"karl"},"description":"Another victim of the recently expired Lets Encrypt Root Certificate"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-blog"></i> Posts </a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i> R√©sum√© </a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i> Tags </a><a class=menu-item href=/contact/><i class="fas fa-address-book"></i> Contact </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title><i class="fas fa-blog"></i>Posts</a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i>R√©sum√©</a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i>Tags</a><a class=menu-item href=/contact/ title><i class="fas fa-address-book"></i>Contact</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Using new Lets Encrypt intermediate chain with SkyHole</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>karl</a></span>&nbsp;<span class=post-category>included in <a href=/categories/skyhole/><i class="far fa-folder fa-fw" aria-hidden=true></i>Skyhole</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-10-01>2021-10-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1478 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#symptoms>Symptoms</a></li><li><a href=#investigating>Investigating</a></li><li><a href=#alternate-intermediate>Alternate Intermediate</a></li></ul></nav></div></div><div class=content id=content><p>If you somehow missed it, one of the certificates used by Lets Encrypt chain of trust <a href=https://letsencrypt.org/docs/dst-root-ca-x3-expiration-september-2021/ target=_blank rel="noopener noreffer">expired</a> this week.
As expected, things broke&mldr;. including my private, filtered DNS over TLS server - <a href=https://github.com/kquinsland/skyhole/ target=_blank rel="noopener noreffer">SkyHole</a>. Below is a condensed form of my notes to create the exact document that I wish I had while trying to triage broken DNS on my phone.</p><p><strong>TL;DR:</strong> Implement solution 3 from <a href=https://www.openssl.org/blog/blog/2021/09/13/LetsEncryptRootCertExpire/ target=_blank rel="noopener noreffer">this</a> post.</p><hr><p><strong>Note:</strong> After releasing the initial version of SkyHole, I re-factored most of the code to eliminate the dependency on Docker. This was to make the project easier to deploy on resource constrained hardware.
At the time, I was working with <a href=https://saltproject.io/ target=_blank rel="noopener noreffer">SaltStack</a> a lot and took the opportunity to re-do the entire thing as a salt state for a bit of practice. The <em>exact</em> steps and commands shown below are unique to my particular instance. Use them as <em>guidance</em> for fixing an issue with the publicly released version of SkyHole.</p><h1 id=symptoms>Symptoms</h1><p>My current daily driver runs Android 11. When configured to use a <a href=https://android-developers.googleblog.com/2018/04/dns-over-tls-support-in-android-p.html target=_blank rel="noopener noreffer">private DNS server</a>, Android essentially behaves as if you&rsquo;ve turned WiFi/Cell data off if there is any issue when talking to the DoT server.
While this &lsquo;fail private&rsquo; approach is commendable, the lack of debug info in the UI is not; no details are given about the failure other than a generic &rsquo;the private dns server could not be reached&rsquo; message.</p><p>I have seen this behavior once before when the certificate renewal timer failed to fire off&mldr; except I implemented email based notifications after that incident and had recently received a notification from the renewal script.</p><p>Just to be sure, I checked the <code>notAfter</code> in each certificate and they all had plenty of life left:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>me@dot-host:/etc/coredns/tls# gawk <span class=s1>&#39;BEGIN { pipe=&#34;openssl x509 -noout -subject -dates&#34;} \
</span></span></span><span class=line><span class=cl><span class=s1>&gt;   /^-+BEGIN CERT/,/^-+END CERT/ { print | pipe }
</span></span></span><span class=line><span class=cl><span class=s1>&gt;   /^-+END CERT/                 { close(pipe); printf(&#34;\n&#34;)}  &#39;</span> chain.pem
</span></span><span class=line><span class=cl><span class=nv>subject</span><span class=o>=</span><span class=nv>CN</span> <span class=o>=</span> dot.my-test-domain.tld
</span></span><span class=line><span class=cl><span class=nv>notBefore</span><span class=o>=</span>Oct  <span class=m>1</span> 01:50:58 <span class=m>2021</span> GMT
</span></span><span class=line><span class=cl><span class=nv>notAfter</span><span class=o>=</span>Dec <span class=m>30</span> 01:50:57 <span class=m>2021</span> GMT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>subject</span><span class=o>=</span><span class=nv>C</span> <span class=o>=</span> US, <span class=nv>O</span> <span class=o>=</span> Let<span class=err>&#39;</span>s Encrypt, <span class=nv>CN</span> <span class=o>=</span> R3
</span></span><span class=line><span class=cl><span class=nv>notBefore</span><span class=o>=</span>Sep  <span class=m>4</span> 00:00:00 <span class=m>2020</span> GMT
</span></span><span class=line><span class=cl><span class=nv>notAfter</span><span class=o>=</span>Sep <span class=m>15</span> 16:00:00 <span class=m>2025</span> GMT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>subject</span><span class=o>=</span><span class=nv>C</span> <span class=o>=</span> US, <span class=nv>O</span> <span class=o>=</span> Internet Security Research Group, <span class=nv>CN</span> <span class=o>=</span> ISRG Root X1
</span></span><span class=line><span class=cl><span class=nv>notBefore</span><span class=o>=</span>Jan <span class=m>20</span> 19:14:03 <span class=m>2021</span> GMT
</span></span><span class=line><span class=cl><span class=nv>notAfter</span><span class=o>=</span>Sep <span class=m>30</span> 18:14:03 <span class=m>2024</span> GMT
</span></span></code></pre></td></tr></table></div></div><p>Borrowed that command from <a href=https://serverfault.com/questions/541262/checking-the-issued-and-expiry-dates-for-the-certificates-involved-a-certificate target=_blank rel="noopener noreffer">this</a> post.</p><p>Looking for more information, <code>adb</code> yielded something:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>‚ùØ adb logcat <span class=p>|</span> grep resolv
</span></span><span class=line><span class=cl>09-30 21:28:12.995   <span class=m>962</span> <span class=m>15448</span> W resolv  : Validating DnsTlsServer 12.34.56.78 with mark 0xf0084
</span></span><span class=line><span class=cl>09-30 21:28:13.085   <span class=m>962</span> <span class=m>15448</span> W resolv  : SSL_connect ssl <span class=nv>error</span> <span class=o>=</span>1, mark 0xf0084: No such file or directory
</span></span><span class=line><span class=cl>09-30 21:28:13.085   <span class=m>962</span> <span class=m>15448</span> W resolv  : TLS Handshake failed
</span></span><span class=line><span class=cl>09-30 21:28:13.085   <span class=m>962</span> <span class=m>15448</span> W resolv  : query failed
</span></span><span class=line><span class=cl>09-30 21:28:13.085   <span class=m>962</span> <span class=m>15448</span> W resolv  : validateDnsTlsServer returned <span class=m>0</span> <span class=k>for</span> 12.34.56.78
</span></span></code></pre></td></tr></table></div></div><p>The <code>No such file or directory</code> message came from <a href=https://android.googlesource.com/platform/packages/modules/DnsResolver/+/refs/heads/master/DnsTlsSocket.cpp target=_blank rel="noopener noreffer">here</a>.</p><p>Google uses their own fork of openSSL in Android so spent some time trying to figure out what an error code of <code>1</code> means in the openSSL project.
I <em>think</em> <code>1</code> is <a href=https://github.com/OneSignal/openssl/blob/main/include/openssl/ssl.h#L1168 target=_blank rel="noopener noreffer"><code>SSL_ERROR_SSL</code></a> but that seems to be a relatively <a href=https://www.openssl.org/docs/man1.1.1/man3/SSL_get_error.html target=_blank rel="noopener noreffer">&lsquo;generic&rsquo;</a> error.
Furthermore, in context of <code>No such file or directory</code> &mldr; it makes even less sense.</p><p>Oh well. So much for that theory. From this point on, I&rsquo;m treating all of the TLS connection stuff as a black box.</p><h1 id=investigating>Investigating</h1><p>I was able to confirm that the TLS certificates on the skyhole instance had not expired and the intermediate chain was not using any of the depreciated certificates.
I had also not made any changes to the skyhole instance in close to a year and <code>kdig</code> didn&rsquo;t throw any warnings when querying against the DoT server.
I could see the manual query from <code>kdig</code> in the DNS query/filter logs &mldr; so it seemed like the problem was not in either the TLS portion or the DNS portion.</p><p>That left Android as the culprit.</p><p>But I was also fairly sure that Google hadn&rsquo;t changed anything on the phone w/r/t how the DoT client worked&mldr;ü§î</p><p>If in doubt, turn to the wires!</p><p>I ran <code>tcpdump</code> on the skyhole instance and did notice traffic from Android that was <em>not</em> showing up in the DNS server logs.
I compared the traffic with a working manual query from <code>kdig</code> and noticed that the traffic from the Android client stopped shortly before where the <code>kdig</code> traffic would have turned into a regular DNS query.</p><p>So the problem was happening during the TLS setup. Whatever Android was choking on was happening before any DNS queries were sent.</p><p>I quickly configured the phone to use a known good / working DNS over TLS server and it was immediately accepted. The triumphant <code>logcat</code> output confirmed that everything on the TLS layer has happy: <code>W resolv : Validation success</code>.</p><p>Android worked instantly when configured to use a different server but immediately failed when used with the skyhole instance. This points to a problem on the server.</p><p>Nothing about the skyhole instance had changed and the certificates that it was offering up were totally valid; other clients worked w/o issue. This points to a problem on the phone.</p><p>Even though the certificates appear fine, the timing with the recent Lets Encrypt certificate expiration is too suspicious ü§®.</p><p>Looking for another data point, I moved to a different computer with a different version of openSSL installed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>‚ùØ openssl version
</span></span><span class=line><span class=cl>LibreSSL 2.8.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>‚ùØ openssl s_client -connect dot.my-test-domain.tld:853 -servername dot.my-test-domain.tld <span class=p>|</span>
</span></span><span class=line><span class=cl>    openssl crl2pkcs7 -nocrl -certfile /dev/stdin <span class=p>|</span>
</span></span><span class=line><span class=cl>    openssl pkcs7 -print_certs -noout -text <span class=p>|</span>
</span></span><span class=line><span class=cl>    egrep <span class=s1>&#39;not(Before|After)&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>depth</span><span class=o>=</span><span class=m>1</span> <span class=nv>O</span> <span class=o>=</span> Digital Signature Trust Co., <span class=nv>CN</span> <span class=o>=</span> DST Root CA X3
</span></span><span class=line><span class=cl>verify error:num<span class=o>=</span>10:certificate has expired
</span></span><span class=line><span class=cl><span class=nv>notAfter</span><span class=o>=</span>Sep <span class=m>30</span> 14:01:15 <span class=m>2021</span> GMT
</span></span><span class=line><span class=cl>verify <span class=k>return</span>:0
</span></span><span class=line><span class=cl><span class=nv>depth</span><span class=o>=</span><span class=m>1</span> <span class=nv>O</span> <span class=o>=</span> Digital Signature Trust Co., <span class=nv>CN</span> <span class=o>=</span> DST Root CA X3
</span></span><span class=line><span class=cl>verify error:num<span class=o>=</span>10:certificate has expired
</span></span><span class=line><span class=cl><span class=nv>notAfter</span><span class=o>=</span>Sep <span class=m>30</span> 14:01:15 <span class=m>2021</span> GMT
</span></span><span class=line><span class=cl>verify <span class=k>return</span>:0
</span></span><span class=line><span class=cl><span class=nv>depth</span><span class=o>=</span><span class=m>3</span> <span class=nv>O</span> <span class=o>=</span> Digital Signature Trust Co., <span class=nv>CN</span> <span class=o>=</span> DST Root CA X3
</span></span><span class=line><span class=cl>verify error:num<span class=o>=</span>10:certificate has expired
</span></span><span class=line><span class=cl><span class=nv>notAfter</span><span class=o>=</span>Sep <span class=m>30</span> 14:01:15 <span class=m>2021</span> GMT
</span></span><span class=line><span class=cl>verify <span class=k>return</span>:0
</span></span></code></pre></td></tr></table></div></div><p>Huh. That sure looks like a problem!</p><p>After a <a href=https://www.mail-archive.com/openssl-users@openssl.org/msg90068.html target=_blank rel="noopener noreffer">bit</a> of google, I found that the different versions of openSSL (and their forks&mldr;) behave differently when validating certificate chains:</p><blockquote><p>The currently recommended certificate chain as presented to Let‚Äôs Encrypt ACME clients when new certificates are issued contains an intermediate certificate (ISRG Root X1) that is signed by an old DST Root CA X3 certificate that expires on 2021-09-30. In some cases the OpenSSL 1.0.2 version will regard the certificates issued by the Let‚Äôs Encrypt CA as having an expired trust chain.</p><p>Most up-to-date CA cert trusted bundles, as provided by operating systems, contain this soon-to-be-expired certificate. The current CA cert bundles also contain an ISRG Root X1 self-signed certificate. This means that clients verifying certificate chains can find the alternative non-expired path to the ISRG Root X1 self-signed certificate in their trust store.</p><p>Unfortunately this does not apply to OpenSSL 1.0.2 which always prefers the untrusted chain and if that chain contains a path that leads to an expired trusted root certificate (DST Root CA X3), it will be selected for the certificate verification and the expiration will be reported.</p></blockquote><p><a href=https://www.openssl.org/blog/blog/2021/09/13/LetsEncryptRootCertExpire/ target=_blank rel="noopener noreffer">Source</a>.</p><p>That would certainly explain the behavior I observed when checking the skyhole certificates on the second computer.
I don&rsquo;t know <em>exactly</em> what version of OpenSSL the BoringSSL in my phone is based off of, but, assuming that it&rsquo;s got the same bug as OpenSSL 1.0.2, that would explain everything.</p><p>The openSSL blog post pointed out three possible fixes; two of which are applied client side.
My phone is not rooted so I just assumed that I would have access to the portions of the file system needed for a &lsquo;client side&rsquo; fix. That left the third solution; use a different intermediate chain.</p><p>I was not aware that there was an alternate intermediate chain for Lets Encrypt. I didn&rsquo;t even know that was a thing let alone <em>why</em> somebody would do that.</p><h1 id=alternate-intermediate>Alternate Intermediate</h1><p>Turns out, it&rsquo;s a very clever trick meant to <a href=https://letsencrypt.org/2020/12/21/extending-android-compatibility.html target=_blank rel="noopener noreffer">prevent Lets Encrypt certificates from breaking on <em>older</em> versions</a>. Ironic that a &rsquo;newer&rsquo; android device got screwed in the process üò¨.</p><p>The two valid chains of trust for Lets Encrypt certificates look like this:</p><figure><img src=/skyhole-expired-lets-encrypt-ca/2020.12.21-android-compat-cert-chain.webp alt="Picture from LetsEncrypt blog post showing logical relationship between end-user certificates, the intermediate certificate chains and root certificates"><figcaption><p>Image credit/source:
<a href=https://letsencrypt.org/2020/12/21/extending-android-compatibility.html>LetsEncrypt</a></p></figcaption></figure><p>With the help of <a href=https://github.com/certbot/certbot/issues/8577 target=_blank rel="noopener noreffer">this</a> GitHub issue, the revised CertBot <code>cli.ini</code> file becomes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>me@dot-host:~# cat /etc/letsencrypt/cli.ini <span class=p>|</span> grep chain
</span></span><span class=line><span class=cl>preferred-chain<span class=o>=</span><span class=s1>&#39;ISRG Root X1&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>After running certbot with the new config, <code>logcat</code> shows success:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>‚ùØ adb logcat <span class=p>|</span> grep resolv
</span></span><span class=line><span class=cl>10-01 09:41:01.190   <span class=m>962</span>  <span class=m>7711</span> W resolv  : Validating DnsTlsServer 12.34.56.78 with mark 0xf0084
</span></span><span class=line><span class=cl>10-01 09:41:01.734   <span class=m>962</span>  <span class=m>7711</span> W resolv  : validateDnsTlsServer returned <span class=m>1</span> <span class=k>for</span> 12.34.56.78
</span></span><span class=line><span class=cl>10-01 09:41:01.734   <span class=m>962</span>  <span class=m>7711</span> W resolv  : Validation success
</span></span></code></pre></td></tr></table></div></div><p>Android no longer shows an unhelpful &ldquo;can&rsquo;t connect&rdquo; message and I can see DNS queries being filtered!</p><p>üéä</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-10-01</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/skyhole-expired-lets-encrypt-ca/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/troubleshooting/>Troubleshooting</a>,&nbsp;<a href=/tags/letsencrypt/>LetsEncrypt</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/apc-ups-energy-in-homeassistant/ class=prev rel=prev title="Adding an APC UPS to Home Assistant energy dashboard"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Adding an APC UPS to Home Assistant energy dashboard</a>
<a href=/hardware-accelerated-graphics-on-the-raspberry-pi-4-a-snappier-kds/ class=next rel=next title="Hardware accelerated graphics on the raspberry pi4 for a speedier KDS">Hardware accelerated graphics on the raspberry pi4 for a speedier KDS<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>¬Ø\_(„ÉÑ)_/¬Ø</div><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.152.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>karl</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.76e39bd605d45b2d1944123c66608b0c8bb9baeb70720b212571531c7cf9bc2a.css integrity="sha256-duOb1gXUWy0ZRBI8ZmCLDIu5uutwcgshJXFTHHz5vCo="><script type=text/javascript src=/lib/autocomplete/autocomplete.min.ae2da1bd62c6469ee27770ad1cddf2e8296d8a7f6d85b091463e5200c5e320af.js integrity="sha256-ri2hvWLGRp7id3CtHN3y6Cltin9thbCRRj5SAMXjIK8="></script><script type=text/javascript src=/lib/lunr/lunr.min.08a93c0120364b01159db3c287f39b2180bb740334472bda0675bd3f18981676.js integrity="sha256-CKk8ASA2SwEVnbPCh/ObIYC7dAM0RyvaBnW9PxiYFnY="></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.3d9120fa621da6d613c1698b7014ec6bdf4620366e8f2b7b547059f4b6f6272b.js integrity="sha256-PZEg+mIdptYTwWmLcBTsa99GIDZujyt7VHBZ9Lb2Jys="></script><script type=text/javascript src=/lib/clipboard/clipboard.min.e17a1d816e13c0826e0ed7febfabc3277f45571234bde0bf9120829a7169edc9.js integrity="sha256-4XodgW4TwIJuDtf+v6vDJ39FVxI0veC/kSCCmnFp7ck="></script><script type=text/javascript src=/lib/katex/katex.min.eb18207487161674e717087c317db14ac1a62dadaecccb802499ce173bfeb739.js integrity="sha256-6xggdIcWFnTnFwh8MX2xSsGmLa2uzMuAJJnOFzv+tzk="></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.cb7f4ca60ed5dc3e258415f8c7a3b46d4a93578a52adf83011f18a7f190e7602.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.52ce78fab4860d24ef22128a52ce24ca01368a9034457a565a1d3fccbab0ddbb.js integrity="sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.5c0a121a8b490afc85860a522347aeb34fb508c6b23044e5d29f6b2194227b51.js integrity="sha256-XAoSGotJCvyFhgpSI0eus0+1CMayMETl0p9rIZQie1E="></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.612a51a43205bbcf3b4af348dc2e8aa60f77f4fe5535ebc57f13054b61607d6c.js integrity="sha256-YSpRpDIFu887SvNI3C6Kpg939P5VNevFfxMFS2FgfWw="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3WZ55XG701",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-3WZ55XG701" async></script></body></html>
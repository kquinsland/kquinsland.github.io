<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Teardown and Home Assistant integration with two generic Chinese 'smart' power strips. - karl</title><meta name=Description content="Taking a look inside the `BN-LINK U158WT` and `POWSAV AHR-083` and flashing both with a custom firmware."><meta property="og:url" content="https://karlquinsland.com/esphome-power-strips/"><meta property="og:site_name" content="karl"><meta property="og:title" content="Teardown and Home Assistant integration with two generic Chinese 'smart' power strips."><meta property="og:description" content="Taking a look inside the `BN-LINK U158WT` and `POWSAV AHR-083` and flashing both with a custom firmware."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-15T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-15T00:00:00+00:00"><meta property="article:tag" content="Teardown"><meta property="article:tag" content="Esphome"><meta property="article:tag" content="Tasmota"><meta property="article:tag" content="OpenBeken"><meta property="article:tag" content="Sonoff-S31"><meta property="og:image" content="https://karlquinsland.com/esphome-power-strips/images/ps_10_wifi_replaced.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://karlquinsland.com/esphome-power-strips/images/ps_10_wifi_replaced.webp"><meta name=twitter:title content="Teardown and Home Assistant integration with two generic Chinese 'smart' power strips."><meta name=twitter:description content="Taking a look inside the `BN-LINK U158WT` and `POWSAV AHR-083` and flashing both with a custom firmware."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://karlquinsland.com/esphome-power-strips/><link rel=prev href=https://karlquinsland.com/esphome-geiger-counter/><link rel=next href=https://karlquinsland.com/improved-esphome-coffee-automation/><link rel=stylesheet href=/css/style.min.658eb25b73ad29ab864a36ed014516c5047802d1ff98d0080132d1abe1332f5b.css integrity="sha256-ZY6yW3OtKauGSjbtAUUWxQR4AtH/mNAIATLRq+EzL1s="><link rel=preload href=/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.0df5a33710e433de1f5415b1d47e4130ca7466aee5b81955f1045c4844bbb3ed.css integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0="></noscript><link rel=preload href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8=" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.5fbaeb9f8e25d7e0143bae61d4b1802c16ce7390b96ceb2d498b0d96ff4c853f.css integrity="sha256-X7rrn44l1+AUO65h1LGALBbOc5C5bOstSYsNlv9MhT8="></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Teardown and Home Assistant integration with two generic Chinese 'smart' power strips.","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/karlquinsland.com\/esphome-power-strips\/"},"genre":"posts","keywords":"teardown, esphome, tasmota, OpenBeken, sonoff-S31","wordcount":1714,"url":"https:\/\/karlquinsland.com\/esphome-power-strips\/","datePublished":"2023-01-15T00:00:00+00:00","dateModified":"2023-01-15T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"karl"},"description":"Taking a look inside the `BN-LINK U158WT` and `POWSAV AHR-083` and flashing both with a custom firmware."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-blog"></i> Posts </a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i> R√©sum√© </a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i> Tags </a><a class=menu-item href=/contact/><i class="fas fa-address-book"></i> Contact </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=karl>Karl</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title><i class="fas fa-blog"></i>Posts</a><a class=menu-item href=/resume/ title="Hire Me!"><i class="fas fa-briefcase"></i>R√©sum√©</a><a class=menu-item href=/tags/ title="Can you tell that I don't have a super consistent or clear taxonomy?"><i class="fas fa-tags"></i>Tags</a><a class=menu-item href=/contact/ title><i class="fas fa-address-book"></i>Contact</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Teardown and Home Assistant integration with two generic Chinese 'smart' power strips.</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>karl</a></span>&nbsp;<span class=post-category>included in <a href=/categories/teardown/><i class="far fa-folder fa-fw" aria-hidden=true></i>Teardown</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-01-15>2023-01-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1714 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#bn-link>BN-Link</a><ul><li><a href=#flashing-openbk>Flashing OpenBK</a><ul><li><a href=#wt-01n-swap>WT-01N swap</a></li></ul></li><li><a href=#bn-gpio-notes>BN GPIO notes</a></li></ul></li><li><a href=#powsav>POWSAV</a><ul><li><a href=#powsav-gpio-notes>POWSAV GPIO notes</a></li><li><a href=#esphome>Esphome</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>I love the Sonoff-S31 smart plugs.
They&rsquo;re cheap, well made and - most importantly - trivial to flash with ESPHome and integrate into Home Assistant.
They do have one obvious draw back, though; optimized for a &ldquo;traditional&rdquo; US style outlet.
When you try to deploy them to a power strip, you end up loosing about 50% of the outlets on the strip!</p><figure><img src=/esphome-power-strips/images/poor_power-strip_util.webp alt="This is how you loose about 50% of the outlets on your power strip."><figcaption><p>This is how you loose about 50% of the outlets on your power strip.</p></figcaption></figure><p>I figured that there must be a power strip out there that had the WiFi radio, power supply and relays built in.</p><p>Looking through the <a href=https://templates.blakadder.com/us.html#Power%20Strip target=_blank rel="noopener noreffer"><code>Power Strip</code></a> listing of the excellent Tasmota device/template repository, there are more than a few options out there.
Upon closer inspection, almost <em>all</em> of them are from super generic/no-name Chinese brands and lack any ETL or UL certifications üò¨.</p><p>Searching for smart power strips on Amazon returns several results&mldr; and only a few from name brands.
The few name brand power strips out there that I could find are using their own microcontrollers internally and are immediately disqualified as they&rsquo;ll be - at best - difficult ot integrate with Home Assistant.</p><p>I&rsquo;m not quite so concerned about any power conditioning/surge suppression as I am not plugging in any valuable or delectate electronics.
I am concerned with a more integrated / space efficient solution that allows me to retain my ESPHome/Home Assistant integration.</p><p>After cross referencing the Tasmota templates listing with the Amazon search listings, it became clear that there&rsquo;s really only a few designs that get sold under several different brands and that virtually all of the devices that were known to be powered by an ESP micro are no longer for sale on Amazon.</p><p>I eventually took a gamble on two:</p><ul><li><a href=https://www.amazon.com/gp/product/B097NHBPN9 target=_blank rel="noopener noreffer"><code>BN-LINK U158WT</code></a></li><li><a href=https://www.amazon.com/gp/product/B0B5G6MDQ6 target=_blank rel="noopener noreffer"><code>POWSAV AHR-083</code></a></li></ul><h2 id=bn-link>BN-Link</h2><figure><img src=/esphome-power-strips/images/bn_marketing_photo.webp alt="Marketing photo for the BN-Link power strip"><figcaption><p>Marketing photo for the BN-Link power strip</p></figcaption></figure><p>This opens up with a standard philips screw driver and you only need one bit size for all screws - nice touch!</p><figure><img src=/esphome-power-strips/images/bn_01_hidden_screws.webp><figcaption></figcaption></figure><p>The screws are hiding under the anti-slip pads but instead of those being glued down, the pads use a friction fit on the <code>+</code> shaped locating pegs.
I really like this design feature as the glued pads never stick quite as well when replaced.
In addition to the 4 screws, there are several plastic clip/tabs around the permitter that take some work to carefully undo.
If you have a thin metal pry tool / spudger, it will come in handy!</p><p>Overall, the physical construction is solid enough and - pleasantly - serviceable.</p><p><figure><img src=/esphome-power-strips/images/bn_02_overview.webp><figcaption></figcaption></figure><figure><img src=/esphome-power-strips/images/bn_03_usb_under_closeup.webp alt="I'm not loving the sloppy wiring connecting the USB power supply to the mains rails."><figcaption><p>I'm not loving the sloppy wiring connecting the USB power supply to the mains rails.</p></figcaption></figure></p><p>Like the USB power supply, the WiFi module is also separate from the main PCB.</p><p><figure><img src=/esphome-power-strips/images/bn_04_wifi_under_closeup.webp alt="You know what's cheaper than pin headers? PCB fingers in slots."><figcaption><p>You know what's cheaper than pin headers? PCB fingers in slots.</p></figcaption></figure><figure><img src=/esphome-power-strips/images/bn_05_wifi_chip_closeup.webp><figcaption></figcaption></figure></p><p>Bad news: this module is NOT an ESP powered device.</p><p>Good news: there a Tasmota-like firmware for it: <a href=https://github.com/openshwprojects/OpenBK7231T_App target=_blank rel="noopener noreffer">OpenBK7231T</a>!</p><p>I&rsquo;ll go ahead and flash the OpenBK firmware and have a go to at least give it a try.</p><p>The relay switching electronics look reasonable enough:</p><figure><img src=/esphome-power-strips/images/bn_06_support_circuit_closeup.webp><figcaption></figcaption></figure><p>The relays themselves are nothing special to write home about:</p><figure><img src=/esphome-power-strips/images/bn_07_relay_outlet_closeup.webp alt="Note the links. I'd bet that it's simpler to scale a design by copy/pasting a self-contained footprint and adjust the number of links on the BOM as needed."><figcaption><p>Note the links. I'd bet that it's simpler to scale a design by copy/pasting a self-contained footprint and adjust the number of links on the BOM as needed.</p></figcaption></figure><p>There&rsquo;s nothing remarkable about the USB Power supply; standard switch mode power supply topology.
The power conversion is done by the chip under the metal heat sink; I didn&rsquo;t bother to get an ID on it as the ports don&rsquo;t support any quick charge or power delivery protocols.</p><figure><img src=/esphome-power-strips/images/bn_08_usb_top_closeup.webp><figcaption></figcaption></figure><p>Before putting the strip back together, I secured the USB power supply wires with a bit of electrical tape to lessen the probability of a short due to insulation wearing off.</p><figure><img src=/esphome-power-strips/images/bn_09_usb_feed_bodge_fix.webp><figcaption></figcaption></figure><h3 id=flashing-openbk>Flashing OpenBK</h3><p>I don&rsquo;t have a ton of notes about the flashing process as it was pretty straight forward.
Two small things to note:</p><ul><li>The <a href=https://github.com/OpenBekenIOT/hid_download_py target=_blank rel="noopener noreffer"><code>hid_download_py/uartprogram</code></a> tool needs a <a href=https://github.com/OpenBekenIOT/hid_download_py/pull/13/files target=_blank rel="noopener noreffer">requirements.txt</a>.</li><li>You can get away with only 4 wires (power, gnd, rx, tx) to program the chip but you must move very fast! It took me more than a few attempts to get the tool to connect to the bootloader on the chip; you have a very limited window for the tool to connect to the chip. I had to run connect power to the chip within about 200ms of starting the <code>uartprogram</code>. If i waited much longer, I would get <code>Cannot get bus.</code></li></ul><p>Eventually I was able to program the chip:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>‚ùØ python3 uartprogram ../OpenBK7231T_UA_1.15.308.bin -d /dev/ttyUSB0 -w
</span></span><span class=line><span class=cl>UartDownloader....
</span></span><span class=line><span class=cl>programm....
</span></span><span class=line><span class=cl>Cannot get bus. : <span class=p>|</span>                                                  <span class=p>|</span><span class=o>[</span>    ?k/s<span class=o>]</span>
</span></span><span class=line><span class=cl>‚ùØ python3 uartprogram ../OpenBK7231T_UA_1.15.308.bin -d /dev/ttyUSB0 -w
</span></span><span class=line><span class=cl>UartDownloader....
</span></span><span class=line><span class=cl>programm....
</span></span><span class=line><span class=cl>Gotten Bus...   : <span class=p>|</span>                                                  <span class=p>|</span><span class=o>[</span>    ?k/s<span class=o>]</span>caution: ignoring unexpected reply in SetBaudRate
</span></span><span class=line><span class=cl>Write Successful: <span class=p>|</span><span class=c1>##################################################|[ 13.2k/s]</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>caution: ignoring unexpected reply</code> came as soon as I connected the power to the programmer.</p><p>After figuring out the <a href=#bn-gpio-notes rel>GPIO assignments</a>, I did manage to get the Home Assistant / MQTT auto discovery working but - like with Tasmota - wasn&rsquo;t impressed with the lack of customization in the mqtt payloads.
I <strong>highly value</strong> having the correct device/entity class, icon, name &mldr; etc all populating in home assistant automatically; ESPHome lets me do this.</p><p>I&rsquo;ll keep an eye on the project and may find another use for this power strip in the future.
If ESPHome ever adds support for the <code>BK7231T</code> chips then this is <em>perfect</em>.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>While drafting this post, I <a href=https://old.reddit.com/r/esp8266/comments/qfg3yc/replaced_tuya_plug_controller_with_esp8266/ target=_blank rel="noopener noreffer">came across</a> an ESP based drop in replacement for the <code>WB2S</code> module: the <a href=https://www.lcsc.com/product-detail/WiFi-Modules_Wireless-tag-WT-01N_C477823.html target=_blank rel="noopener noreffer"><code>WT-01N</code></a>.
Had I known, I would have just done the module swap, flashed ESPHome and stopped there.</p><p>While looking for the <code>WT-01N</code>, on Ali Express, I found that there&rsquo;s already a small supply of <a href="https://www.aliexpress.com/w/wholesale--ESP%2525252d02S.html?catId=0&amp;initiative_id=SB_20230114112241&amp;SearchText=%2BESP-02S&amp;spm=a2g0o.home.1000002.0&amp;dida=y" target=_blank rel="noopener noreffer"><code>ESP-02S</code> modules that should be drop in replacements</a>!</p><p>Next time!</p></div></div></div><h4 id=wt-01n-swap>WT-01N swap</h4><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>On a rainy afternoon in late 2023.03, I got around to doing the module swap.
Below you&rsquo;ll find the appropriate Tasmota configuration for GPIO pins.</div></div></div><figure><img src=/esphome-power-strips/images/tasmota.webp alt="And here's the Tasmota configuration for the BN-Link."><figcaption><p>And here's the Tasmota configuration for the BN-Link.</p></figcaption></figure><h3 id=bn-gpio-notes>BN GPIO notes</h3><p>The project needs some basic &ldquo;here&rsquo;s how to figure out which GPIOs do what&rdquo; docs similar to <a href=https://Tasmota.github.io/docs/Configuration-Procedure-for-New-Devices/#step-1 target=_blank rel="noopener noreffer">these</a> but I eventually figured out the following GPIO assignments.</p><table><thead><tr><th>PIN</th><th>Label</th><th>Purpose</th><th>Notes</th></tr></thead><tbody><tr><td>6</td><td>PWM0</td><td><code>Rel</code> 1</td><td>Outlet closest to the power cord.</td></tr><tr><td>7</td><td>PWM1</td><td>NC</td><td>This is not connected to the main PCB.</td></tr><tr><td>8</td><td>PWM2</td><td><code>Rel</code> 4</td><td>Outlet closest to the USB.</td></tr><tr><td>10</td><td>RXD1</td><td><code>Btn</code></td><td>This is the user button.</td></tr><tr><td>11</td><td>TXD1</td><td><code>WiFiLED_n</code></td><td>WiFi status LED.</td></tr><tr><td>23</td><td>ADC3</td><td>NC</td><td>This is not connected to the main PCB.</td></tr><tr><td>24</td><td>PWM4</td><td><code>Rel</code> 2</td><td>Second outlet from power cord.</td></tr><tr><td>26</td><td>PWM5</td><td><code>Rel</code> 3</td><td>Third outlet from power cord.</td></tr></tbody></table><h2 id=powsav>POWSAV</h2><p>Happy that I was able to get open firmware on the first but disappointed with the lack of customization, I moved onto the second candidate.</p><figure><img src=/esphome-power-strips/images/pow_marketing_photo.webp alt="Marketing photo for the POWSAV power strip"><figcaption><p>Marketing photo for the POWSAV power strip</p></figcaption></figure><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>At one point in time, this <em>exact same device</em> was sold under the <code>ahrise</code> branding and was <a href=https://templates.blakadder.com/ahrise_AHR-083.html target=_blank rel="noopener noreffer">Tasmota compatible</a>.</p><p>The model number is the same, the templates repo picture is identical, the GPIO pinout is identical&mldr; but the linked Amazon listing is no longer available.
The PCB silk screen also include the old <code>AHR</code> markings so I&rsquo;m guessing that this was just a re-brand with the new <code>POWSAV</code> branding after switching to TuYa?</p></div></div></div><p>To open this one, you&rsquo;ll need a 2.2mm triangle bit.
There are 6 screws. four hidden under the anti-slip pads.</p><figure><img src=/esphome-power-strips/images/ps_01_rear_exterior_overview.webp alt="Why are the screw mounting slots not centered :/."><figcaption><p>Why are the screw mounting slots not centered :/.</p></figcaption></figure><p>The USB, WiFI and mains switching are all on a single PCB but the main power cut off and protection features are all on a separate PCB.</p><figure><img src=/esphome-power-strips/images/ps_02_rear_overview.webp alt="Nothing of concern to see on the bottom, everything looks pretty boring... which is good when it comes to mains handling!"><figcaption><p>Nothing of concern to see on the bottom, everything looks pretty boring... which is good when it comes to mains handling!</p></figcaption></figure><figure><img src=/esphome-power-strips/images/ps_04_top_overview.webp alt="About what you'd expect for a PCB layout. Plenty of distance between the HV and LV sides!"><figcaption><p>About what you'd expect for a PCB layout. Plenty of distance between the HV and LV sides!</p></figcaption></figure><p>It&rsquo;s nice to see that the surge suppression circuitry is on it&rsquo;s own PCB. Repairs there should be easier to pull off - in theory.</p><p>Here&rsquo;s a few more shots of the primary components/assemblies:</p><p><figure><img src=/esphome-power-strips/images/ps_06_protection_closeup_2.webp alt="Note the silk screen: this protection PCB is common to the AHR-053 model as well."><figcaption><p>Note the silk screen: this protection PCB is common to the AHR-053 model as well.</p></figcaption></figure><figure><img src=/esphome-power-strips/images/ps_07_wifi_closeup.webp alt="WB3S is a TuYa branded module that is pin compatible with the ubiquitous ESP-8266 modules."><figcaption><p>WB3S is a TuYa branded module that is pin compatible with the ubiquitous ESP-8266 modules.</p></figcaption></figure><figure><img src=/esphome-power-strips/images/ps_08_usb_closeup.webp alt="Note the black insulating material separating the USB ports from the mains side of things."><figcaption><p>Note the black insulating material separating the USB ports from the mains side of things.</p></figcaption></figure><figure><img src=/esphome-power-strips/images/ps_09_wifi_removed.webp alt="Relatively painless extraction, only partially lifted the pad in the bottom left."><figcaption><p>Relatively painless extraction, only partially lifted the pad in the bottom left.</p></figcaption></figure><figure><img src=/esphome-power-strips/images/ps_10_wifi_replaced.webp alt="Not even 5 min later, the TuYa modules has been replaced with one running a firmware powered by ESPHome."><figcaption><p>Not even 5 min later, the TuYa modules has been replaced with one running a firmware powered by ESPHome.</p></figcaption></figure></p><h3 id=powsav-gpio-notes>POWSAV GPIO notes</h3><p>Thanks to <a href=https://Tasmota.github.io/docs/Configuration-Procedure-for-New-Devices/#step-1 target=_blank rel="noopener noreffer">excellent</a> Tasmota docs, it was pretty easy to figure out the mappings.</p><p>For reference:</p><table><thead><tr><th>PIN</th><th>Type</th><th>Number</th></tr></thead><tbody><tr><td>GPIO2</td><td><code>Led_i</code></td><td>1</td></tr><tr><td>GPIO5</td><td><code>Button_n</code></td><td>1</td></tr><tr><td>GPIO 12</td><td><code>Relay</code></td><td>3</td></tr><tr><td>GPIO 13</td><td><code>Relay</code></td><td>4</td></tr><tr><td>GPIO 14</td><td><code>Relay</code></td><td>2</td></tr><tr><td>GPIO 15</td><td><code>Relay</code></td><td>1</td></tr></tbody></table><p>And the corresponding template:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;NAME&#34;</span><span class=p>:</span><span class=s2>&#34;POWSAV_AHR-083&#34;</span><span class=p>,</span><span class=nt>&#34;GPIO&#34;</span><span class=p>:[</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>320</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>64</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>226</span><span class=p>,</span><span class=mi>227</span><span class=p>,</span><span class=mi>225</span><span class=p>,</span><span class=mi>224</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>],</span><span class=nt>&#34;FLAG&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=nt>&#34;BASE&#34;</span><span class=p>:</span><span class=mi>18</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=esphome>Esphome</h3><p>And here&rsquo;s a super basic ESPHome configuration using the mappings from above.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>substitutions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>friendly_name_short</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Power Strip&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esphome</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;power-strip&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>esp8266</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>board</span><span class=p>:</span><span class=w> </span><span class=l>esp01_1m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Disable writing the switch mode / restore_from_flash</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restore_from_flash</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status_led</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=l>GPIO02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>inverted</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>binary_sensor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># I don&#39;t know what the stock behavior was. For now, only basic control</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${friendly_name_short} Button&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=l>GPIO05</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>INPUT_PULLUP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>inverted</span><span class=p>:</span><span class=w> </span><span class=kc>False</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Press is momentary quick</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>on_press</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>then</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>switch.toggle</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_relay1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Not doing anything fancy so we can go with basic GPIO switches</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># See: https://esphome.io/components/switch/gpio.html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>switch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Outlet 1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_relay1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:numeric-1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Don&#39;t want to wear down flash storing state, easiest to just not bother remembering</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>ALWAYS_OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># See: https://developers.home-assistant.io/docs/core/entity/switch/#available-device-classes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class=l>OUTLET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Outlet 2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_relay2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:numeric-2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>ALWAYS_OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class=l>OUTLET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Outlet 3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_relay3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:numeric-3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>ALWAYS_OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class=l>OUTLET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Outlet 4&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>sw_relay4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=l>gpio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pin</span><span class=p>:</span><span class=w> </span><span class=l>GPIO13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mdi:numeric-4&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restore_mode</span><span class=p>:</span><span class=w> </span><span class=l>ALWAYS_OFF</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_class</span><span class=p>:</span><span class=w> </span><span class=l>OUTLET</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-01-15</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/esphome-power-strips/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/teardown/>Teardown</a>,&nbsp;<a href=/tags/esphome/>Esphome</a>,&nbsp;<a href=/tags/tasmota/>Tasmota</a>,&nbsp;<a href=/tags/openbeken/>OpenBeken</a>,&nbsp;<a href=/tags/sonoff-s31/>Sonoff-S31</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/esphome-geiger-counter/ class=prev rel=prev title="Integrating ESPHome with a cheap Geiger Counter"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Integrating ESPHome with a cheap Geiger Counter</a>
<a href=/improved-esphome-coffee-automation/ class=next rel=next title="Integrating a dumb coffee maker with Home Assistant via ESPHome">Integrating a dumb coffee maker with Home Assistant via ESPHome<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>¬Ø\_(„ÉÑ)_/¬Ø</div><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.152.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>karl</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.76e39bd605d45b2d1944123c66608b0c8bb9baeb70720b212571531c7cf9bc2a.css integrity="sha256-duOb1gXUWy0ZRBI8ZmCLDIu5uutwcgshJXFTHHz5vCo="><script type=text/javascript src=/lib/autocomplete/autocomplete.min.ae2da1bd62c6469ee27770ad1cddf2e8296d8a7f6d85b091463e5200c5e320af.js integrity="sha256-ri2hvWLGRp7id3CtHN3y6Cltin9thbCRRj5SAMXjIK8="></script><script type=text/javascript src=/lib/lunr/lunr.min.08a93c0120364b01159db3c287f39b2180bb740334472bda0675bd3f18981676.js integrity="sha256-CKk8ASA2SwEVnbPCh/ObIYC7dAM0RyvaBnW9PxiYFnY="></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.3d9120fa621da6d613c1698b7014ec6bdf4620366e8f2b7b547059f4b6f6272b.js integrity="sha256-PZEg+mIdptYTwWmLcBTsa99GIDZujyt7VHBZ9Lb2Jys="></script><script type=text/javascript src=/lib/clipboard/clipboard.min.e17a1d816e13c0826e0ed7febfabc3277f45571234bde0bf9120829a7169edc9.js integrity="sha256-4XodgW4TwIJuDtf+v6vDJ39FVxI0veC/kSCCmnFp7ck="></script><script type=text/javascript src=/lib/katex/katex.min.eb18207487161674e717087c317db14ac1a62dadaecccb802499ce173bfeb739.js integrity="sha256-6xggdIcWFnTnFwh8MX2xSsGmLa2uzMuAJJnOFzv+tzk="></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.cb7f4ca60ed5dc3e258415f8c7a3b46d4a93578a52adf83011f18a7f190e7602.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.52ce78fab4860d24ef22128a52ce24ca01368a9034457a565a1d3fccbab0ddbb.js integrity="sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.5c0a121a8b490afc85860a522347aeb34fb508c6b23044e5d29f6b2194227b51.js integrity="sha256-XAoSGotJCvyFhgpSI0eus0+1CMayMETl0p9rIZQie1E="></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.612a51a43205bbcf3b4af348dc2e8aa60f77f4fe5535ebc57f13054b61607d6c.js integrity="sha256-YSpRpDIFu887SvNI3C6Kpg939P5VNevFfxMFS2FgfWw="></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3WZ55XG701",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-3WZ55XG701" async></script></body></html>